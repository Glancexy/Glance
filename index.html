<!DOCTYPE html>
<html lang="pt-br" class="light">
<head>
    <!-- Cropper.js para recorte de imagem -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glance - Veja o mundo em um s√≥ olhar.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Anima√ß√£o de respira√ß√£o para o logo Glance */
        @keyframes breathing {
            0%   { transform: scale(1);   opacity: 1; }
            25%  { transform: scale(0.96); opacity: 0.92; }
            50%  { transform: scale(0.92); opacity: 0.85; }
            75%  { transform: scale(1.04); opacity: 0.92; }
            100% { transform: scale(1);   opacity: 1; }
        }
    .glance-logo-breath {
            animation: breathing 2s infinite;
            font-family: 'Inter', sans-serif;
            font-weight: 800;
            letter-spacing: 0.05em;
        }
        /* Modal de boas-vindas responsivo e proporcional em telas pequenas */
        @media (max-width: 480px) {
            [data-page="welcome"] > div {
                max-width: 90vw !important;
                min-width: 220px !important;
                padding: 1.2rem !important;
                border-radius: 1.5rem !important;
            }
        }
        @media (max-width: 350px) {
            [data-page="welcome"] > div {
                max-width: 98vw !important;
                min-width: 180px !important;
                padding: 0.7rem !important;
                border-radius: 1.2rem !important;
            }
        }
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s ease; 
        }
        .page { 
            display: none; 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .page.active { 
            display: flex; 
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .fade-out { animation: fadeOut 0.5s ease-out forwards; }
        .slide-in { animation: slideIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .bounce-icon { animation: bounceIcon 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .pulse-btn { animation: pulseBtn 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes bounceIcon { from { transform: scale(1); } 50% { transform: scale(1.2); } to { transform: scale(1); } }
        @keyframes pulseBtn { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }

        /* Estilos espec√≠ficos para o feed para permitir rolagem */
        .scroll-container {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

    </style>
</head>
<body class="bg-gray-100 dark:bg-black text-black dark:text-white transition-colors duration-300 h-screen">
    <!-- Barra de pesquisa no topo, inicialmente oculta -->
    <div id="search-bar-container" class="w-full flex items-center justify-center py-4 px-4 bg-white dark:bg-gray-900 shadow-md sticky top-0 z-40 hidden">
        <input id="search-bar" type="text" placeholder="Pesquisar pessoas ou publica√ß√µes..." class="w-full max-w-lg p-3 rounded-xl border-2 border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200" />
        <button id="search-btn" class="ml-2 bg-blue-500 text-white rounded-full px-4 py-2 font-semibold">Buscar</button>
    </div>

    <!-- Modal Liquid Glass de Boas-Vindas -->
    <div data-page="welcome" class="page fixed inset-0 z-[100] items-center justify-center transition-all duration-500" style="display:none; backdrop-filter: blur(16px); background: rgba(255,255,255,0.12);">
    <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl border border-white/40 p-8 flex flex-col items-center relative" style="box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.10);">
            <h2 class="text-3xl font-extrabold mb-4 text-center text-black dark:text-white drop-shadow-lg">Voc√™ concluiu o cadastro com sucesso!</h2>
            <p class="text-lg mb-6 text-gray-800 dark:text-gray-200 text-center font-medium">Bem-vindo(a) ao Glance, a rede social para compartilhar olhares r√°pidos sobre o mundo.<br><br>
            Aqui voc√™ pode publicar fotos, v√≠deos, textos e √°udios, seguir pessoas e reagir aos posts de forma √∫nica.<br><br>
            <span class="font-semibold">Como funcionam as rea√ß√µes?</span><br>
            <span class="inline-block mt-2 mb-2 p-2 rounded-xl bg-white/60 dark:bg-black/60 backdrop-blur-md shadow border border-white/30 dark:border-black/30">üëÄ Olhei</span>
            <span class="inline-block mt-2 mb-2 p-2 rounded-xl bg-white/60 dark:bg-black/60 backdrop-blur-md shadow border border-white/30 dark:border-black/30">‚ù§Ô∏è Amei</span>
            <span class="inline-block mt-2 mb-2 p-2 rounded-xl bg-white/60 dark:bg-black/60 backdrop-blur-md shadow border border-white/30 dark:border-black/30">üîÅ Re-glance</span>
            <br>
            Use o bot√£o de coment√°rio para conversar e o bot√£o de seguir para acompanhar outros olhares.<br><br>
            Explore, compartilhe e descubra!</p>
            <button id="welcome-understood-btn" class="absolute bottom-6 right-6 py-3 px-8 bg-blue-500/80 text-white font-semibold rounded-2xl shadow-lg hover:bg-blue-600/90 transition-all duration-200 border border-white/30 dark:border-black/30" style="backdrop-filter: blur(4px);">Entendido</button>
        </div>
    </div>

    <!-- Container Principal do Aplicativo -->
    <div id="app" class="relative w-full h-full">
        
        <!-- Tela de Abertura / Login -->
        <div data-page="login" class="page active flex-col items-center justify-center p-8 text-center transition-all duration-500">
            <h1 class="text-6xl font-extrabold mb-4 animate-fade-in">Glance</h1>
            <p class="text-xl italic font-light mb-8 animate-fade-in delay-100">‚ÄúVeja o mundo em um s√≥ olhar.‚Äù</p>
            <div class="space-y-4 w-full max-w-sm animate-fade-in delay-200">
                <button onclick="showPage('signup_form')" class="w-full py-4 px-6 bg-black dark:bg-white text-white dark:text-black font-semibold rounded-2xl shadow-lg transition-transform transform hover:scale-105 duration-200">Criar Conta</button>
                <button onclick="showPage('login_form')" class="w-full py-4 px-6 border-2 border-black dark:border-white text-black dark:text-white font-semibold rounded-2xl transition-transform transform hover:scale-105 duration-200">Entrar</button>
            </div>
        </div>

        <!-- Formul√°rio de Cadastro -->
        <div data-page="signup_form" class="page flex-col items-center justify-center p-8 transition-all duration-500">
            <h2 class="text-3xl font-bold mb-6 text-center text-black dark:text-white">Criar Sua Conta</h2>
            <form id="signup-form" class="w-full max-w-sm space-y-4" autocomplete="off">
                <!-- Apenas e-mail e senha -->
                <input type="email" placeholder="E-mail" name="email" class="w-full p-4 rounded-xl border-2 border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-900 text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200" required />
                <input type="password" placeholder="Senha" name="senha" class="w-full p-4 rounded-xl border-2 border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-900 text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200" required />
                <button id="signup-btn" type="submit" class="w-full py-4 px-6 bg-black dark:bg-white text-white dark:text-black font-semibold rounded-2xl shadow-lg transition-transform transform hover:scale-105 duration-200">Cadastrar</button>
            </form>
            <p class="mt-4 text-center text-black dark:text-white">J√° tem uma conta? <button onclick="showPage('login_form')" class="underline font-semibold">Entrar</button></p>
        </div>

        <!-- Formul√°rio de Login -->
        <div data-page="login_form" class="page flex-col items-center justify-center p-8 transition-all duration-500">
            <h2 class="text-3xl font-bold mb-6 text-center text-black dark:text-white">Entrar</h2>
            <div class="w-full max-w-sm space-y-4">
                <input type="email" placeholder="E-mail ou nome completo" class="w-full p-4 rounded-xl border-2 border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-900 text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200" />
                <input type="password" placeholder="Senha" class="w-full p-4 rounded-xl border-2 border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-900 text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200" />
                <button id="login-btn" class="w-full py-4 px-6 bg-black dark:bg-white text-white dark:text-black font-semibold rounded-2xl shadow-lg transition-transform transform hover:scale-105 duration-200">Entrar</button>
            </div>
            <p class="mt-4 text-center text-black dark:text-white">N√£o tem uma conta? <button onclick="showPage('signup_form')" class="underline font-semibold">Criar Conta</button></p>
        </div>

        <!-- Tela de Onboarding (Carrossel) -->
        <div data-page="onboarding" class="page flex-col items-center justify-center p-8 transition-all duration-500">
            <div id="onboard-container" class="relative w-full h-full max-w-sm overflow-hidden">
                <!-- Slide 1 -->
                <div data-onboard-page="1" class="absolute onboard-slide w-full h-full flex flex-col items-center justify-center text-center transition-opacity duration-500">
                    <div class="bg-blue-300 dark:bg-blue-700 w-48 h-48 rounded-full mb-8 animate-bounce"></div>
                    <h2 class="text-3xl font-bold mb-4 text-black dark:text-white">Bem-vindo(a) ao Glance</h2>
                    <p class="text-lg font-light text-gray-700 dark:text-gray-300">Descubra o mundo atrav√©s de olhares r√°pidos, compartilhados por todos.</p>
                </div>
                <!-- Slide 2 -->
                <div data-onboard-page="2" class="absolute onboard-slide w-full h-full flex flex-col items-center justify-center text-center opacity-0 transition-opacity duration-500">
                    <div class="bg-green-300 dark:bg-green-700 w-48 h-48 rounded-full mb-8 animate-bounce-in-left"></div>
                    <h2 class="text-3xl font-bold mb-4 text-black dark:text-white">Seu Modo, Suas Cores</h2>
                    <p class="text-lg font-light text-gray-700 dark:text-gray-300">Escolha seu tema preferido: claro ou escuro. Voc√™ pode mudar a qualquer momento.</p>
                </div>
                <!-- Slide 3 -->
                <div data-onboard-page="3" class="absolute onboard-slide w-full h-full flex flex-col items-center justify-center text-center opacity-0 transition-opacity duration-500">
                    <div class="bg-purple-300 dark:bg-purple-700 w-48 h-48 rounded-full mb-8 animate-bounce-in-right"></div>
                    <h2 class="text-3xl font-bold mb-4 text-black dark:text-white">Compartilhe Seu Olhar</h2>
                    <p class="text-lg font-light text-gray-700 dark:text-gray-300">Crie glances com fotos, v√≠deos, textos ou √°udios e conecte-se com comunidades.</p>
                </div>
            </div>
            <button id="onboard-next" class="mt-8 py-4 px-12 bg-black dark:bg-white text-white dark:text-black font-semibold rounded-2xl shadow-lg transition-transform transform hover:scale-105 duration-200">Pr√≥ximo</button>
        </div>
        
        <!-- Tela de Onboarding - Escolha de Tema e Interesses -->
        <div data-page="onboarding-final" class="page flex-col items-center justify-center p-8 transition-all duration-500">
            <h2 class="text-3xl font-bold text-center mb-6 text-black dark:text-white">Comece sua Jornada</h2>
            <div class="flex flex-wrap justify-center gap-2 mb-8">
                <button class="interest-btn px-4 py-2 rounded-full border border-gray-400 dark:border-gray-600 transition-colors duration-200 text-black dark:text-white">ü§ñ Tecnologia</button>
                <button class="interest-btn px-4 py-2 rounded-full border border-gray-400 dark:border-gray-600 transition-colors duration-200 text-black dark:text-white">‚úàÔ∏è Viagem</button>
                <button class="interest-btn px-4 py-2 rounded-full border border-gray-400 dark:border-gray-600 transition-colors duration-200 text-black dark:text-white">üé® Arte</button>
                <button class="interest-btn px-4 py-2 rounded-full border border-gray-400 dark:border-gray-600 transition-colors duration-200 text-black dark:text-white">üéµ M√∫sica</button>
            </div>
            <button id="onboarding-final-btn" class="py-4 px-12 bg-black dark:bg-white text-white dark:text-black font-semibold rounded-2xl shadow-lg transition-transform transform hover:scale-105 duration-200">Come√ßar!</button>
        </div>

        <!-- Tela Principal - Feed -->
        <div data-page="feed" class="page flex-col items-center justify-start p-4 pt-16 h-full scroll-container">
            <!-- ...existing code... -->
            <!-- Sidebar Menu Lateral do Feed -->
            <script>
    // --- LOGOUT --- //
    document.addEventListener('DOMContentLoaded', function() {
        function setupLogoutBtn() {
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.onclick = async function() {
                    await firebase.auth().signOut();
                    showPage('login');
                };
            }
        }
        setupLogoutBtn();
        // Se usar navega√ß√£o SPA, reative ao trocar de p√°gina:
        if(window.showPage) {
            const oldShowPage = window.showPage;
            window.showPage = function(page) {
                if (oldShowPage) oldShowPage.apply(this, arguments);
                setTimeout(setupLogoutBtn, 100);
            };
        }
    });
// Adiciona script do Firestore
if (typeof firebase === 'undefined' || !firebase.firestore) {
    var script3 = document.createElement('script');
    script3.src = "https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js";
    document.head.appendChild(script3);
}
// Firebase config e inicializa√ß√£o
if (typeof firebase === 'undefined') {
    // Adiciona scripts do Firebase se n√£o estiverem presentes
    var script1 = document.createElement('script');
    script1.src = "https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js";
    document.head.appendChild(script1);
    var script2 = document.createElement('script');
    script2.src = "https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js";
    document.head.appendChild(script2);
}
window.addEventListener('load', function() {
    if (typeof firebase !== 'undefined' && firebase.firestore && !window.db) {
        window.db = firebase.firestore();
    }
    if (typeof firebase !== 'undefined' && !firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
});
// Valida√ß√£o do cadastro: s√≥ permite criar conta se e-mail for v√°lido e senha >= 6 caracteres
document.addEventListener('DOMContentLoaded', function() {
    var signupForm = document.getElementById('signup-form');
    var signupBtn = document.getElementById('signup-btn');
    if (signupForm && signupBtn) {
        function checkFields() {
            var email = signupForm.querySelector('[name="email"]').value.trim();
            var senha = signupForm.querySelector('[name="senha"]').value.trim();
            var emailRegex = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
            var validEmail = emailRegex.test(email);
            var validSenha = senha.length >= 6;
            signupBtn.disabled = (!validEmail || !validSenha);
            signupBtn.classList.toggle('opacity-50', signupBtn.disabled);
            signupBtn.classList.toggle('cursor-not-allowed', signupBtn.disabled);
        }
        signupForm.querySelector('[name="email"]').addEventListener('input', checkFields);
        signupForm.querySelector('[name="senha"]').addEventListener('input', checkFields);
        checkFields();
    }
});
// Valida√ß√£o de login e cadastro
function attachLoginSignupValidation() {
    // Login
    var loginBtn = document.getElementById('login-btn');
    if (loginBtn) {
        loginBtn.onclick = null;
        loginBtn.onclick = function(e) {
            var form = loginBtn.closest('.page');
            var email = form.querySelector('input[type="email"]');
            var senha = form.querySelector('input[type="password"]');
            if (!email.value.trim() || !senha.value.trim()) {
                e.preventDefault();
                if (typeof showMessageBox === 'function') {
                    showMessageBox('Preencha todos os campos para entrar!');
                } else {
                    alert('Preencha todos os campos para entrar!');
                }
                return false;
            }
            if (!email.value.trim().endsWith('@gmail.com')) {
                e.preventDefault();
                if (typeof showMessageBox === 'function') {
                    showMessageBox('O e-mail deve terminar com @gmail.com');
                } else {
                    alert('O e-mail deve terminar com @gmail.com');
                }
                return false;
            }
            showPage('feed');
        };
    }
    // Cadastro
    var signupForm = document.getElementById('signup-form');
    if (signupForm) {
        signupForm.onsubmit = function(e) {
            e.preventDefault();
            var inputs = signupForm.querySelectorAll('input');
            var emailInput = signupForm.querySelector('[name="email"]');
            var senhaInput = signupForm.querySelector('[name="senha"]');
            var email = emailInput ? emailInput.value.trim() : '';
            var senha = senhaInput ? senhaInput.value.trim() : '';
            var emailRegex = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
            if (!email || !senha || !emailRegex.test(email) || senha.length < 6) {
                // N√£o envia, sem alertas
                return false;
            }
            // Firebase Auth: cria conta
            if (typeof firebase !== 'undefined' && firebase.auth && firebase.firestore) {
                firebase.auth().createUserWithEmailAndPassword(email, senha)
                    .then(function(userCredential) {
                        // Usu√°rio criado com sucesso
                        var user = userCredential.user;
                        // Salva dados b√°sicos no Firestore e s√≥ ent√£o avan√ßa
                        firebase.firestore().collection('users').doc(user.uid).set({
                            email: user.email,
                            criadoEm: new Date()
                        }).then(function() {
                            showPage('onboarding');
                        }).catch(function(err) {
                            alert('Conta criada, mas erro ao salvar dados: ' + err.message);
                        });
                    })
                    .catch(function(error) {
                        if (error.code === 'auth/email-already-in-use') {
                            alert('Este e-mail j√° est√° em uso. Use outro ou fa√ßa login.');
                        } else {
                            alert('Erro ao cadastrar: ' + error.message);
                        }
                        // N√£o faz mais nada!
                    });
                return false;
            }
            return false;
        };
    }
}
document.addEventListener('DOMContentLoaded', attachLoginSignupValidation);
// Re-attach validation every time a page is shown
if (window.showPage) {
    const oldShowPage = window.showPage;
    window.showPage = function(page) {
        if (oldShowPage) oldShowPage.apply(this, arguments);
        setTimeout(attachLoginSignupValidation, 50);
    };
}
            document.addEventListener('DOMContentLoaded', function() {
                const menuBtn = document.getElementById('feed-menu-hamburguer');
                const sidebar = document.getElementById('feed-sidebar-menu');
                const closeSidebar = document.getElementById('close-feed-sidebar');
                if(menuBtn && sidebar && closeSidebar) {
                    menuBtn.onclick = function(e) {
                        e.stopPropagation();
                        sidebar.style.display = 'flex';
                        setTimeout(() => sidebar.style.transform = 'translateX(0)', 10);
                    };
                    closeSidebar.onclick = function(e) {
                        e.stopPropagation();
                        sidebar.style.transform = 'translateX(100%)';
                        setTimeout(() => sidebar.style.display = 'none', 300);
                    };
                    document.addEventListener('mousedown', function closeMenuOnClickOutside(ev) {
                        if (sidebar.style.display === 'flex' && !sidebar.contains(ev.target) && ev.target !== menuBtn) {
                            sidebar.style.transform = 'translateX(100%)';
                            setTimeout(() => sidebar.style.display = 'none', 300);
                            document.removeEventListener('mousedown', closeMenuOnClickOutside);
                        }
                    });
                }
            });
            </script>
            <!-- Logo Glance animada fixa no canto superior esquerdo -->
            <div class="fixed left-0 top-0 z-50 select-none pointer-events-none w-full">
            <div class="fixed left-0 top-0 z-50 w-full">
                <!-- Barra fixa estilo Instagram para o logo Glance -->
                <div id="glance-logo-bar" class="w-full fixed top-0 left-0 z-40 bg-white dark:bg-gray-900 shadow-md flex items-center justify-between h-14 pl-8 pr-6">
                        <button id="feed-messages-btn" style="cursor:pointer;" class="flex items-center justify-center w-10 h-10 p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-800 transition select-none" aria-label="Mensagens">
                    <span class="text-3xl font-[cursive] text-blue-600" style="font-family: 'Pacifico', 'Caveat', cursive;">Glance</span>
                    <div class="flex items-center gap-2">
                        <button id="feed-messages-btn" class="flex items-center justify-center w-10 h-10 p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-800 transition select-none" aria-label="Mensagens">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-7 h-7 text-blue-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" /></svg>
                        </button>
                    </div>
                </div>
                <!-- Fonte manuscrita para logo -->
                <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Caveat&display=swap" rel="stylesheet">
            </div>
            <div id="feed-scroll-container" class="w-full max-w-md space-y-8 flex flex-col items-center">
            <!-- Conte√∫do do feed ser√° gerado aqui pelo JavaScript -->
                <!-- Conte√∫do do feed ser√° gerado aqui pelo JavaScript -->
                <style>
                    #feed-scroll-container { padding-bottom: 6rem; }
                </style>
            </div>
        </div>

        <!-- Tela Principal - Explorar -->
        <div data-page="explore" class="page flex-col items-center justify-start p-4 pt-16 h-full scroll-container">
            <h2 class="text-3xl font-bold mb-4 text-black dark:text-white">Explorar</h2>
            <div id="explore-profiles-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6 w-full max-w-3xl mx-auto"></div>
            <script>
            // Cores variadas para os c√≠rculos
            const profileColors = [
                'bg-pink-400', 'bg-blue-400', 'bg-green-400', 'bg-yellow-400',
                'bg-purple-400', 'bg-red-400', 'bg-indigo-400', 'bg-teal-400',
                'bg-orange-400', 'bg-cyan-400', 'bg-fuchsia-400', 'bg-lime-400'
            ];
            function renderExploreProfilesGrid() {
                const grid = document.getElementById('explore-profiles-grid');
                if (!grid) return;
                // Mostra todos os usu√°rios, inclusive o logado
                const userList = Object.values(users);
                let html = '';
                // Mesmas cores do perfil
                const borderColors = [
                    '#ec4899', // pink-400
                    '#60a5fa', // blue-400
                    '#4ade80', // green-400
                    '#facc15', // yellow-400
                    '#a78bfa', // purple-400
                    '#f87171', // red-400
                    '#818cf8', // indigo-400
                    '#2dd4bf', // teal-400
                    '#fb923c', // orange-400
                    '#22d3ee', // cyan-400
                    '#e879f9', // fuchsia-400
                    '#a3e635'  // lime-400
                ];
                userList.forEach((u, i) => {
                    const color = borderColors[i % borderColors.length];
                    let following = JSON.parse(localStorage.getItem('following') || '{}');
                    const isFollowing = following[u.username] === true;
                    html += `<div class='flex flex-col items-center'>
                        <div class='explore-profile-circle w-20 h-20 rounded-full border-4 shadow-lg flex items-center justify-center mb-2 overflow-hidden cursor-pointer' data-username='${u.username}' style='border-color:${color}'>
                            <img src='${u.avatar}' alt='${u.name || u.username}' class='w-full h-full object-cover rounded-full'/>
                        </div>
                        <div class='text-xs font-semibold text-center mb-1 text-black dark:text-white'>${u.name || '@'+u.username}</div>
                        <button class='explore-follow-btn px-4 py-1 rounded-full font-bold text-xs shadow transition ${isFollowing ? 'bg-green-500 text-white' : 'bg-blue-500 text-white hover:bg-blue-600'}' data-username='${u.username}'>${isFollowing ? 'Seguindo' : 'Seguir'}</button>
                    </div>`;
                });
                grid.innerHTML = html;
                // Bot√£o seguir/desseguir
                grid.querySelectorAll('.explore-follow-btn').forEach(btn => {
                    btn.onclick = function() {
                        const username = btn.getAttribute('data-username');
                        if (!username) return;
                        let following = JSON.parse(localStorage.getItem('following') || '{}');
                        let isFollowing = following[username] === true;
                        // Alterna seguir/desseguir
                        if (isFollowing) {
                            following[username] = false;
                            // Atualiza seguidores
                            if (users[username] && users[username].followers > 0) users[username].followers--;
                        } else {
                            following[username] = true;
                            if (users[username]) users[username].followers = (users[username].followers || 0) + 1;
                        }
                        localStorage.setItem('following', JSON.stringify(following));
                        // Atualiza todos os bot√µes de seguir (inclusive no perfil)
                        document.querySelectorAll(`.explore-follow-btn[data-username='${username}']`).forEach(b => {
                            let isNowFollowing = JSON.parse(localStorage.getItem('following') || '{}')[username] === true;
                            b.textContent = isNowFollowing ? 'Seguindo' : 'Seguir';
                            b.classList.remove('bg-blue-500','hover:bg-blue-600','bg-green-500');
                            b.classList.add(isNowFollowing ? 'bg-green-500' : 'bg-blue-500');
                        });
                        // Atualiza bot√£o do perfil se estiver aberto
                        if (document.getElementById('profile-username') && document.getElementById('profile-username').textContent === '@'+username) {
                            const followBtn = document.getElementById('edit-profile-btn')?.parentElement?.querySelector('.follow-btn');
                            if (followBtn) {
                                let isNowFollowing = JSON.parse(localStorage.getItem('following') || '{}')[username] === true;
                                followBtn.textContent = isNowFollowing ? 'Seguindo' : 'Seguir';
                                followBtn.classList.remove('bg-blue-500','bg-green-500');
                                followBtn.classList.add(isNowFollowing ? 'bg-green-500' : 'bg-blue-500');
                            }
                            // Atualiza n√∫mero de seguidores
                            const followersCount = document.getElementById('profile-followers-count');
                            if (followersCount && users[username]) followersCount.textContent = users[username].followers;
                        }
                    };
                });
                // Clique no c√≠rculo do perfil para abrir o perfil
                grid.querySelectorAll('.explore-profile-circle').forEach(circle => {
                    circle.onclick = function() {
                        const username = circle.getAttribute('data-username');
                        if (typeof showPage === 'function') {
                            showPage('profile', username);
                            if (typeof updateProfilePage === 'function') updateProfilePage(username);
                        }
                    };
                });
            }
            document.addEventListener('DOMContentLoaded', renderExploreProfilesGrid);
            if (window.showPage) {
                const oldShowPage = window.showPage;
                window.showPage = function(page) {
                    if (oldShowPage) oldShowPage.apply(this, arguments);
                    if (page === 'explore') setTimeout(renderExploreProfilesGrid, 0);
                };
            }
            </script>
            <script>
            // Tend√™ncias: posts mais curtidos/compartilhados da semana
            function renderTrendsPanel() {
                const panel = document.getElementById('trends-panel');
                if (!panel) return;
                // Limpa painel
                panel.innerHTML = '';
                // Busca o post mais curtido do feed
                let topPost = null;
                if (window.posts && posts.length > 0) {
                    // Sempre pega do array posts (que √© atualizado no feed)
                    function getReactions(p) {
                        let v = (p.reactions && typeof p.reactions.views === 'number') ? p.reactions.views : (typeof p.views === 'number' ? p.views : 0);
                        let l = (p.reactions && typeof p.reactions.likes === 'number') ? p.reactions.likes : (typeof p.likes === 'number' ? p.likes : 0);
                        let s = (p.reactions && typeof p.reactions.shares === 'number') ? p.reactions.shares : (typeof p.shares === 'number' ? p.shares : 0);
                        return v + l + s;
                    }
                    topPost = posts.reduce((max, p) => (getReactions(p) > getReactions(max) ? p : max), posts[0]);
                }
                let html = `<div class='bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6'><h3 class='text-xl font-bold mb-4 text-pink-700 dark:text-pink-300'>Tend√™ncia do Momento</h3>`;
                const topLikes = topPost ? (topPost.reactions && typeof topPost.reactions.likes === 'number' ? topPost.reactions.likes : (typeof topPost.likes === 'number' ? topPost.likes : 0)) : 0;
                const topShares = topPost ? (topPost.reactions && typeof topPost.reactions.shares === 'number' ? topPost.reactions.shares : (typeof topPost.shares === 'number' ? topPost.shares : 0)) : 0;
                if (!topPost || ((topPost.reactions ? (topPost.reactions.views||0)+(topPost.reactions.likes||0)+(topPost.reactions.shares||0) : 0) + (typeof topPost.views==='number'?topPost.views:0)+(typeof topPost.likes==='number'?topPost.likes:0)+(typeof topPost.shares==='number'?topPost.shares:0)) === 0) {
                    html += `<div class='text-gray-500 text-center'>Nenhum post em alta no momento.</div>`;
                } else {
                    html += `<div class='bg-gray-100 dark:bg-gray-700 rounded-lg p-4 mb-2 flex flex-col gap-2'>
                        <div class='flex items-center gap-2 mb-1'>
                            <span class='font-bold text-pink-700 dark:text-pink-300'>@${users[topPost.user]?.username || topPost.user}</span>
                            <span class='ml-auto text-xs text-gray-500'>${topLikes} ‚ù§${topShares ? ' ¬∑ ' + topShares + ' ‚Üª' : ''}</span>
                        </div>
                        <div class='text-black dark:text-white'>${topPost.text || '[M√≠dia]'}</div>
                        <div class='text-xs text-gray-400'>${timeAgo(new Date(topPost.timestamp).getTime())}</div>
                    </div>`;
                }
                html += `</div>`;
                panel.innerHTML = html;
            }
            // ...existing code...
            document.addEventListener('DOMContentLoaded', function() {
                const trendsBtn = document.getElementById('trends-btn');
                if (trendsBtn) {
                    trendsBtn.onclick = function() {
                        // Altern√¢ncia: fecha se j√° aberto
                        const panel = document.getElementById('trends-panel');
                        if (panel && panel.innerHTML.trim() !== '') {
                            panel.innerHTML = '';
                            return;
                        }
                        // Fecha outros pain√©is
                        document.getElementById('global-events-panel').innerHTML = '';
                        renderTrendsPanel();
                    };
                }
                const mapBtn = document.getElementById('global-map-btn');
                if (mapBtn) {
                    mapBtn.onclick = function() {
                        // Fecha outros pain√©is
                        document.getElementById('trends-panel').innerHTML = '';
                        renderGlobalEventsPanel();
                    };
                }
            });

                // Evento de clique nos eventos
                panel.querySelectorAll('.event-btn').forEach(btn => {
                    btn.onclick = function() {
                        // Fecha todos os outros pain√©is abertos
                        panel.querySelectorAll('.event-posts-panel').forEach(div => { div.innerHTML = ''; });
                        // Altern√¢ncia: se j√° est√° aberto, fecha
                        const parent = btn.parentElement;
                        const postsPanel = parent.querySelector('.event-posts-panel');
                        if (postsPanel && postsPanel.innerHTML.trim() !== '') {
                            postsPanel.innerHTML = '';
                            return;
                        }
                        // Busca posts relacionados (filtro simples por palavra-chave no texto ou categoria)
                        const eventId = btn.getAttribute('data-eventid');
                        const ev = globalEvents.find(e => e.id === eventId);
                        if (!ev) return;
                        let related = [];
                        if (window.posts) {
                            related = posts.filter(p => {
                                const txt = (p.text || '') + ' ' + (p.category || '') + ' ' + (p.media || '');
                                return ev.keywords.some(k => txt.toLowerCase().includes(k));
                            });
                        }
                        let postsHtml = `<div class='mt-4'>`;
                        if (related.length === 0) {
                            postsHtml += `<div class='text-gray-500 text-center'>Nenhum post relacionado a <b>${ev.name}</b> encontrado.</div>`;
                        } else {
                            postsHtml += `<div class='font-semibold mb-2 text-blue-700 dark:text-blue-300'>Posts relacionados:</div>`;
                            related.slice(0,8).forEach(p => {
                                postsHtml += `<div class='bg-gray-100 dark:bg-gray-700 rounded-lg p-3 mb-2'><span class='font-bold'>@${users[p.user]?.username || p.user}</span>: ${(p.text || '[M√≠dia]')}</div>`;
                            });
                        }
                        postsHtml += `</div>`;
                        postsPanel.innerHTML = postsHtml;
                    };
                });
            

            document.addEventListener('DOMContentLoaded', function() {
                const trendsBtn = document.getElementById('trends-btn');
                if (trendsBtn) {
                    trendsBtn.onclick = function() {
                        // Altern√¢ncia: fecha se j√° aberto
                        const panel = document.getElementById('trends-panel');
                        if (panel && panel.innerHTML.trim() !== '') {
                            panel.innerHTML = '';
                            return;
                        }
                        // Fecha outros pain√©is
                        document.getElementById('global-events-panel').innerHTML = '';
                        renderTrendsPanel();
                    };
                }
                const mapBtn = document.getElementById('global-map-btn');
                if (mapBtn) {
                    mapBtn.onclick = function() {
                        // Fecha outros pain√©is
                        document.getElementById('trends-panel').innerHTML = '';
                        renderGlobalEventsPanel();
                    };
                }
            });
            </script>
        </div>

        <!-- Tela Principal - Criar Glance -->
        <div data-page="create" class="page flex-col items-center justify-center p-4 pt-16 h-full scroll-container">
            <!-- Inputs de upload escondidos -->
            <input id="glance-upload-photo" type="file" accept="image/*" class="hidden" />
            <input id="glance-upload-video" type="file" accept="video/*" class="hidden" />
            <!-- √Årea de grava√ß√£o de √°udio -->
            <div id="audio-record-area" class="hidden flex flex-col items-center justify-center w-full h-60 bg-gray-200 dark:bg-gray-800 rounded-2xl mb-4">
                <button id="start-audio-record" class="bg-red-500 text-white rounded-full w-16 h-16 flex items-center justify-center text-3xl mb-2"><span id="audio-record-icon">üé§</span></button>
                <span id="audio-record-timer" class="text-lg font-bold">00:00</span>
                <button id="stop-audio-record" class="mt-2 bg-gray-700 text-white rounded px-4 py-2 hidden">Parar</button>
                <audio id="audio-record-preview" class="mt-2 hidden" controls></audio>
            </div>
            <button id="glance-plus-btn" class="bg-red-500 w-20 h-20 rounded-full flex items-center justify-center shadow-xl pulse-btn">
                <span class="text-white text-3xl">‚ûï</span>
            </button>
            <div class="flex justify-center space-x-4 mt-4">
                <button id="btn-pub-photo" class="p-3 rounded-full bg-gray-200 dark:bg-gray-800 text-black dark:text-white">Foto</button>
                <button id="btn-pub-video" class="p-3 rounded-full bg-gray-200 dark:bg-gray-800 text-black dark:text-white">V√≠deo</button>
                <button id="btn-pub-text" class="p-3 rounded-full bg-gray-200 dark:bg-gray-800 text-black dark:text-white">Texto</button>
                <button id="btn-pub-audio" class="p-3 rounded-full bg-gray-200 dark:bg-gray-800 text-black dark:text-white">√Åudio</button>
            </div>
        </div>
        
        <!-- Tela Principal - Comunidades -->
        <div data-page="communities" class="page flex-col items-center justify-start p-4 pt-16 h-full scroll-container">
            <h2 class="text-3xl font-bold mb-4 text-black dark:text-white">Glance Videos</h2>
            <div id="glance-videos-carousel" class="flex flex-row overflow-x-auto snap-x snap-mandatory w-full h-[40vh] px-4 space-x-8" style="scroll-behavior:smooth;">
                <!-- V√≠deos de exemplo -->
            </div>
            <div id="glance-videos-categories" class="w-full flex flex-row items-center overflow-x-auto space-x-4 py-4 px-4" style="height:30vh;background:rgba(245,245,255,0.95);border-radius:2rem;">
                <!-- Stories/Categorias -->
            </div>
            <script>
        // L√≥gica dos bot√µes de publica√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
                // Salvar perfil ao clicar no bot√£o salvar
                var saveProfileBtn = document.getElementById('save-profile-btn');
                var editForm = document.getElementById('edit-profile-form');
                if (saveProfileBtn && editForm) {
                    saveProfileBtn.onclick = function(e) {
                        e.preventDefault();
                        var usernameInput = document.getElementById('edit-username');
                        var bioInput = document.getElementById('edit-bio');
                        var birthdateInput = document.getElementById('edit-birthdate');
                        var genderInput = document.getElementById('edit-gender');
                        var realnameInput = document.getElementById('edit-realname');
                        // Verifica se todos os campos obrigat√≥rios est√£o preenchidos
                        if (!usernameInput || !usernameInput.value.trim() ||
                            !realnameInput || !realnameInput.value.trim() ||
                            !bioInput || !bioInput.value.trim() ||
                            !birthdateInput || !birthdateInput.value.trim() ||
                            !genderInput || !genderInput.value.trim()) {
                            if (typeof showMessageBox === 'function') {
                                showMessageBox('Preencha todos os campos do perfil para salvar!');
                            } else {
                                alert('Preencha todos os campos do perfil para salvar!');
                            }
                            return false;
                        }
                        var user = users[window.loggedInUser];
                        if (user) {
                            user.username = usernameInput.value.trim();
                            user.name = realnameInput.value.trim();
                            user.bio = bioInput.value;
                            user.birthdate = birthdateInput.value;
                            user.gender = genderInput.value;
                            updateProfilePage(window.loggedInUser);
                            editForm.classList.add('hidden');
                            showMessageBox('Perfil atualizado com sucesso!');
                        }
                    };
                }
            // Bot√µes
            const btnPhoto = document.getElementById('btn-pub-photo');
            const btnVideo = document.getElementById('btn-pub-video');
            const btnText = document.getElementById('btn-pub-text');
            const btnAudio = document.getElementById('btn-pub-audio');
            const inputPhoto = document.getElementById('glance-upload-photo');
            const inputVideo = document.getElementById('glance-upload-video');
            const audioArea = document.getElementById('audio-record-area');
            const startAudioBtn = document.getElementById('start-audio-record');
            const stopAudioBtn = document.getElementById('stop-audio-record');
            const audioTimer = document.getElementById('audio-record-timer');
            const audioPreview = document.getElementById('audio-record-preview');
            let audioChunks = [];
            let mediaRecorder = null;
            let audioTimerInterval = null;
            let audioSeconds = 0;

            // Foto
            if (btnPhoto && inputPhoto) {
                btnPhoto.onclick = () => { inputPhoto.value = ''; inputPhoto.click(); };
                inputPhoto.onchange = function() {
                    if (inputPhoto.files && inputPhoto.files[0]) {
                        const file = inputPhoto.files[0];
                        const url = URL.createObjectURL(file);
                        const previewContainer = document.getElementById('glance-preview-container');
                        if (previewContainer) previewContainer.innerHTML = `<img src='${url}' class='w-full max-w-xs rounded-xl mb-2' />`;
                        window.uploadedFileData = url;
                        window.uploadedFileType = 'image';
                        window.uploadedTextContent = null;
                        const glanceDescModal = document.getElementById('glance-desc-modal');
                        if (glanceDescModal) glanceDescModal.classList.remove('hidden');
                        const publishBtn = document.getElementById('glance-publish-btn');
                        if (publishBtn) publishBtn.style.display = 'block';
                    }
                };
            }
            // V√≠deo
            if (btnVideo && inputVideo) {
                btnVideo.onclick = () => { inputVideo.value = ''; inputVideo.click(); };
                inputVideo.onchange = function() {
                    if (inputVideo.files && inputVideo.files[0]) {
                        const file = inputVideo.files[0];
                        const url = URL.createObjectURL(file);
                        const previewContainer = document.getElementById('glance-preview-container');
                        if (previewContainer) previewContainer.innerHTML = `<video src='${url}' controls class='w-full max-w-xs rounded-xl mb-2'></video>`;
                        window.uploadedFileData = url;
                        window.uploadedFileType = 'video';
                        window.uploadedTextContent = null;
                        // Adiciona campo de categoria obrigat√≥rio
                        let catSelect = document.getElementById('glance-video-category');
                        if (!catSelect) {
                            catSelect = document.createElement('select');
                            catSelect.id = 'glance-video-category';
                            catSelect.className = 'w-full mt-2 mb-2 p-2 rounded-xl border-2 border-blue-400 bg-white text-black font-semibold';
                            catSelect.required = true;
                            catSelect.innerHTML = `<option value='' disabled selected hidden>Escolha a categoria</option>
                                <option value='Viagem'>Viagem</option>
                                <option value='Tecnologia'>Tecnologia</option>
                                <option value='Arte'>Arte</option>
                                <option value='M√∫sica'>M√∫sica</option>
                                <option value='Humor'>Humor</option>
                                <option value='Educa√ß√£o'>Educa√ß√£o</option>
                                <option value='Vlog'>Vlog</option>
                                <option value='Outro'>Outro</option>`;
                            previewContainer.parentNode.insertBefore(catSelect, previewContainer.nextSibling);
                        } else {
                            catSelect.style.display = '';
                        }
                        const glanceDescModal = document.getElementById('glance-desc-modal');
                        if (glanceDescModal) glanceDescModal.classList.remove('hidden');
                        const publishBtn = document.getElementById('glance-publish-btn');
                        if (publishBtn) publishBtn.style.display = 'block';
                    }
                };
            }
            // Ao publicar v√≠deo, exige categoria
            const publishBtn = document.getElementById('glance-publish-btn');
            if (publishBtn) {
                publishBtn.onclick = function(e) {
                    if (window.uploadedFileType === 'video') {
                        const catSelect = document.getElementById('glance-video-category');
                        if (!catSelect || !catSelect.value) {
                            catSelect.classList.add('border-red-500');
                            showMessageBox('Escolha uma categoria para o v√≠deo!');
                            e.preventDefault();
                            return false;
                        }
                        catSelect.classList.remove('border-red-500');
                    }
                    // --- TEXT POST LOGIC ---
                    if (window.uploadedFileType === 'text') {
                        const descInput = document.getElementById('glance-desc-input');
                        const textContent = descInput?.value.trim();
                        if (textContent && textContent.length > 0) {
                            posts.push({
                                id: 'post' + (Date.now() + Math.floor(Math.random()*10000)),
                                user: window.loggedInUser,
                                type: 'text',
                                media: null,
                                text: textContent,
                                reactions: { views: 0, likes: 0, shares: 0 },
                                timestamp: Date.now()
                            });
                            if (typeof generateFeedContent === 'function') generateFeedContent();
                            if (typeof updateProfilePage === 'function') updateProfilePage(window.loggedInUser);
                            if (typeof renderGlanceVideos === 'function') renderGlanceVideos();
                            if (typeof showPage === 'function') showPage('feed');
                            const glanceDescModal = document.getElementById('glance-desc-modal');
                            if (glanceDescModal) glanceDescModal.classList.add('hidden');
                            window.uploadedFileData = null;
                            window.uploadedFileType = null;
                            window.uploadedTextContent = null;
                            const previewContainer = document.getElementById('glance-preview-container');
                            if (previewContainer) previewContainer.innerHTML = '';
                            if (descInput) descInput.value = '';
                            e.preventDefault();
                            return false;
                        }
                    }
                };
            }
            if (btnText) {
                btnText.onclick = () => {
                    const previewContainer = document.getElementById('glance-preview-container');
                    if (previewContainer) previewContainer.innerHTML = '';
                    window.uploadedFileData = null;
                    window.uploadedFileType = 'text';
                    window.uploadedTextContent = '';
                    const glanceDescModal = document.getElementById('glance-desc-modal');
                    if (glanceDescModal) glanceDescModal.classList.remove('hidden');
                    const publishBtn = document.getElementById('glance-publish-btn');
                    if (publishBtn) publishBtn.style.display = 'block';
                };
            }
            // √Åudio
            if (btnAudio && audioArea && startAudioBtn && stopAudioBtn && audioTimer && audioPreview) {
                // Cria modal de publica√ß√£o de √°udio se n√£o existir
                let audioPublishModal = document.getElementById('audio-publish-modal');
                if (!audioPublishModal) {
                    audioPublishModal = document.createElement('div');
                    audioPublishModal.id = 'audio-publish-modal';
                    audioPublishModal.className = 'hidden fixed inset-0 z-[999] flex items-center justify-center bg-black bg-opacity-80';
                    audioPublishModal.innerHTML = `
                        <div class="w-full max-w-md bg-white dark:bg-gray-900 rounded-2xl p-8 space-y-6 shadow-2xl flex flex-col items-center">
                            <h2 class="text-xl font-bold mb-2 text-center text-black dark:text-white">Pr√©via do √Åudio</h2>
                            <audio id="audio-publish-preview" controls class="w-full mb-4"></audio>
                            <div class="flex w-full space-x-2">
                                <button id="audio-publish-confirm" class="flex-1 py-3 bg-blue-500 text-white font-semibold rounded-2xl">Publicar</button>
                                <button id="audio-publish-cancel" class="flex-1 py-3 bg-gray-300 dark:bg-gray-700 text-black dark:text-white font-semibold rounded-2xl">Cancelar</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(audioPublishModal);
                }
                // Fun√ß√£o para mostrar modal de publica√ß√£o de √°udio
                function showAudioPublishModal(audioUrl) {
                    audioPublishModal.classList.remove('hidden');
                    const preview = document.getElementById('audio-publish-preview');
                    if (preview) {
                        preview.src = audioUrl;
                        preview.currentTime = 0;
                        preview.play();
                    }
                }
                // Fun√ß√£o para esconder modal
                function hideAudioPublishModal() {
                    audioPublishModal.classList.add('hidden');
                    const preview = document.getElementById('audio-publish-preview');
                    if (preview) preview.pause();
                }
                // Bot√£o cancelar
                document.getElementById('audio-publish-cancel').onclick = function() {
                    hideAudioPublishModal();
                    window.uploadedFileData = null;
                    window.uploadedFileType = null;
                    window.uploadedTextContent = null;
                    audioArea.classList.add('hidden');
                    audioPreview.classList.add('hidden');
                };
                // Bot√£o publicar
                document.getElementById('audio-publish-confirm').onclick = function() {
                    // Adiciona post de √°udio ao feed
                    if (window.uploadedFileData) {
                        posts.push({
                            user: window.loggedInUser,
                            type: 'audio',
                            media: window.uploadedFileData,
                            text: '', // N√£o exibe descri√ß√£o
                            reactions: { views: 0, likes: 0, shares: 0 },
                            timestamp: Date.now()
                        });
                        generateFeedContent();
                        updateProfilePage(window.loggedInUser);
                        if (typeof renderGlanceVideos === 'function') renderGlanceVideos();
                        // Redireciona para o feed
                        if (typeof showPage === 'function') showPage('feed');
                    }
                    hideAudioPublishModal();
                    window.uploadedFileData = null;
                    window.uploadedFileType = null;
                    window.uploadedTextContent = null;
                    audioArea.classList.add('hidden');
                    audioPreview.classList.add('hidden');
                };
                // L√≥gica de grava√ß√£o
                btnAudio.onclick = () => {
                    audioArea.classList.remove('hidden');
                    audioPreview.classList.add('hidden');
                    stopAudioBtn.classList.add('hidden');
                    startAudioBtn.disabled = false;
                    audioTimer.textContent = '00:00';
                };
                startAudioBtn.onclick = async () => {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        alert('Seu navegador n√£o suporta grava√ß√£o de √°udio.');
                        return;
                    }
                    audioChunks = [];
                    audioSeconds = 0;
                    audioTimer.textContent = '00:00';
                    startAudioBtn.disabled = true;
                    stopAudioBtn.classList.remove('hidden');
                    mediaRecorder = null;
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            const url = URL.createObjectURL(audioBlob);
                            audioPreview.src = url;
                            audioPreview.classList.remove('hidden');
                            window.uploadedFileData = url;
                            window.uploadedFileType = 'audio';
                            window.uploadedTextContent = null;
                            showAudioPublishModal(url);
                        };
                        mediaRecorder.start();
                        audioTimerInterval = setInterval(() => {
                            audioSeconds++;
                            const min = String(Math.floor(audioSeconds/60)).padStart(2,'0');
                            const sec = String(audioSeconds%60).padStart(2,'0');
                            audioTimer.textContent = `${min}:${sec}`;
                            if (audioSeconds >= 90) { // 1:30 min
                                stopAudioBtn.click();
                            }
                        }, 1000);
                    } catch (err) {
                        alert('Erro ao acessar o microfone.');
                        startAudioBtn.disabled = false;
                        stopAudioBtn.classList.add('hidden');
                    }
                };
                stopAudioBtn.onclick = () => {
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                    }
                    startAudioBtn.disabled = false;
                    stopAudioBtn.classList.add('hidden');
                    clearInterval(audioTimerInterval);
                };
            }
        });
        // Abre automaticamente o seletor de arquivos ao entrar na aba de publicar
    document.addEventListener('DOMContentLoaded', function() {
            // Show premium button only for own profile
            function togglePremiumBtn() {
                var premiumBtn = document.getElementById('premium-btn');
                var profileUsername = document.getElementById('profile-username');
                if (!premiumBtn || !profileUsername) return;
                // Remove @ if present
                var username = profileUsername.textContent.replace(/^@/, '');
                if (window.loggedInUser && username === window.loggedInUser) {
                    premiumBtn.classList.remove('hidden');
                } else {
                    premiumBtn.classList.add('hidden');
                }
            }
            // Call on profile page load/update
            if (typeof window.updateProfilePage === 'function') {
                var oldUpdateProfilePage = window.updateProfilePage;
                window.updateProfilePage = function() {
                    oldUpdateProfilePage.apply(this, arguments);
                    togglePremiumBtn();
                };
            }
            // Also call on DOMContentLoaded in case profile is loaded by default
            togglePremiumBtn();
            const createPage = document.querySelector('[data-page="create"]');
            const autoInput = document.getElementById('glance-upload-auto');
            if (createPage && autoInput) {
                const observer = new MutationObserver(() => {
                    if (createPage.classList.contains('active')) {
                        autoInput.value = '';
                        autoInput.click();
                    }
                });
                observer.observe(createPage, { attributes: true, attributeFilter: ['class'] });
            }
            if (autoInput) {
                autoInput.addEventListener('change', function() {
                    if (autoInput.files && autoInput.files[0]) {
                        const file = autoInput.files[0];
                        const url = URL.createObjectURL(file);
                        // Prepara preview e vari√°veis globais
                        const previewContainer = document.getElementById('glance-preview-container');
                        if (previewContainer) {
                            if (file.type.startsWith('image/')) {
                                previewContainer.innerHTML = `<img src='${url}' class='w-full max-w-xs rounded-xl mb-2' />`;
                            } else if (file.type.startsWith('video/')) {
                                previewContainer.innerHTML = `<video src='${url}' controls class='w-full max-w-xs rounded-xl mb-2'></video>`;
                            }
                        }
                        window.uploadedFileData = url;
                        window.uploadedFileType = file.type.startsWith('image/') ? 'image' : 'video';
                        window.uploadedTextContent = null;
                        // Mostra o modal de descri√ß√£o
                        const glanceDescModal = document.getElementById('glance-desc-modal');
                        if (glanceDescModal) glanceDescModal.classList.remove('hidden');
                        // Mostra bot√£o publicar
                        const publishBtn = document.getElementById('glance-publish-btn');
                        if (publishBtn) publishBtn.style.display = 'block';
                    }
                });
            }
        });
            // Categorias de exemplo
            const videoCategories = [
                { name: 'Todos', icon: 'üåé' },
                { name: 'M√∫sica', icon: 'üéµ' },
                { name: 'Humor', icon: 'üòÇ' },
                { name: 'Esportes', icon: 'üèÄ' },
                { name: 'Tecnologia', icon: 'ü§ñ' },
                { name: 'Viagem', icon: '‚úàÔ∏è' },
                { name: 'Culin√°ria', icon: 'üçî' },
                { name: 'Pets', icon: 'üê∂' },
                { name: 'Educa√ß√£o', icon: 'üìö' }
            ];

            let selectedCategory = 'Todos';

            function renderVideoCategories() {
                const catBar = document.getElementById('glance-videos-categories');
                if (!catBar) return;
                catBar.innerHTML = '';
                videoCategories.forEach(cat => {
                    const btn = document.createElement('button');
                    btn.className = 'flex flex-col items-center justify-center px-4 py-2 rounded-2xl shadow-md bg-white hover:bg-blue-100 transition-all duration-200 border-2 border-blue-200';
                    if (cat.name === selectedCategory) {
                        btn.classList.add('bg-blue-500','text-white','border-blue-500');
                    }
                    btn.innerHTML = `<span class="text-3xl mb-1">${cat.icon}</span><span class="text-xs font-bold">${cat.name}</span>`;
                    btn.onclick = () => {
                        selectedCategory = cat.name;
                        renderVideoCategories();
                        renderGlanceVideos();
                    };
                    catBar.appendChild(btn);
                });
            }

            function renderGlanceVideos() {
                const container = document.getElementById('glance-videos-carousel');
                if (!container) return;
                container.innerHTML = '';
                // Busca apenas v√≠deos publicados no feed
                if (typeof posts !== 'undefined' && Array.isArray(posts)) {
                    let videoPosts = posts.filter(p => p.type === 'video');
                    // Coletar todas as categorias √∫nicas
                    const allCategories = Array.from(new Set(videoPosts.map(p => p.category || 'Outro')));
                    // Renderizar categorias
                    const catBar = document.getElementById('glance-videos-categories');
                    if (catBar) {
                        catBar.innerHTML = `<button class='cat-btn px-4 py-2 rounded-full font-semibold mr-2 ${selectedCategory==='Todos'?'bg-blue-500 text-white':'bg-gray-200'}' data-cat='Todos'>Todos</button>` +
                            allCategories.map(cat => `<button class='cat-btn px-4 py-2 rounded-full font-semibold mr-2 ${selectedCategory===cat?'bg-blue-500 text-white':'bg-gray-200'}' data-cat='${cat}'>${cat}</button>`).join('');
                        catBar.querySelectorAll('.cat-btn').forEach(btn => {
                            btn.onclick = () => {
                                selectedCategory = btn.getAttribute('data-cat');
                                renderGlanceVideos();
                            };
                        });
                    }
                    if (selectedCategory !== 'Todos') {
                        videoPosts = videoPosts.filter(p => (p.category || 'Outro') === selectedCategory);
                    }
                    videoPosts.forEach((post, idx) => {
                        const div = document.createElement('div');
                        div.className = 'snap-center flex-shrink-0 w-[320px] h-[40vh] flex flex-col items-center justify-center bg-black rounded-2xl shadow-xl relative';
                        div.innerHTML = `
                            <div class="absolute top-3 left-4 right-4 bg-black/70 rounded-xl p-2 flex items-center justify-between z-10">
                                <h3 class="text-lg font-bold text-white">${(users[post.user]?.name && users[post.user]?.name !== '@usuario_glance') ? users[post.user].name : '@'+(users[post.user]?.username || post.user)}</h3>
                                <button class="glance-mute-btn ml-2 bg-white/80 hover:bg-blue-100 text-blue-700 rounded-full p-2 shadow-lg z-50 flex items-center justify-center" title="Ativar/desativar som" style="outline:none;border:none;">
                                    <span class="glance-mute-icon"></span>
                                </button>
                            </div>
                            <video src="${post.media}" controls autoplay playsinline class="w-full h-full object-contain rounded-xl bg-black glance-carousel-video"></video>
                            <div class="absolute bottom-4 left-4 right-4 bg-black/60 rounded-xl p-3">
                                ${post.text && post.text.trim() ? `<p class="text-sm">${post.text}</p>` : ''}
                                <span class="inline-block mt-2 px-3 py-1 rounded-full bg-blue-200 text-blue-800 text-xs font-bold">${post.category || 'Outro'}</span>
                            </div>
                        `;
                        // Open fullscreen modal on click
                        div.onclick = function(e) {
                            if (e.target.tagName.toLowerCase() === 'video') {
                                showGlanceVideoModal(idx, videoPosts);
                            }
                        };
                        // Mute button logic
                        setTimeout(() => {
                            const video = div.querySelector('.glance-carousel-video');
                            const muteBtn = div.querySelector('.glance-mute-btn');
                            const muteIcon = div.querySelector('.glance-mute-icon');
                            function updateMuteIcon() {
                                if (video.muted || video.volume === 0) {
                                    muteIcon.innerHTML = `<svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor' class='w-6 h-6'><path stroke='currentColor' stroke-width='2' d='M9 9v6h4l5 5V4l-5 5H9z' /><line x1='19' y1='5' x2='5' y2='19' stroke='red' stroke-width='2'/></svg>`;
                                } else {
                                    muteIcon.innerHTML = `<svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor' class='w-6 h-6'><path stroke='currentColor' stroke-width='2' d='M9 9v6h4l5 5V4l-5 5H9z' /></svg>`;
                                }
                            }
                            video.muted = false;
                            video.volume = 1;
                            video.play();
                            updateMuteIcon();
                            muteBtn.onclick = function(ev) {
                                ev.stopPropagation();
                                video.muted = !video.muted;
                                updateMuteIcon();
                            };
                            video.onvolumechange = updateMuteIcon;
                        }, 0);
                        container.appendChild(div);
                    });
                    // Reproduz apenas o v√≠deo mais central/vis√≠vel
                    function playCenterVideo() {
                        const videos = Array.from(container.querySelectorAll('.glance-carousel-video'));
                        let centerIdx = 0;
                        let minDist = Infinity;
                        const containerRect = container.getBoundingClientRect();
                        const containerCenter = containerRect.left + containerRect.width / 2;
                        videos.forEach((vid, i) => {
                            const rect = vid.getBoundingClientRect();
                            const videoCenter = rect.left + rect.width / 2;
                            const dist = Math.abs(videoCenter - containerCenter);
                            if (dist < minDist) {
                                minDist = dist;
                                centerIdx = i;
                            }
                        });
                        videos.forEach((vid, i) => {
                            if (i === centerIdx) {
                                vid.muted = false;
                                vid.volume = 1;
                                vid.play();
                            } else {
                                vid.pause();
                            }
                        });
                    }
                    setTimeout(() => {
                        playCenterVideo();
                        container.addEventListener('scroll', () => {
                            playCenterVideo();
                        });
                        window.addEventListener('resize', () => {
                            playCenterVideo();
                        });
                    }, 100);
// Fullscreen modal for Glance Videos with swipe navigation
function showGlanceVideoModal(startIdx, videoPosts) {
    let oldModal = document.getElementById('glance-video-modal');
    if (oldModal) oldModal.remove();
    let currentIdx = startIdx;
    function renderModal(idx) {
        const post = videoPosts[idx];
        let modal = document.getElementById('glance-video-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'glance-video-modal';
            modal.className = 'fixed inset-0 z-[9999] flex items-center justify-center bg-black/95';
            document.body.appendChild(modal);
        }
        // Antes de criar o v√≠deo do modal, pausar e silenciar todos os √°udios e v√≠deos existentes
        // E remover o v√≠deo do feed que estava tocando para garantir que o √°udio n√£o persista
        // Pausa e remove o v√≠deo do feed correspondente √† mesma postagem
        // O src do v√≠deo do modal ser√° igual ao post.media
        document.querySelectorAll('.feed-video').forEach(v => {
            if (v.src === post.media || v.currentSrc === post.media || v.getAttribute('src') === post.media) {
                try {
                    v.currentTime = 0;
                    v.pause();
                    v.muted = true;
                    v.removeAttribute('autoplay');
                } catch(e){}
            }
        });

        // Remove o v√≠deo do modal se j√° existir (para garantir que n√£o h√° √°udio "preso")
        let oldModalVideo = modal.querySelector('#glance-modal-video');
        if (oldModalVideo) {
            oldModalVideo.pause();
            oldModalVideo.src = '';
            oldModalVideo.load();
            oldModalVideo.remove();
        }

        // Agora cria o HTML do modal normalmente
        modal.innerHTML = `
            <button id='close-glance-video-modal' class='absolute top-4 left-4 bg-white/80 hover:bg-blue-100 text-blue-700 rounded-full p-2 shadow-lg z-50'>
                <svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor' class='w-7 h-7'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 19l-7-7 7-7' /></svg>
            </button>
            <button id='glance-video-sound-btn' class='absolute top-4 right-4 bg-white/80 hover:bg-blue-100 text-blue-700 rounded-full p-2 shadow-lg z-50 flex items-center justify-center' title='Ativar/desativar som'>
                <span id='glance-video-sound-icon'></span>
            </button>
            <div class='flex flex-col items-center justify-center w-full h-full'>
                <video id='glance-modal-video' src='${post.media}' controls autoplay playsinline style='width:100vw;max-width:420px;height:80vh;max-height:80vh;aspect-ratio:9/16;display:block;margin:auto;background:black;' class='rounded-xl object-contain'></video>
                ${(post.text && post.text.trim()) ? `<div class='w-full max-w-md mt-4 px-4'><h2 class='text-xl font-bold mb-2 text-center text-white'>${(users[post.user]?.name && users[post.user]?.name !== '@usuario_glance') ? users[post.user].name : '@'+(users[post.user]?.username || post.user)}</h2><p class='text-base text-white mb-2'>${post.text}</p></div>` : ''}
            </div>
        `;
        // Sound toggle logic
        const vid = modal.querySelector('#glance-modal-video');
        const soundBtn = modal.querySelector('#glance-video-sound-btn');
        const soundIcon = modal.querySelector('#glance-video-sound-icon');
        function updateSoundIcon() {
            if (vid.muted || vid.volume === 0) {
                soundIcon.innerHTML = `<svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor' class='w-7 h-7'><path stroke='currentColor' stroke-width='2' d='M9 9v6h4l5 5V4l-5 5H9z' /><line x1='19' y1='5' x2='5' y2='19' stroke='red' stroke-width='2'/></svg>`;
            } else {
                soundIcon.innerHTML = `<svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor' class='w-7 h-7'><path stroke='currentColor' stroke-width='2' d='M9 9v6h4l5 5V4l-5 5H9z' /></svg>`;
            }
        }
        vid.currentTime = 0;
        vid.muted = false;
        vid.volume = 1;
        vid.play();
        updateSoundIcon();
        soundBtn.onclick = function(e) {
            e.stopPropagation();
            vid.muted = !vid.muted;
            updateSoundIcon();
        };
        vid.onvolumechange = updateSoundIcon;
        // Close modal
        document.getElementById('close-glance-video-modal').onclick = () => {
            modal.remove();
            // For√ßa reload completo da p√°gina para garantir que nada fique tocando
            setTimeout(() => { window.location.reload(); }, 100);
        };
    // No visible prev/next buttons: navigation only by swipe or keyboard
        // Keyboard navigation
        modal.tabIndex = 0;
        modal.focus();
        modal.onkeydown = function(e) {
            if (e.key === 'ArrowLeft') {
                if (currentIdx > 0) { currentIdx--; renderModal(currentIdx); }
            } else if (e.key === 'ArrowRight') {
                if (currentIdx < videoPosts.length - 1) { currentIdx++; renderModal(currentIdx); }
            } else if (e.key === 'Escape') {
                modal.remove();
            }
        };
        // Swipe navigation (touch and mouse)
        let startX = null;
        let isMouseDown = false;
        // Touch events
        modal.ontouchstart = function(e) {
            if (e.touches.length === 1) startX = e.touches[0].clientX;
        };
        modal.ontouchend = function(e) {
            if (startX !== null && e.changedTouches.length === 1) {
                let dx = e.changedTouches[0].clientX - startX;
                if (dx > 60 && currentIdx > 0) { currentIdx--; renderModal(currentIdx); }
                else if (dx < -60 && currentIdx < videoPosts.length - 1) { currentIdx++; renderModal(currentIdx); }
            }
            startX = null;
        };
        // Mouse events for swipe on PC
        modal.onmousedown = function(e) {
            if (e.button === 0) { // left mouse button only
                isMouseDown = true;
                startX = e.clientX;
            }
        };
        modal.onmouseup = function(e) {
            if (isMouseDown && startX !== null) {
                let dx = e.clientX - startX;
                if (dx > 60 && currentIdx > 0) { currentIdx--; renderModal(currentIdx); }
                else if (dx < -60 && currentIdx < videoPosts.length - 1) { currentIdx++; renderModal(currentIdx); }
            }
            isMouseDown = false;
            startX = null;
        };
        modal.onmouseleave = function(e) {
            isMouseDown = false;
            startX = null;
        };
        // Ensure only this video plays
        setTimeout(() => {
            if (vid) {
                vid.muted = false;
                vid.volume = 1;
                vid.play();
                updateSoundIcon();
            }
        }, 100);
    }
    renderModal(currentIdx);
}
                }
            }
            // Garante renderiza√ß√£o ao abrir a aba
            window._oldShowPage = window._oldShowPage || window.showPage;
            window.showPage = function(page) {
                // Se est√° saindo da aba de v√≠deos, pausa todos os v√≠deos do carrossel
                const activePage = document.querySelector('.page.active');
                if (activePage && activePage.dataset.page === 'communities') {
                    const videos = document.querySelectorAll('#glance-videos-carousel video');
                    videos.forEach(v => { v.pause(); v.currentTime = 0; });
                }
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                const el = document.querySelector(`[data-page="${page}"]`);
                if (el) el.classList.add('active');
                if (page === 'communities') {
                    setTimeout(() => {
                        renderVideoCategories();
                        renderGlanceVideos();
                        const catBar = document.getElementById('glance-videos-categories');
                        if (catBar) catBar.style.display = '';
                    }, 0);
                } else {
                    const catBar = document.getElementById('glance-videos-categories');
                    if (catBar) catBar.style.display = 'none';
                }
                if (page === 'explore' && typeof window.setupExplorePeopleBtn === 'function') {
                    setTimeout(window.setupExplorePeopleBtn, 0);
                }
                if (window._oldShowPage) window._oldShowPage(page);
            };
            </script>
        </div>

        <!-- Tela Principal - Perfil -->
        <div data-page="profile" class="page flex-col p-4 pt-16 h-full scroll-container">
            <div class="flex flex-col items-center mb-6">
                <button id="logout-btn" class="mb-4 py-2 px-6 bg-red-500 text-white font-semibold rounded-xl shadow hover:bg-red-600 transition-all duration-200 self-end">Sair</button>
                <div id="follow-profile-container" class="w-full flex justify-end mb-2"></div>
                <!-- √çcone de mensagem ao lado do bot√£o de seguir -->
                <div id="profile-message-btn-container" class="flex items-center justify-end gap-2 mb-2"></div>
                <div class="relative">
                        <!-- √çcone de mensagens -->
                        <button id="feed-messages-btn" title="Mensagens" class="p-2 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors duration-200 flex items-center justify-center absolute right-0 top-0" style="z-index:20;">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8s-9-3.582-9-8a9 9 0 1118 0z" /></svg>
                        </button>
                        <div id="profile-avatar-overlay" class="hidden fixed inset-0 z-[300] bg-black bg-opacity-90 flex items-center justify-center">
                            <img id="profile-avatar-full" src="" class="max-w-full max-h-full rounded-2xl shadow-2xl" />
                        </div>
                        <!-- Modal de Crop da foto de perfil -->
                        <div id="profile-cropper-modal" class="hidden fixed inset-0 z-[400] bg-black bg-opacity-80 flex items-center justify-center">
                            <div class="bg-white rounded-xl p-4 flex flex-col items-center">
                                <div style="width:300px;height:300px;max-width:90vw;max-height:60vh;">
                                    <img id="profile-cropper-img" style="max-width:100%;max-height:100%;display:block;" />
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <button id="cropper-cancel-btn" class="py-2 px-4 bg-gray-400 text-white rounded">Cancelar</button>
                                    <button id="cropper-save-btn" class="py-2 px-4 bg-blue-600 text-white rounded">Recortar e Salvar</button>
                                </div>
                            </div>
                        </div>
                        <div style="position:relative;display:inline-block;">
                            <div id="profile-avatar-color-border" class="w-32 h-32 rounded-full border-4 shadow-lg flex items-center justify-center mb-4 overflow-hidden">
                                <img id="profile-avatar" class="w-full h-full object-cover rounded-full cursor-pointer" />
                            </div>
                            <span id="profile-online-indicator" style="position:absolute;top:0;left:0;width:20px;height:20px;background:#22c55e;border:3px solid #fff;border-radius:50%;display:block;z-index:10;"></span>
                        </div>
                        <button id="upload-btn" onclick="document.getElementById('file-upload').click()" class="absolute bottom-0 right-0 p-2 rounded-full bg-black dark:bg-white text-white dark:text-black hidden">
                            <!-- √çcone de c√¢mera/upload -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.808-1.212A2 2 0 0110.45 2h3.1a2 2 0 011.664.89l.808 1.212A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                        <input type="file" id="file-upload" class="hidden" accept="image/*" />
                <script>
                // Cropper.js integra√ß√£o para foto de perfil
                let cropper = null;
                const fileInput = document.getElementById('file-upload');
                const cropperModal = document.getElementById('profile-cropper-modal');
                const cropperImg = document.getElementById('profile-cropper-img');
                const cropperCancel = document.getElementById('cropper-cancel-btn');
                const cropperSave = document.getElementById('cropper-save-btn');
                const profileAvatarCrop = document.getElementById('profile-avatar');
                if (fileInput && cropperModal && cropperImg && cropperCancel && cropperSave && profileAvatarCrop) {
                    fileInput.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = function(evt) {
                            cropperImg.src = evt.target.result;
                            cropperModal.classList.remove('hidden');
                            if (cropper) { cropper.destroy(); cropper = null; }
                            setTimeout(() => {
                                cropper = new Cropper(cropperImg, {
                                    aspectRatio: 1,
                                    viewMode: 1,
                                    autoCropArea: 1,
                                    minCropBoxWidth: 100,
                                    minCropBoxHeight: 100,
                                });
                            }, 100);
                        };
                        reader.readAsDataURL(file);
                    });
                    cropperCancel.onclick = function() {
                        cropperModal.classList.add('hidden');
                        if (cropper) { cropper.destroy(); cropper = null; }
                        fileInput.value = '';
                    };
                    cropperSave.onclick = function() {
                        if (!cropper) return;
                        // Recorta e redimensiona para 512x512
                        const canvas = cropper.getCroppedCanvas({ width: 512, height: 512, imageSmoothingQuality: 'high' });
                        canvas.toBlob(function(blob) {
                            const url = URL.createObjectURL(blob);
                            profileAvatarCrop.src = url;
                            // Aqui voc√™ pode salvar o blob na estrutura de usu√°rio, se necess√°rio
                            cropperModal.classList.add('hidden');
                            if (cropper) { cropper.destroy(); cropper = null; }
                            fileInput.value = '';
                        }, 'image/png');
                    };
                }
                </script>
                </div>
    <!-- Modal global para exibir avatar em tela cheia -->
    <div id="profile-avatar-overlay" class="hidden fixed inset-0 z-[300] bg-black bg-opacity-90 flex items-center justify-center">
        <img id="profile-avatar-full" src="" class="max-w-full max-h-full rounded-2xl shadow-2xl" />
    </div>
                <div class="w-full max-w-xs space-y-4 text-center text-black dark:text-white">
                    <h2 id="profile-realname" class="text-3xl font-bold"></h2>
                    <p id="profile-username" class="text-lg font-semibold text-gray-800 dark:text-gray-200"></p>
                    <p class="text-sm text-gray-600 dark:text-gray-400" id="profile-bio">Um olhar para o mundo da tecnologia.</p>
                    <div class="flex justify-center space-x-6 mt-4">
                        <div class="text-center px-3 py-2 rounded-xl bg-white/30 dark:bg-black/30 backdrop-blur-md shadow-md border border-gray-200 dark:border-gray-700">
                            <p id="profile-posts-count" class="font-bold">0</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Publica√ß√µes</p>
                        </div>
                        <div class="text-center px-3 py-2 rounded-xl bg-white/30 dark:bg-black/30 backdrop-blur-md shadow-md border border-gray-200 dark:border-gray-700">
                            <p id="profile-followers-count" class="font-bold">0</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Seguidores</p>
                        </div>
                        <div class="text-center px-3 py-2 rounded-xl bg-white/30 dark:bg-black/30 backdrop-blur-md shadow-md border border-gray-200 dark:border-gray-700">
                            <p id="profile-following-count" class="font-bold">0</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Seguindo</p>
                        </div>
                    </div>
                    <button id="edit-profile-btn" class="py-2 px-6 rounded-full border border-gray-400 dark:border-gray-600 text-sm font-semibold hover:bg-black hover:text-white dark:hover:bg-white dark:hover:text-black transition-colors duration-200">
                        Editar Perfil
                    </button>
                    <button id="play-snake-btn" class="ml-2 py-2 px-6 rounded-full border border-green-400 text-sm font-semibold bg-green-500 text-white hover:bg-green-600 transition-colors duration-200">Jogar</button>
                    <button id="premium-btn" class="ml-2 py-2 px-6 rounded-full border border-yellow-400 text-sm font-semibold bg-yellow-400 text-white hover:bg-yellow-500 transition-colors duration-200 hidden">Assinar Premium</button>
                    <!-- Premium Modal -->
                    <div id="premium-modal" class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-80">
                        <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl p-0 max-w-2xl w-full flex flex-col items-center relative overflow-hidden">
                            <button id="close-premium-modal" class="absolute top-4 right-4 bg-gray-200 hover:bg-red-400 text-black rounded-full px-4 py-2 font-bold z-10">&times;</button>
                            <div class="w-full flex flex-col md:flex-row">
                                <div class="flex-1 p-8 flex flex-col justify-center items-start border-b md:border-b-0 md:border-r border-gray-200 dark:border-gray-700">
                                    <h2 class="text-3xl font-extrabold mb-4 text-yellow-500 text-left">Assinatura Premium</h2>
                                    <ul class="text-black dark:text-white mb-4 list-disc pl-6 text-base space-y-2">
                                        <li><b>Selo premium</b> no perfil</li>
                                        <li>Acesso antecipado a novidades</li>
                                        <li>Suporte priorit√°rio</li>
                                        <li>Mais vantagens em breve!</li>
                                    </ul>
                                    <div class="mt-4 text-gray-500 text-xs">Escolha o m√©todo de pagamento:</div>
                                </div>
                                <div class="flex-1 p-8 flex flex-col gap-6 justify-center items-center">
                                    <button id="premium-whatsapp-btn" class="w-full py-4 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl flex items-center justify-center gap-3 text-lg shadow-lg transition-all duration-200">
                                        <svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor' class='w-7 h-7'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M16.72 13.06a6.5 6.5 0 10-2.72 2.72l2.85.71a1 1 0 001.21-1.21l-.71-2.85z' /></svg>
                                        <span class="flex flex-col items-start"><span>Pagar 320MZN</span><span class="text-xs font-normal">via WhatsApp</span></span>
                                    </button>
                                    <button id="premium-paypal-btn" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl flex items-center justify-center gap-3 text-lg shadow-lg transition-all duration-200">
                                        <svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor' class='w-7 h-7'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M4 17v1a3 3 0 003 3h10a3 3 0 003-3v-1' /></svg>
                                        <span class="flex flex-col items-start"><span>Pagar 5$</span><span class="text-xs font-normal">via PayPal (WhatsApp)</span></span>
                                    </button>
                                    <div class="mt-4 text-gray-400 text-xs text-center">Ap√≥s o pagamento, envie o comprovativo para ativa√ß√£o imediata.</div>
                                </div>
                            </div>
                        </div>
                    </div>
        <script>
        // Premium Modal logic
        document.addEventListener('DOMContentLoaded', function() {
            var premiumBtn = document.getElementById('premium-btn');
            var premiumModal = document.getElementById('premium-modal');
            var closePremiumModal = document.getElementById('close-premium-modal');
            if (premiumBtn && premiumModal && closePremiumModal) {
                premiumBtn.onclick = function() {
                    premiumModal.classList.remove('hidden');
                };
                closePremiumModal.onclick = function() {
                    premiumModal.classList.add('hidden');
                };
                // Close modal on ESC
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') premiumModal.classList.add('hidden');
                });
                // WhatsApp and PayPal payment logic
                var whatsappBtn = document.getElementById('premium-whatsapp-btn');
                var paypalBtn = document.getElementById('premium-paypal-btn');
                if (whatsappBtn) {
                    whatsappBtn.onclick = function() {
                        var phone = '258864813115';
                        var msg = encodeURIComponent('Ol√°! Quero pagar o pacote premium de 320MZN.');
                        var url = 'https://wa.me/' + phone + '?text=' + msg;
                        window.open(url, '_blank');
                    };
                }
                if (paypalBtn) {
                    paypalBtn.onclick = function() {
                        var phone = '258864813115';
                        var msg = encodeURIComponent('Ol√°! Quero pagar o pacote premium via PayPal. Por favor, envie sua conta PayPal.');
                        var url = 'https://wa.me/' + phone + '?text=' + msg;
                        window.open(url, '_blank');
                    };
                }
            }
        });
        </script>
                        <!-- Snake Game Modal -->
                        <div id="snake-modal" class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-90">
                            <div class="w-full h-full flex flex-col items-center justify-center relative">
                                <button id="close-snake-modal" class="absolute top-4 right-6 bg-gray-200 hover:bg-red-400 text-black rounded-full px-4 py-2 font-bold z-10">&times;</button>
                                <h2 class="text-3xl font-bold mb-4 text-center text-white drop-shadow-lg z-10">Snake Game</h2>
                                <canvas id="snake-canvas" width="640" height="640" class="border-4 border-green-400 rounded-lg bg-black shadow-2xl mb-6" style="max-width:90vw;max-height:70vh;"></canvas>
                                <div id="snake-game-over" class="hidden flex flex-col items-center z-10">
                                    <span class="text-2xl font-bold text-red-500 mb-4">Game Over!</span>
                                    <button id="snake-restart-btn" class="py-3 px-8 bg-green-500 text-white rounded-lg font-semibold text-lg">Restart</button>
                                </div>
                            </div>
                        </div>
                </div>
            </div>

            <!-- Formul√°rio de Edi√ß√£o (Modal em tela cheia, inicialmente oculto) -->
            <div id="edit-profile-form" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80">
                <div class="w-full max-w-md bg-white dark:bg-gray-900 rounded-2xl p-8 space-y-6 shadow-2xl flex flex-col items-center overflow-y-auto max-h-[90vh]">
                    <h2 class="text-2xl font-bold mb-2 text-center text-black dark:text-white">Editar Perfil</h2>
                    <!-- Foto de Perfil removida -->
                    <input type="text" id="edit-realname" placeholder="Nome completo" class="w-full p-3 rounded-xl border-2 border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200" />
                    <input type="text" id="edit-username" placeholder="Novo nome de usu√°rio" class="w-full p-3 rounded-xl border-2 border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200" />
                    <textarea id="edit-bio" placeholder="Nova biografia" rows="6" class="w-full min-h-[120px] p-3 rounded-xl border-2 border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200 resize-y"></textarea>
                    <input type="date" id="edit-birthdate" class="w-full p-3 rounded-xl border-2 border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200" />
                    <!-- Localiza√ß√£o removida -->
                    <select id="edit-gender" class="w-full p-3 rounded-xl border-2 border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                        <option value="">G√™nero</option>
                        <option value="masculino">Masculino</option>
                        <option value="feminino">Feminino</option>
                        <option value="outro">Outro</option>
                        <option value="nao_informar">Prefiro n√£o informar</option>
                    </select>
                    <!-- Interesses removido -->
                    <button id="save-profile-btn" class="w-full py-3 bg-blue-500 text-white font-semibold rounded-2xl">Salvar</button>
                </div>
            </div>
            
            <!-- Grid de postagens do perfil -->
            <div id="profile-posts-grid" class="grid grid-cols-2 gap-4 mt-8 w-full max-w-md mx-auto justify-items-center items-center">
                <!-- Posts do perfil ser√£o inseridos aqui pelo JavaScript -->
            </div>
        </div>

        <!-- Navega√ß√£o Principal (Menu Base) -->
        <div id="main-nav" class="fixed bottom-0 left-0 w-full bg-white/30 dark:bg-black/30 border-t-2 border-gray-200 dark:border-gray-800 rounded-t-3xl shadow-2xl backdrop-blur-xl transition-all duration-300 z-50" style="display:none;">
            <div class="flex justify-around items-center h-16">
                <div class="flex flex-wrap justify-between items-center w-full">
                    <button onclick="showPage('feed')" class="nav-btn p-2 m-1 rounded-full bg-white dark:bg-white hover:bg-blue-100 transition-colors duration-200 shadow-lg min-w-[48px] max-w-[80px] flex-1 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                    </button>
                    <button onclick="showPage('explore')" class="nav-btn p-2 m-1 rounded-full bg-white dark:bg-white hover:bg-blue-100 transition-colors duration-200 shadow-lg min-w-[48px] max-w-[80px] flex-1 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-7 h-7"><circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none"/><line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2"/></svg>
                    </button>
                    <button onclick="showPage('create')" class="nav-btn p-2 m-1 rounded-full bg-white dark:bg-white hover:bg-blue-100 transition-colors duration-200 shadow-lg min-w-[48px] max-w-[80px] flex-1 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-7 h-7"><line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2"/><line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2"/></svg>
                    </button>
                    <button onclick="showPage('communities')" class="nav-btn p-2 m-1 rounded-full bg-white dark:bg-white hover:bg-blue-100 transition-colors duration-200 shadow-lg min-w-[48px] max-w-[80px] flex-1 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-7 h-7"><circle cx="12" cy="12" r="7" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="8.5" cy="10.5" r="1.5" fill="currentColor"/><circle cx="15.5" cy="10.5" r="1.5" fill="currentColor"/><path d="M8 16c1.333-1 4.667-1 6 0" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                    </button>
                    <button onclick="showPage('profile')" class="nav-btn p-2 m-1 rounded-full bg-white dark:bg-white hover:bg-blue-100 transition-colors duration-200 shadow-lg min-w-[48px] max-w-[80px] flex-1 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-7 h-7"><circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="2" fill="none"/><path d="M4 20c0-2.667 5.333-4 8-4s8 1.333 8 4" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                    </button>
                </div>
            </div>
        </div>
        <script>
            // SNAKE GAME LOGIC
            (function() {
                let modal, canvas, ctx, box = 40, snake, direction, food, score, interval, gameOver, gridSize = 16;
                function getHighScore() {
                    return parseInt(localStorage.getItem('snakeHighScore') || '0', 10);
                }
                function setHighScore(val) {
                    localStorage.setItem('snakeHighScore', val);
                }
                function resetGame() {
                    snake = [{x: 8, y: 8}];
                    direction = 'RIGHT';
                    food = {x: Math.floor(Math.random()*gridSize), y: Math.floor(Math.random()*gridSize)};
                    score = 0;
                    gameOver = false;
                    document.getElementById('snake-game-over').classList.add('hidden');
                }
                function draw() {
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0,0,canvas.width,canvas.height);
                    // Draw snake
                    for (let i=0; i<snake.length; i++) {
                        ctx.fillStyle = i===0 ? '#22c55e' : '#4ade80';
                        ctx.fillRect(snake[i].x*box, snake[i].y*box, box-2, box-2);
                    }
                    // Draw food
                    ctx.fillStyle = '#f87171';
                    ctx.fillRect(food.x*box, food.y*box, box-2, box-2);
                    // Draw score and high score
                    ctx.fillStyle = '#fff';
                    ctx.font = '24px Arial';
                    ctx.fillText('Score: '+score, 16, 36);
                    ctx.fillText('Recorde: '+getHighScore(), 16, 66);
                }
                function move() {
                    if (gameOver) return;
                    let head = {x: snake[0].x, y: snake[0].y};
                    if (direction==='LEFT') head.x--;
                    if (direction==='RIGHT') head.x++;
                    if (direction==='UP') head.y--;
                    if (direction==='DOWN') head.y++;
                    // Wall or self collision
                    if (head.x<0||head.x>=gridSize||head.y<0||head.y>=gridSize||snake.some((s,i)=>i>0&&s.x===head.x&&s.y===head.y)) {
                        gameOver = true;
                        clearInterval(interval);
                        // Update high score if needed
                        if (score > getHighScore()) setHighScore(score);
                        document.getElementById('snake-game-over').classList.remove('hidden');
                        draw(); // Redraw to update high score
                        return;
                    }
                    snake.unshift(head);
                    if (head.x===food.x && head.y===food.y) {
                        score++;
                        food = {x: Math.floor(Math.random()*gridSize), y: Math.floor(Math.random()*gridSize)};
                    } else {
                        snake.pop();
                    }
                    draw();
                }
                function startGame() {
                    resetGame();
                    draw();
                    clearInterval(interval);
                    interval = setInterval(move, 180); // SLOWER SPEED
                }
                function showModal() {
                    modal.classList.remove('hidden');
                    // Resize canvas to fit fullscreen
                    setTimeout(() => {
                        let size = Math.min(window.innerWidth, window.innerHeight) * 0.8;
                        size = Math.max(320, Math.min(size, 640));
                        canvas.width = canvas.height = size;
                        box = Math.floor(size / gridSize);
                        draw();
                    }, 50);
                    startGame();
                }
                function hideModal() {
                    modal.classList.add('hidden');
                    clearInterval(interval);
                }
                window.addEventListener('resize', function() {
                    if (!modal || modal.classList.contains('hidden')) return;
                    let size = Math.min(window.innerWidth, window.innerHeight) * 0.8;
                    size = Math.max(320, Math.min(size, 640));
                    canvas.width = canvas.height = size;
                    box = Math.floor(size / gridSize);
                    draw();
                });
                document.addEventListener('DOMContentLoaded', function() {
                    modal = document.getElementById('snake-modal');
                    canvas = document.getElementById('snake-canvas');
                    ctx = canvas.getContext('2d');
                    document.getElementById('play-snake-btn')?.addEventListener('click', showModal);
                    document.getElementById('close-snake-modal')?.addEventListener('click', hideModal);
                    document.getElementById('snake-restart-btn')?.addEventListener('click', startGame);
                    document.addEventListener('keydown', function(e) {
                        if (!modal || modal.classList.contains('hidden')) return;
                        if (['ArrowLeft','a','A'].includes(e.key) && direction!=='RIGHT') direction='LEFT';
                        else if (['ArrowUp','w','W'].includes(e.key) && direction!=='DOWN') direction='UP';
                        else if (['ArrowRight','d','D'].includes(e.key) && direction!=='LEFT') direction='RIGHT';
                        else if (['ArrowDown','s','S'].includes(e.key) && direction!=='UP') direction='DOWN';
                    });
                });
            })();
        // Exibe o menu inferior apenas ap√≥s login
        document.addEventListener('DOMContentLoaded', function() {
            function toggleMainNav(page) {
                var nav = document.getElementById('main-nav');
                if (!nav) return;
                // Mostra apenas nas p√°ginas principais
                if (["feed","profile","explore","create","communities"].includes(page)) {
                    nav.style.display = '';
                } else {
                    nav.style.display = 'none';
                }
            }
            // Hook no showPage
            var _oldShowPage = window.showPage;
            window.showPage = function(page) {
                toggleMainNav(page);
                if (_oldShowPage) _oldShowPage(page);
            };
            // Adiciona bot√£o de mensagem privada ao entrar no perfil de outro usu√°rio
            window._oldShowPage = window._oldShowPage || window.showPage;
            const _showPage = window.showPage;
            window.showPage = function(page) {
                if (_showPage) _showPage(page);
                if (page === 'profile') {
                    setTimeout(() => {
                        const msgBtnContainer = document.getElementById('profile-message-btn-container');
                        if (msgBtnContainer) {
                            msgBtnContainer.innerHTML = '';
                            // S√≥ mostra se n√£o for o pr√≥prio perfil
                            if (window.viewingProfileUser && window.loggedInUser && window.viewingProfileUser !== window.loggedInUser) {
                                const btn = document.createElement('button');
                                btn.id = 'start-private-message-btn';
                                btn.className = 'flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-2xl shadow hover:bg-blue-600 transition';
                                btn.innerHTML = `<svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor' class='w-6 h-6'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z' /></svg> Mensagem`;
                                btn.onclick = function() {
                                    if (typeof startPrivateMessage === 'function') {
                                        startPrivateMessage(window.viewingProfileUser);
                                    } else {
                                        alert('Fun√ß√£o de mensagem privada n√£o implementada.');
                                    }
                                };
                                msgBtnContainer.appendChild(btn);
                            }
                        }
                    }, 100);
                }
            };
            // Fun√ß√£o stub para iniciar mensagem privada
            window.startPrivateMessage = window.startPrivateMessage || function(userId) {
                showMessageBox('Iniciar mensagem privada com ' + (users[userId]?.name || userId));
            };
            // Inicializa correto ao carregar
            var active = document.querySelector('.page.active');
            if (active && active.dataset.page) toggleMainNav(active.dataset.page);
        });
        </script>
        
        <!-- Caixa de mensagem (substitui 'alert') -->
    <div id="message-box" class="fixed inset-0 z-[99999] hidden items-center justify-center p-4 bg-black/70 backdrop-blur-sm transition-opacity duration-300 opacity-0">
            <div class="bg-white dark:bg-gray-900 text-black dark:text-white rounded-xl p-6 shadow-2xl max-w-xs text-center transform scale-95 transition-transform duration-300">
                <span id="message-text"></span>
                <button onclick="hideMessageBox()" class="mt-4 py-2 px-6 bg-blue-500 text-white rounded-lg font-semibold">Ok</button>
            </div>
        </div>
    </div>

        <script>
        // Corrige o bot√£o Editar Perfil para abrir o formul√°rio
        document.addEventListener('DOMContentLoaded', function() {
            var editBtn = document.getElementById('edit-profile-btn');
            var editForm = document.getElementById('edit-profile-form');
            if (editBtn && editForm) {
                editBtn.onclick = function() {
                    editForm.classList.remove('hidden');
                };
            }
            // Fecha o formul√°rio ao clicar fora ou pressionar ESC
            editForm?.addEventListener('click', function(e) {
                if (e.target === editForm) editForm.classList.add('hidden');
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') editForm?.classList.add('hidden');
            });
        });
        // Dados fict√≠cios para os usu√°rios
        const users = {
            "usuario_glance": {
                username: "usuario_glance",
                name: "@usuario_glance",
                bio: "Um olhar para o mundo da tecnologia.",
                avatar: "https://placehold.co/150x150/A0B2C3/FFFFFF?text=EU",
                posts: 0, // Inicia em 0, ser√° atualizado dinamicamente
                followers: 0,
                following: 0
            },
            "viajante_urbano": {
                username: "viajante_urbano",
                name: "Marina Costa",
                bio: "Viajando e explorando as cidades do mundo. Sempre em busca da pr√≥xima aventura.",
                avatar: "https://picsum.photos/200?random=1",
                posts: 0,
                followers: 0,
                following: 0
            },
            "arte_viva": {
                username: "arte_viva",
                name: "Jo√£o Pereira",
                bio: "Arteterapia para a alma. Meus quadros s√£o um reflexo do meu mundo interior.",
                avatar: "https://picsum.photos/200?random=2",
                posts: 0,
                followers: 0,
                following: 0
            },
            "tecnologo_futuro": {
                username: "tecnologo_futuro",
                name: "Ana Rodrigues",
                bio: "Entusiasta de novas tecnologias, IA e rob√≥tica. Construindo o futuro, um c√≥digo de cada vez.",
                avatar: "https://picsum.photos/200?random=3",
                posts: 0,
                followers: 0,
                following: 0
            },
            "sabores_do_mundo": {
                username: "sabores_do_mundo",
                name: "Carlos Souza",
                bio: "Explorando culin√°rias de todos os cantos do planeta. Receitas, dicas e del√≠cias!",
                avatar: "https://picsum.photos/200?random=4",
                posts: 0,
                followers: 0,
                following: 0
            },
            "musica_eterna": {
                username: "musica_eterna",
                name: "Beatriz Lima",
                bio: "A m√∫sica √© a trilha sonora da vida. Compartilhando minhas can√ß√µes favoritas e descobrindo novos artistas.",
                avatar: "https://picsum.photos/200?random=5",
                posts: 0,
                followers: 0,
                following: 0
            }
        };

        // Dados fict√≠cios para as publica√ß√µes (conectados aos usu√°rios acima)
        let posts = [
            {id: "post1", user: "viajante_urbano", type: "image", media: "https://picsum.photos/400/600?random=10", text: "Vista incr√≠vel do topo da montanha! A natureza √© a melhor artista.", reactions: { views: 0, likes: 0, shares: 0 }, timestamp: Date.now() - 1000 * 60 * 60 * 2},
            {id: "post2", user: "arte_viva", type: "video", media: "placeholder", text: "Come√ßando um novo projeto de arte abstrata. As cores est√£o fluindo!", reactions: { views: 0, likes: 0, shares: 0 }, timestamp: Date.now() - 1000 * 60 * 60 * 5},
            {id: "post3", user: "tecnologo_futuro", type: "image", media: "https://picsum.photos/400/600?random=11", text: "O futuro da IA est√° em constante evolu√ß√£o. Animado para o que vem por a√≠!", reactions: { views: 0, likes: 0, shares: 0 }, timestamp: Date.now() - 1000 * 60 * 60 * 24},
            {id: "post4", user: "sabores_do_mundo", type: "audio", media: "placeholder", text: "Tudo pronto para um jantar especial. A culin√°ria √© uma forma de arte.", reactions: { views: 0, likes: 0, shares: 0 }, timestamp: Date.now() - 1000 * 60 * 30},
            {id: "post5", user: "musica_eterna", type: "image", media: "https://picsum.photos/400/600?random=12", text: "Nada melhor que uma playlist relaxante para terminar o dia. Qual a sua favorita?", reactions: { views: 0, likes: 0, shares: 0 }, timestamp: Date.now() - 1000 * 60 * 60 * 12},
            {id: "post6", user: "usuario_glance", type: "image", media: "https://picsum.photos/400/600?random=13", text: "Meu primeiro post! Estou adorando o Glance!", reactions: { views: 0, likes: 0, shares: 0 }, timestamp: Date.now() - 1000 * 60 * 10},
            {id: "post7", user: "viajante_urbano", type: "image", media: "https://picsum.photos/400/600?random=14", text: "Conhecendo mais uma cidade incr√≠vel. Cada esquina uma nova hist√≥ria.", reactions: { views: 0, likes: 0, shares: 0 }, timestamp: Date.now() - 1000 * 60 * 60 * 3}
        ];
        // Controle de likes e coment√°rios por usu√°rio
        let userLikes = {};
    let userViews = {};

    // Fun√ß√£o para exibir h√° quanto tempo um post foi publicado
    function timeAgo(timestamp) {
        const now = Date.now();
        const diff = Math.floor((now - timestamp) / 1000); // segundos
        if (diff < 60) return 'agora mesmo';
        if (diff < 3600) return `${Math.floor(diff/60)} min atr√°s`;
        if (diff < 86400) return `${Math.floor(diff/3600)} h atr√°s`;
        if (diff < 2592000) return `${Math.floor(diff/86400)} d atr√°s`;
        return new Date(timestamp).toLocaleDateString();
    }
        let postComments = posts.map(() => []);

        // Vari√°vel de controle para o perfil do usu√°rio atual logado
        window.loggedInUser = "usuario_glance";

        // Fun√ß√£o para mostrar a caixa de mensagem personalizada
        function showMessageBox(message) {
            const messageBox = document.getElementById('message-box');
            document.getElementById('message-text').textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.remove('opacity-0');
                messageBox.querySelector('div').classList.remove('scale-95');
            }, 10);
        }

        // Fun√ß√£o para esconder a caixa de mensagem
        function hideMessageBox() {
            const messageBox = document.getElementById('message-box');
            messageBox.classList.add('opacity-0');
            messageBox.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 300);
        }
        
        // Exibe o modal de boas-vindas sobre o feed
        function showWelcomeModal() {
            const welcomeModal = document.querySelector('[data-page="welcome"]');
            if (welcomeModal) {
                welcomeModal.classList.add('active');
                welcomeModal.style.display = 'flex';
                // Garante que o bot√£o funciona
                const welcomeBtn = document.getElementById('welcome-understood-btn');
                if (welcomeBtn) {
                    welcomeBtn.onclick = function() {
                        welcomeModal.classList.remove('active');
                        welcomeModal.style.display = 'none';
                    };
                }
            }
        }
        // Intercepta cadastro para ir ao onboarding
        document.addEventListener('DOMContentLoaded', function() {
            // Valida√ß√£o absoluta: bloqueia submit se houver campo vazio
            function blockAllEmptyFormSubmits() {
                document.querySelectorAll('[data-page="signup_form"] form, [data-page="login_form"] form').forEach(form => {
                    form.addEventListener('submit', function(e) {
                        const inputs = form.querySelectorAll('input');
                        let valid = true;
                        inputs.forEach(input => {
                            if (!input.value.trim()) {
                                valid = false;
                                input.classList.add('border-red-500');
                            } else {
                                input.classList.remove('border-red-500');
                            }
                        });
                        if (!valid) {
                            if (typeof showMessageBox === 'function') {
                                showMessageBox('Preencha todos os campos para continuar.');
                            }
                            e.preventDefault();
                            e.stopPropagation();
                            return false;
                        }
                    }, true);
                });
            }
            blockAllEmptyFormSubmits();
            // Valida√ß√£o global para todos os formul√°rios de login/cadastro
            document.querySelectorAll('form').forEach(form => {
                if (form.closest('[data-page="signup_form"]') || form.closest('[data-page="login_form"]')) {
                    form.addEventListener('submit', function(e) {
                        const inputs = form.querySelectorAll('input');
                        let valid = true;
                        inputs.forEach(input => {
                            if (!input.value.trim()) {
                                valid = false;
                                input.classList.add('border-red-500');
                            } else {
                                input.classList.remove('border-red-500');
                            }
                        });
                        if (!valid) {
                            if (typeof showMessageBox === 'function') {
                                showMessageBox('Preencha todos os campos para continuar.');
                            }
                            e.preventDefault();
                            return false;
                        }
                    });
                }
            });

            // Ao cadastrar, j√° atualiza nome do perfil
            const signupForm = document.querySelector('[data-page="signup_form"] form');
            // (Removido: listener duplicado de submit do formul√°rio de cadastro)
            // Valida√ß√£o simples: s√≥ passa se todos os campos estiverem preenchidos
            function blockIfEmpty(formSelector) {
                const form = document.querySelector(formSelector);
                if (!form) return;
                form.addEventListener('submit', function(e) {
                    const inputs = form.querySelectorAll('input');
                    let valid = true;
                    inputs.forEach(input => {
                        if (!input.value.trim()) {
                            valid = false;
                            input.classList.add('border-red-500');
                        } else {
                            input.classList.remove('border-red-500');
                        }
                    });
                    if (!valid) {
                        if (typeof showMessageBox === 'function') {
                            showMessageBox('Preencha todos os campos para continuar.');
                        }
                        e.preventDefault();
                        return false;
                    }
                });
            }
            blockIfEmpty('[data-page="signup_form"] form');
            blockIfEmpty('[data-page="login_form"] form');
            // Valida√ß√£o robusta nos formul√°rios de login e cadastro
            function validateFormOnSubmit(formSelector, requiredSelectors, emailSelector) {
                const form = document.querySelector(formSelector);
                if (!form) return;
                form.addEventListener('submit', function(e) {
                    let valid = true;
                    let emailValid = true;
                    requiredSelectors.forEach(sel => {
                        const input = form.querySelector(sel);
                        if (!input || !input.value.trim()) {
                            valid = false;
                            if (input) input.classList.add('border-red-500');
                        } else {
                            input.classList.remove('border-red-500');
                        }
                    });
                    if (emailSelector) {
                        const emailInput = form.querySelector(emailSelector);
                        if (!emailInput || !emailInput.value.trim().endsWith('@gmail.com')) {
                            emailValid = false;
                            if (emailInput) emailInput.classList.add('border-red-500');
                        } else {
                            emailInput.classList.remove('border-red-500');
                        }
                    }
                    if (!valid || !emailValid) {
                        if (typeof showMessageBox === 'function') {
                        }
                        e.preventDefault();
                        return false;
                    }
                });
            }
            // Ajuste os seletores conforme seu HTML real
            validateFormOnSubmit('[data-page="signup_form"] form', ['input[type="text"]', 'input[type="email"]', 'input[type="password"]'], 'input[type="email"]');
            validateFormOnSubmit('[data-page="login_form"] form', ['input[type="email"]', 'input[type="password"]'], 'input[type="email"]');
            // Valida√ß√£o direta dos bot√µes de login/cadastro
            // Cadastro
            const signupFormBtn = document.querySelector('[data-page="signup_form"] button[type="submit"], [data-page="signup_form"] .signup-btn');
            if (signupFormBtn) {
                signupFormBtn.onclick = function(e) {
                    const inputs = document.querySelectorAll('[data-page="signup_form"] input');
                    let valid = true;
                    let emailValid = false;
                    inputs.forEach(input => {
                        if (!input.value.trim()) {
                            valid = false;
                            input.classList.add('border-red-500');
                        } else {
                            input.classList.remove('border-red-500');
                        }
                        if (input.type === 'email') {
                            emailValid = input.value.trim().endsWith('@gmail.com');
                            if (!emailValid) input.classList.add('border-red-500');
                        }
                    });
                    if (!valid || !emailValid) {
                        if (typeof showMessageBox === 'function') {
                            showMessageBox('Preencha todos os campos corretamente. O email deve terminar com @gmail.com');
                        }
                        e.preventDefault();
                        return false;
                    }
                };
            }
            // Login
            const loginFormBtn = document.querySelector('[data-page="login_form"] button[type="submit"], [data-page="login_form"] .login-btn');
            if (loginFormBtn) {
                loginFormBtn.onclick = function(e) {
                    const inputs = document.querySelectorAll('[data-page="login_form"] input');
                    let valid = true;
                    let emailValid = false;
                    inputs.forEach(input => {
                        if (!input.value.trim()) {
                            valid = false;
                            input.classList.add('border-red-500');
                        } else {
                            input.classList.remove('border-red-500');
                        }
                        if (input.type === 'email') {
                            emailValid = input.value.trim().endsWith('@gmail.com');
                            if (!emailValid) input.classList.add('border-red-500');
                        }
                    });
                    if (!valid || !emailValid) {
                        if (typeof showMessageBox === 'function') {
                            showMessageBox('Preencha todos os campos corretamente. O email deve terminar com @gmail.com');
                        }
                        e.preventDefault();
                        return false;
                    }
                };
            }
            // Valida√ß√£o de login e cadastro
            function validateForm(formId, requiredFields, emailField) {
                const form = document.getElementById(formId);
                if (!form) return;
                form.onsubmit = function(e) {
                    let valid = true;
                    requiredFields.forEach(id => {
                        const input = document.getElementById(id);
                        if (!input || !input.value.trim()) {
                            valid = false;
                            input.classList.add('border-red-500');
                        } else {
                            input.classList.remove('border-red-500');
                        }
                    });
                    if (emailField) {
                        const emailInput = document.getElementById(emailField);
                        if (emailInput && !emailInput.value.trim().endsWith('@gmail.com')) {
                            valid = false;
                            emailInput.classList.add('border-red-500');
                        } else if (emailInput) {
                            emailInput.classList.remove('border-red-500');
                        }
                    }
                    if (!valid) {
                        if (typeof showMessageBox === 'function') {
                            showMessageBox('Preencha todos os campos corretamente. O email deve terminar com @gmail.com');
                        }
                        e.preventDefault();
                        return false;
                    }
                };
            }
            // Exemplo: ajuste os IDs conforme seu HTML
            validateForm('login-form', ['login-email', 'login-password'], 'login-email');
            validateForm('signup-form', ['signup-name', 'signup-email', 'signup-password'], 'signup-email');
            // Mensagem para todos os bot√µes de comunidades
            function bindCommunitiesBtns() {
                document.querySelectorAll('[id*="communities"], .communities-btn').forEach(btn => {
                    btn.onclick = () => {
                        if (typeof showMessageBox === 'function') {
                            showMessageBox('Funcionalidade de comunidades ainda indispon√≠vel. Aguarde novidades!');
                        }
                    };
                });
            }
            bindCommunitiesBtns();
            // Se bot√µes forem criados dinamicamente, reexecutar bindCommunitiesBtns ap√≥s gerar p√°ginas
            const oldGenerateFeedContent = typeof generateFeedContent === 'function' ? generateFeedContent : null;
            window.generateFeedContent = function() {
                if (oldGenerateFeedContent) oldGenerateFeedContent.apply(this, arguments);
                bindCommunitiesBtns();
            };
            const oldUpdateProfilePage = typeof updateProfilePage === 'function' ? updateProfilePage : null;
            window.updateProfilePage = function() {
                if (oldUpdateProfilePage) oldUpdateProfilePage.apply(this, arguments);
                bindCommunitiesBtns();
            };
            // Mensagem para bot√µes de comunidades
            document.querySelectorAll('.communities-btn').forEach(btn => {
                btn.onclick = () => {
                    if (typeof showMessageBox === 'function') {
                        showMessageBox('Funcionalidade de comunidades ainda indispon√≠vel. Aguarde novidades!');
                    }
                };
            });
            // Inicializa√ß√£o do upload na p√°gina de cria√ß√£o
            const createPage = document.querySelector('[data-page="create"]');
            // Rea√ß√£o visual nos bot√µes de explorar
            const explorePage = document.querySelector('[data-page="explore"]');
            if (explorePage) {
                explorePage.querySelectorAll('.explore-btn').forEach(btn => {
                    btn.onclick = () => {
                        btn.classList.add('bounce-icon');
                        setTimeout(() => btn.classList.remove('bounce-icon'), 300);
                        // Adiciona contador fict√≠cio
                        let countSpan = btn.querySelector('.explore-reaction-count');
                        if (!countSpan) {
                            countSpan = document.createElement('span');
                            countSpan.className = 'explore-reaction-count ml-2 text-xs bg-blue-100 text-blue-700 rounded-full px-2 py-1';
                            countSpan.textContent = '1';
                            btn.appendChild(countSpan);
                        } else {
                            let val = parseInt(countSpan.textContent) || 0;
                            countSpan.textContent = (val + 1).toString();
                        }
                    };
                });
            }
            if (createPage) {
                // Cria input de upload se n√£o existir
                let glanceUpload = document.getElementById('glance-upload');
                if (!glanceUpload) {
                    glanceUpload = document.createElement('input');
                    glanceUpload.type = 'file';
                    glanceUpload.accept = 'image/*,video/*,audio/*,.txt';
                    glanceUpload.id = 'glance-upload';
                    glanceUpload.className = 'hidden';
                    createPage.appendChild(glanceUpload);
                }
                // Cria modal de descri√ß√£o se n√£o existir
                let glanceDescModal = document.getElementById('glance-desc-modal');
                if (!glanceDescModal) {
                    glanceDescModal = document.createElement('div');
                    glanceDescModal.id = 'glance-desc-modal';
                    glanceDescModal.className = 'hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80';
                    glanceDescModal.innerHTML = `
                        <div class="w-full max-w-md bg-white dark:bg-gray-900 rounded-2xl shadow-2xl flex flex-col items-center relative" style="max-height:90vh;">
                            <div class="w-full flex-1 flex flex-col items-center p-8 space-y-6 overflow-y-auto" style="max-height:calc(90vh - 80px);">
                                <h2 class="text-xl font-bold mb-2 text-center text-black dark:text-white">Nova Publica√ß√£o</h2>
                                <div id="glance-preview-container" class="w-full flex flex-col items-center mb-4"></div>
                                <div class="w-full relative mb-2">
                                    <textarea id="glance-desc-input" placeholder="Escreva uma descri√ß√£o..." rows="3" class="w-full p-3 pr-12 rounded-xl border-2 border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200"></textarea>
                                    <button id="glance-publish-btn" style="display:none; position:absolute; top:50%; right:8px; transform:translateY(-50%);" class="bg-blue-500 text-white rounded-full p-2 shadow-lg flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14L21 3m0 0l-6.5 6.5M21 3l-6.5 6.5M3 21v-4.5a2 2 0 012-2h4.5" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="flex w-full space-x-2 p-4 border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 rounded-b-2xl sticky bottom-0 z-10" style="box-shadow:0 -2px 8px 0 rgba(0,0,0,0.03);">
                                <button id="glance-cancel-btn" class="flex-1 py-3 bg-gray-300 dark:bg-gray-700 text-black dark:text-white font-semibold rounded-2xl">Cancelar</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(glanceDescModal);
                }
                // Bot√£o + faz upload
                const plusBtn = document.getElementById('glance-plus-btn');
                if (plusBtn) {
                    plusBtn.onclick = () => {
                        if (typeof isProfileConfigured === 'function' && !isProfileConfigured()) {
                            if (typeof showMessageBox === 'function') {
                                showMessageBox('Configure seu perfil (nome e bio) antes de publicar!');
                            }
                            return;
                        }
                        glanceUpload.value = '';
                        const previewContainer = document.getElementById('glance-preview-container');
                        if (previewContainer) previewContainer.innerHTML = '';
                        document.getElementById('glance-desc-input').value = '';
                        glanceUpload.click();
                    };
                }
                // Use window-scoped variables for all flows
                window.uploadedFileData = null;
                window.uploadedFileType = null;
                window.uploadedTextContent = null;
                glanceUpload.onchange = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const previewContainer = document.getElementById('glance-preview-container');
                        previewContainer.innerHTML = '';
                        window.uploadedFileType = null;
                        window.uploadedFileData = null;
                        window.uploadedTextContent = null;
                        glanceDescModal.classList.remove('hidden'); // Garante que o modal sempre aparece
                        document.getElementById('glance-publish-btn').style.display = 'none'; // S√≥ mostra ao digitar
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                window.uploadedFileData = e.target.result;
                                window.uploadedFileType = 'image';
                                previewContainer.innerHTML = `<img src="${window.uploadedFileData}" class="w-full max-w-xs rounded-xl mb-2 cursor-pointer" id="glance-preview-img" />`;
                                // Adiciona evento para cancelar ao clicar na foto
                                const previewImg = document.getElementById('glance-preview-img');
                                if (previewImg) {
                                    previewImg.onclick = function() {
                                        glanceDescModal.classList.add('hidden');
                                        window.uploadedFileData = null;
                                        window.uploadedFileType = null;
                                        window.uploadedTextContent = null;
                                        if (glanceUpload) glanceUpload.value = '';
                                        previewContainer.innerHTML = '';
                                        const descInput = document.getElementById('glance-desc-input');
                                        if (descInput) descInput.value = '';
                                    };
                                }
                            };
                            reader.readAsDataURL(file);
                        } else if (file.type.startsWith('video/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                window.uploadedFileData = e.target.result;
                                window.uploadedFileType = 'video';
                                previewContainer.innerHTML = `<video src="${window.uploadedFileData}" controls class="w-full max-w-xs rounded-xl mb-2"></video>`;
                            };
                            reader.readAsDataURL(file);
                        } else if (file.type.startsWith('audio/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                window.uploadedFileData = e.target.result;
                                window.uploadedFileType = 'audio';
                                previewContainer.innerHTML = `<audio src="${window.uploadedFileData}" controls class="w-full max-w-xs mb-2"></audio>`;
                            };
                            reader.readAsDataURL(file);
                        } else if (file.name.endsWith('.txt')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                window.uploadedTextContent = e.target.result;
                                window.uploadedFileType = 'text';
                                previewContainer.innerHTML = `<div class='w-full max-w-xs rounded-xl mb-2 bg-gray-200 dark:bg-gray-800 p-4'><pre class='whitespace-pre-wrap break-words'>${window.uploadedTextContent}</pre></div>`;
                            };
                            reader.readAsText(file);
                        } else {
                            previewContainer.innerHTML = `<div class='text-red-500'>Tipo de arquivo n√£o suportado.</div>`;
                        }
                    }
                    // Adiciona evento para mostrar bot√£o ao digitar
                    const descInput = document.getElementById('glance-desc-input');
                    const publishBtn = document.getElementById('glance-publish-btn');
                    if (descInput && publishBtn) {
                        descInput.oninput = function() {
                            if (descInput.value.length > 0) {
                                publishBtn.style.display = 'block';
                            } else {
                                publishBtn.style.display = 'none';
                            }
                        };
                    }
                };
                // Always attach publish logic ONCE, using global variables
                const publishBtn = document.getElementById('glance-publish-btn');
                if (publishBtn) {
                    publishBtn.onclick = function(e) {
                        if (e) e.preventDefault();
                        // Bloqueia publica√ß√£o se nome de usu√°rio for '@usuario_glance'
                        var username = document.getElementById('profile-username')?.textContent;
                        if (username === '@usuario_glance') {
                            if (typeof showMessageBox === 'function') {
                                showMessageBox('Configure seu perfil antes de publicar!');
                            }
                            return;
                        }
                        const descInput = document.getElementById('glance-desc-input');
                        const desc = descInput?.value.trim() || '';
                        if (window.uploadedFileType === 'image' && window.uploadedFileData) {
                            posts.push({
                                id: 'post' + (Date.now() + Math.floor(Math.random()*10000)),
                                user: window.loggedInUser,
                                type: 'image',
                                media: window.uploadedFileData,
                                text: desc,
                                reactions: { views: 0, likes: 0, shares: 0 },
                                timestamp: Date.now()
                            });
                        } else if (window.uploadedFileType === 'video' && window.uploadedFileData) {
                            posts.push({
                                id: 'post' + (Date.now() + Math.floor(Math.random()*10000)),
                                user: window.loggedInUser,
                                type: 'video',
                                media: window.uploadedFileData,
                                text: desc,
                                reactions: { views: 0, likes: 0, shares: 0 },
                                timestamp: Date.now()
                            });
                        } else if (window.uploadedFileType === 'audio' && window.uploadedFileData) {
                            posts.push({
                                id: 'post' + (Date.now() + Math.floor(Math.random()*10000)),
                                user: window.loggedInUser,
                                type: 'audio',
                                media: window.uploadedFileData,
                                text: desc,
                                reactions: { views: 0, likes: 0, shares: 0 },
                                timestamp: Date.now()
                            });
                        } else if (window.uploadedFileType === 'text' && window.uploadedTextContent) {
                            posts.push({
                                id: 'post' + (Date.now() + Math.floor(Math.random()*10000)),
                                user: window.loggedInUser,
                                type: 'text',
                                media: null,
                                text: window.uploadedTextContent,
                                reactions: { views: 0, likes: 0, shares: 0 },
                                timestamp: Date.now()
                            });
                        }
                        generateFeedContent();
                        updateProfilePage(window.loggedInUser);
                        if (typeof renderGlanceVideos === 'function') renderGlanceVideos();
                        // Redireciona para o feed
                        if (typeof showPage === 'function') showPage('feed');
                        glanceDescModal.classList.add('hidden');
                        window.uploadedFileData = null;
                        window.uploadedFileType = null;
                        window.uploadedTextContent = null;
                        if (glanceUpload) glanceUpload.value = '';
                        const previewContainer = document.getElementById('glance-preview-container');
                        if (previewContainer) previewContainer.innerHTML = '';
                        if (descInput) descInput.value = '';
                    };
                }
                document.getElementById('glance-cancel-btn').onclick = () => {
                    glanceDescModal.classList.add('hidden');
                    uploadedFileData = null;
                    uploadedFileType = null;
                    uploadedTextContent = null;
                    if (glanceUpload) glanceUpload.value = '';
                    const previewContainer = document.getElementById('glance-preview-container');
                    if (previewContainer) previewContainer.innerHTML = '';
                    const descInput = document.getElementById('glance-desc-input');
                    if (descInput) descInput.value = '';
                };
                document.getElementById('glance-publish-btn').onclick = () => {
                    if (typeof isProfileConfigured === 'function' && !isProfileConfigured()) {
                        if (typeof showMessageBox === 'function') {
                            showMessageBox('Configure seu perfil (nome e bio) antes de publicar!');
                        }
                        return;
                    }
                    const descInput = document.getElementById('glance-desc-input');
                    const desc = descInput ? descInput.value.trim() : '';
                    if (uploadedFileType === 'image' && uploadedFileData) {
                        posts.push({
                            user: window.loggedInUser,
                            type: 'image',
                            media: uploadedFileData,
                            text: desc || '',
                            reactions: { views: 0, likes: 0, shares: 0 }
                        });
                    } else if (uploadedFileType === 'video' && uploadedFileData) {
                        posts.push({
                            user: window.loggedInUser,
                            type: 'video',
                            media: uploadedFileData,
                            text: desc || '',
                            reactions: { views: 0, likes: 0, shares: 0 }
                        });
                    } else if (uploadedFileType === 'audio' && uploadedFileData) {
                        posts.push({
                            user: window.loggedInUser,
                            type: 'audio',
                            media: uploadedFileData,
                            text: desc || '',
                            reactions: { views: 0, likes: 0, shares: 0 }
                        });
                    } else if (uploadedFileType === 'text') {
                        // Always use the textarea value for text posts
                        if (desc) {
                            posts.push({
                                user: window.loggedInUser,
                                type: 'text',
                                media: null,
                                text: desc,
                                reactions: { views: 0, likes: 0, shares: 0 }
                            });
                        } else {
                            showMessageBox('Digite algum texto para publicar!');
                            return;
                        }
                    }
                    generateFeedContent();
                    updateProfilePage(window.loggedInUser);
                    if (typeof renderGlanceVideos === 'function') renderGlanceVideos();
                    showPage('feed');
                    glanceDescModal.classList.add('hidden');
                    uploadedFileData = null;
                    uploadedFileType = null;
                    uploadedTextContent = null;
                    if (descInput) descInput.value = '';
                    const previewContainer = document.getElementById('glance-preview-container');
                    if (previewContainer) previewContainer.innerHTML = '';
                };
            }
            const signupPageBtn = document.getElementById('signup-btn');
            if (signupPageBtn) {
                signupPageBtn.onclick = function() {
                    showPage('onboarding');
                };
            }
            // Intercepta final do onboarding para ir ao feed e mostrar modal depois de 2s
            const onboardingFinalBtn = document.getElementById('onboarding-final-btn');
            if (onboardingFinalBtn) {
                onboardingFinalBtn.onclick = function() {
                    showPage('feed');
                    setTimeout(showWelcomeModal, 2000);
                };
            }
        });
        // Fun√ß√£o para esconder/mostrar a barra de navega√ß√£o ao rolar (estilo Instagram)
        // Fun√ß√£o para esconder/mostrar a barra de navega√ß√£o ao rolar (estilo Instagram, PC e mobile)
        (function() {
            const navBar = document.getElementById('main-nav');
            if (!navBar) return;
            // Aplica para todos os containers de scroll
            document.querySelectorAll('.scroll-container').forEach(container => {
                let lastScrollTop = container.scrollTop;
                container.addEventListener('scroll', function() {
                    const st = container.scrollTop;
                    if (st > lastScrollTop + 10) {
                        navBar.style.transform = 'translateY(100%)';
                    } else if (st < lastScrollTop - 10) {
                        navBar.style.transform = 'translateY(0)';
                    }
                    lastScrollTop = st;
                });
                // Garante que a barra aparece ao entrar no container
                container.addEventListener('mouseenter', function() {
                    navBar.style.transform = 'translateY(0)';
                });
            });
        })();
// Modal de recorte de v√≠deo
function showVideoTrimModal(file, onTrimmed) {
    let oldModal = document.getElementById('video-trim-modal');
    if (oldModal) oldModal.remove();
    const url = URL.createObjectURL(file);
    const modal = document.createElement('div');
    modal.id = 'video-trim-modal';
    modal.className = 'fixed inset-0 z-[600] flex items-center justify-center bg-black/80 backdrop-blur-2xl';
    modal.innerHTML = `
        <div class='w-full max-w-md bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-2xl flex flex-col items-center relative'>
            <button id='close-trim-modal' class='absolute top-4 right-4 bg-white/80 hover:bg-blue-100 text-blue-700 rounded-full p-2 shadow-lg'>
                <svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor' class='w-6 h-6'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12' /></svg>
            </button>
            <h2 class='text-xl font-bold mb-4 text-center text-black dark:text-white'>Recorte seu v√≠deo (m√°x. 30s)</h2>
            <video id='trim-video' src='${url}' controls class='w-full rounded-xl mb-4'></video>
            <div class='flex flex-col w-full mb-4'>
                <label class='text-sm font-semibold mb-1 text-black dark:text-white'>In√≠cio (segundos): <input type='number' id='trim-start' min='0' value='0' class='w-16 p-1 rounded border'/></label>
                <label class='text-sm font-semibold mb-1 text-black dark:text-white'>Fim (segundos): <input type='number' id='trim-end' min='1' value='30' class='w-16 p-1 rounded border'/></label>
                <span id='trim-warning' class='text-xs text-red-500 mt-1 hidden'>O trecho n√£o pode passar de 30 segundos.</span>
            </div>
            <button id='trim-confirm-btn' class='w-full py-3 px-6 bg-blue-500 text-white font-semibold rounded-xl shadow-lg hover:bg-blue-600 transition-all duration-200'>Recortar e Publicar</button>
        </div>
    `;
    document.body.appendChild(modal);
    modal.querySelector('#close-trim-modal').onclick = () => { modal.remove(); URL.revokeObjectURL(url); };
    const video = modal.querySelector('#trim-video');
    const startInput = modal.querySelector('#trim-start');
    const endInput = modal.querySelector('#trim-end');
    const warning = modal.querySelector('#trim-warning');
    endInput.oninput = startInput.oninput = () => {
        let start = parseFloat(startInput.value);
        let end = parseFloat(endInput.value);
        if (end - start > 30) {
            warning.classList.remove('hidden');
            endInput.value = start + 30;
        } else {
            warning.classList.add('hidden');
        }
        if (end > video.duration) endInput.value = Math.floor(video.duration);
        if (start < 0) startInput.value = 0;
        if (start >= end) startInput.value = end - 1;
    };
    video.onloadedmetadata = () => {
        endInput.max = Math.floor(video.duration);
        if (video.duration < 30) endInput.value = Math.floor(video.duration);
    };
    modal.querySelector('#trim-confirm-btn').onclick = async () => {
        let start = parseFloat(startInput.value);
        let end = parseFloat(endInput.value);
        if (end - start > 30) return;
        // Recorte simples: s√≥ envia os tempos, recorte real precisa backend ou ffmpeg.js
        modal.remove();
        URL.revokeObjectURL(url);
        if (onTrimmed) onTrimmed({file, start, end});
    };
}
// Exemplo de uso: ao selecionar v√≠deo para upload
// document.getElementById('upload-video-input').onchange = function(e) {
//     const file = e.target.files[0];
//     if (file) {
//         showVideoTrimModal(file, ({file, start, end}) => {
//             // Aqui voc√™ pode enviar o arquivo e os tempos para o backend ou usar ffmpeg.js para recortar no frontend
//             // publishVideo(file, start, end);
//         });
//     }
// };
        // Pesquisa de pessoas e publica√ß√µes
        const searchBar = document.getElementById('search-bar');
        const searchBtn = document.getElementById('search-btn');
        if (searchBar && searchBtn) {
            searchBtn.onclick = () => {
                const query = searchBar.value.trim().toLowerCase();
                if (!query) return;
                // Pesquisa pessoas
                const foundUsers = Object.values(users).filter(u => u.username.toLowerCase().includes(query) || (u.name && u.name.toLowerCase().includes(query)));
                // Pesquisa publica√ß√µes
                const foundPosts = posts.filter(p => (p.text && p.text.toLowerCase().includes(query)) || (p.user && p.user.toLowerCase().includes(query)));
                let resultHtml = '<div class="p-4"><h2 class="text-lg font-bold mb-2">Resultados da pesquisa</h2>';
                if (foundUsers.length > 0) {
                    resultHtml += '<div class="mb-4"><h3 class="font-semibold">Pessoas</h3>';
                    foundUsers.forEach(u => {
                        resultHtml += `<div class='flex items-center space-x-2 mb-2'><img src='${u.avatar}' class='w-8 h-8 rounded-full border' /><span>@${u.username} (${u.name || ''})</span></div>`;
                    });
                    resultHtml += '</div>';
                }
                if (foundPosts.length > 0) {
                    resultHtml += '<div><h3 class="font-semibold">Publica√ß√µes</h3>';
                    foundPosts.forEach(p => {
                        resultHtml += `<div class='mb-2 p-2 bg-gray-200 dark:bg-gray-800 rounded-xl'><b>@${p.user}:</b> ${p.text}</div>`;
                    });
                    resultHtml += '</div>';
                }
                if (foundUsers.length === 0 && foundPosts.length === 0) {
                    resultHtml += '<div class="text-gray-500">Nenhum resultado encontrado.</div>';
                }
                resultHtml += '</div>';
                // Exibe resultados em um modal simples
                let oldModal = document.getElementById('search-results-modal');
                if (oldModal) oldModal.remove();
                const modal = document.createElement('div');
                modal.id = 'search-results-modal';
                modal.className = 'fixed inset-0 z-[400] flex items-center justify-center bg-black/40 backdrop-blur-2xl';
                modal.innerHTML = `<div class='w-full max-w-lg bg-white dark:bg-gray-900 rounded-2xl p-8 shadow-2xl'><button id='close-search-modal' class='absolute top-4 right-4 bg-gray-300 dark:bg-gray-700 text-black dark:text-white rounded-full px-4 py-1 font-semibold'>Fechar</button>${resultHtml}</div>`;
                document.body.appendChild(modal);
                document.getElementById('close-search-modal').onclick = () => modal.remove();
            };
        }
        const pages = document.querySelectorAll('.page');
        const navBar = document.getElementById('main-nav');

        function showPage(pageName, username = window.loggedInUser, animation = 'fade-in') {
            // Mostra/esconde barra fixa do logo s√≥ no feed
            const logoBar = document.getElementById('glance-logo-bar');
            if (logoBar) {
                if (pageName === 'feed') {
                    logoBar.style.display = '';
                } else {
                    logoBar.style.display = 'none';
                }
            }
            const currentPage = document.querySelector('.page.active');
            const newPage = document.querySelector(`[data-page="${pageName}"]`);
            if (currentPage === newPage) return;
            if (currentPage) {
                // Adiciona fade-out antes de remover active
                currentPage.classList.add('fade-out');
                setTimeout(() => {
                    currentPage.classList.remove('active', 'fade-out');
                }, 400);
            }
            // Garante que a nova p√°gina est√° vis√≠vel e com fade-in
            newPage.classList.add('active', 'fade-in');
            setTimeout(() => newPage.classList.remove('fade-in'), 500);
            // Mostra a barra de navega√ß√£o principal apenas ap√≥s login/cadastro
            const appPages = ['feed', 'explore', 'create', 'communities', 'profile'];
            if (appPages.includes(pageName)) {
                navBar.style.display = '';
            } else {
                navBar.style.display = 'none';
            }
            // Mostra/esconde barra de pesquisa apenas na aba explorar
            const searchBarContainer = document.getElementById('search-bar-container');
            if (searchBarContainer) {
                if (pageName === 'explore') {
                    searchBarContainer.classList.remove('hidden');
                } else {
                    searchBarContainer.classList.add('hidden');
                }
            }
            if (pageName === 'feed') {
                generateFeedContent();
            }
            if (pageName === 'profile') {
                updateProfilePage(username);
            }
        }
        
        // Fun√ß√£o utilit√°ria para gerar HTML e l√≥gica dos m√©todos de pagamento premium
        function renderPremiumPaymentOptions(onClose) {
            // Cria container
            const container = document.createElement('div');
            container.className = 'flex flex-col md:flex-row gap-6';
            // WhatsApp (MZN)
            const whatsappCol = document.createElement('div');
            whatsappCol.className = 'flex-1 flex flex-col items-center justify-center p-4 border rounded-2xl bg-gray-50 dark:bg-gray-800';
            whatsappCol.innerHTML = `
                <div class='text-3xl mb-2'>üá≤üáø</div>
                <div class='font-bold text-lg mb-1'>320 MZN</div>
                <div class='text-gray-600 dark:text-gray-300 mb-4 text-center'>Pagamento via WhatsApp</div>
                <button id='pay-whatsapp-btn' class='w-full px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-xl font-semibold text-lg shadow transition'>Pagar pelo WhatsApp</button>
            `;
            // PayPal (USD)
            const paypalCol = document.createElement('div');
            paypalCol.className = 'flex-1 flex flex-col items-center justify-center p-4 border rounded-2xl bg-gray-50 dark:bg-gray-800';
            paypalCol.innerHTML = `
                <div class='text-3xl mb-2'>üí≥</div>
                <div class='font-bold text-lg mb-1'>5 USD</div>
                <div class='text-gray-600 dark:text-gray-300 mb-4 text-center'>Pagamento via PayPal</div>
                <button id='pay-paypal-btn' class='w-full px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-semibold text-lg shadow transition'>Pagar pelo PayPal</button>
            `;
            container.appendChild(whatsappCol);
            container.appendChild(paypalCol);
            // L√≥gica dos bot√µes
            setTimeout(() => {
                const whatsappBtn = container.querySelector('#pay-whatsapp-btn');
                if (whatsappBtn) {
                    whatsappBtn.onclick = () => {
                        window.open('https://wa.me/258864813115?text=' + encodeURIComponent('Ol√°! Gostaria de pagar o pacote premium de 320MZN.'), '_blank');
                        if (typeof onClose === 'function') onClose();
                    };
                }
                const paypalBtn = container.querySelector('#pay-paypal-btn');
                if (paypalBtn) {
                    paypalBtn.onclick = () => {
                        window.open('https://wa.me/258864813115?text=' + encodeURIComponent('Ol√°! Gostaria de pagar o premium via PayPal (5 USD).'), '_blank');
                        if (typeof onClose === 'function') onClose();
                    };
                }
            }, 100);
            return container;
        }

        // Fun√ß√£o para atualizar a p√°gina de perfil com base no tipo de usu√°rio
        function updateProfilePage(username) {
            const profile = users[username];
            if (!profile) return; // Se o usu√°rio n√£o existe, n√£o faz nada
            // Elementos do perfil
            const profileUsername = document.getElementById('profile-username');
            const profileBio = document.getElementById('profile-bio');
            const profileAvatar = document.getElementById('profile-avatar');
            // Avatar com borda colorida √∫nica igual ao Explorer
            const profileAvatarBorder = document.getElementById('profile-avatar-color-border');
            if (profileAvatarBorder) {
                // Determina cor √∫nica igual ao Explorer
                const profileColors = [
                    '#ec4899', // pink-400
                    '#60a5fa', // blue-400
                    '#4ade80', // green-400
                    '#facc15', // yellow-400
                    '#a78bfa', // purple-400
                    '#f87171', // red-400
                    '#818cf8', // indigo-400
                    '#2dd4bf', // teal-400
                    '#fb923c', // orange-400
                    '#22d3ee', // cyan-400
                    '#e879f9', // fuchsia-400
                    '#a3e635'  // lime-400
                ];
                const userList = Object.values(users);
                const idx = userList.findIndex(u => u.username === username);
                const color = profileColors[idx % profileColors.length];
                profileAvatarBorder.className = 'w-32 h-32 rounded-full border-4 shadow-lg flex items-center justify-center mb-4 overflow-hidden';
                profileAvatarBorder.style.borderColor = color;
            }

            // Fun√ß√£o para checar se o perfil est√° configurado (nome e bio preenchidos)
            function isProfileConfigured() {
                const user = users[username];
                // S√≥ libera se o nome de usu√°rio for diferente de 'usuario_glance'
                return user && user.username && user.username.trim() !== '' && user.username !== 'usuario_glance';
            }
            const profilePostsCount = document.getElementById('profile-posts-count');
            const profileFollowersCount = document.getElementById('profile-followers-count');
            const profileFollowingCount = document.getElementById('profile-following-count');
            const editBtn = document.getElementById('edit-profile-btn');
            const uploadBtn = document.getElementById('upload-btn');
            const editForm = document.getElementById('edit-profile-form');
            const profilePostsGrid = document.getElementById('profile-posts-grid');
            
            // Atualiza os dados do perfil
            const profileName = document.getElementById('profile-realname');
            if (profileName) profileName.textContent = (profile.name && profile.name.trim() !== '' && profile.name !== 'Lucas Silva') ? profile.name : '';
            if (profileUsername) profileUsername.textContent = `@${profile.username}`;
            if (username === window.loggedInUser) {
                profileBio.textContent = (profile.bio && profile.bio.trim() !== '') ? profile.bio : '';
            } else {
                profileBio.textContent = profile.bio;
            }
            profileAvatar.src = profile.avatar;
            // Renderiza bot√£o de mensagem privada ao lado do bot√£o de seguir
            const msgBtnContainer = document.getElementById('profile-message-btn-container');
            if (msgBtnContainer) {
                msgBtnContainer.innerHTML = '';
                if (username !== window.loggedInUser) {
                    // Bot√£o de seguir (j√° deve existir, mas garantir)
                    let followBtn = document.getElementById('profile-follow-btn');
                    if (!followBtn) {
                        followBtn = document.createElement('button');
                        followBtn.id = 'profile-follow-btn';
                        followBtn.className = 'px-4 py-2 bg-green-500 text-white rounded-2xl shadow hover:bg-green-600 transition';
                        followBtn.textContent = 'Seguir';
                        followBtn.onclick = function() {
                            showMessageBox('Seguir funcionalidade ainda n√£o implementada.');
                        };
                        msgBtnContainer.appendChild(followBtn);
                    }
                    // √çcone de mensagem
                    const btn = document.createElement('button');
                    btn.id = 'start-private-message-btn';
                    btn.className = 'flex items-center justify-center w-10 h-10 bg-blue-500 text-white rounded-full shadow hover:bg-blue-600 transition';
                    btn.innerHTML = `<svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor' class='w-6 h-6'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z' /></svg>`;
                    btn.onclick = function() {
                        openChatModal(username);
                    };
                    msgBtnContainer.appendChild(btn);
                }
            }
            // Fun√ß√£o para abrir modal de chat
            window.openChatModal = function(userId) {
                let oldModal = document.getElementById('chat-modal');
                if (oldModal) oldModal.remove();
                const modal = document.createElement('div');
                modal.id = 'chat-modal';
                modal.className = 'fixed inset-0 z-[9999] flex items-center justify-center bg-black/90';
                modal.innerHTML = `
                    <div class='w-full max-w-md h-full flex flex-col bg-white dark:bg-gray-900 rounded-2xl shadow-2xl p-0 relative'>
                        <div class='flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700'>
                            <h2 class='text-xl font-bold text-black dark:text-white'>Conversando com ${(users[userId]?.name || '@'+(users[userId]?.username || userId))}</h2>
                            <button id='close-chat-modal' class='text-gray-500 hover:text-red-500 text-2xl font-bold'>&times;</button>
                        </div>
                        <div id='chat-messages' class='flex-1 overflow-y-auto px-6 py-4 space-y-2'></div>
                        <form id='chat-form' class='flex items-center gap-2 px-6 py-4 border-t border-gray-200 dark:border-gray-700'>
                            <input id='chat-input' type='text' class='flex-1 p-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 text-black dark:text-white' placeholder='Digite sua mensagem...' autocomplete='off' />
                            <button type='submit' class='px-4 py-2 bg-blue-500 text-white rounded-xl font-semibold'>Enviar</button>
                        </form>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('close-chat-modal').onclick = function() {
                    modal.remove();
                };
                // Mensagens simuladas (array por usu√°rio)
                window._chatMessages = window._chatMessages || {};
                const chatMessages = window._chatMessages[userId] || [];
                const chatMessagesDiv = document.getElementById('chat-messages');
                function renderMessages() {
                    chatMessagesDiv.innerHTML = '';
                    chatMessages.forEach(msg => {
                        const msgDiv = document.createElement('div');
                        msgDiv.className = 'w-fit max-w-[80%] px-4 py-2 rounded-xl mb-1 ' + (msg.from === window.loggedInUser ? 'bg-blue-500 text-white ml-auto' : 'bg-gray-200 text-black mr-auto');
                        msgDiv.textContent = msg.text;
                        chatMessagesDiv.appendChild(msgDiv);
                    });
                    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
                }
                renderMessages();
                // Envio de mensagem
                document.getElementById('chat-form').onsubmit = function(e) {
                    e.preventDefault();
                    const input = document.getElementById('chat-input');
                    const text = input.value.trim();
                    if (text.length > 0) {
                        chatMessages.push({ from: window.loggedInUser, to: userId, text });
                        window._chatMessages[userId] = chatMessages;
                        renderMessages();
                        input.value = '';
                    }
                };
            };
                document.getElementById('profile-avatar-full').src = profile.avatar;
            function formatNumber(n) {
                if (n >= 1e9) return (n/1e9).toFixed(1).replace(/\.0$/, '') + 'B';
                if (n >= 1e6) return (n/1e6).toFixed(1).replace(/\.0$/, '') + 'M';
                if (n >= 1e3) return (n/1e3).toFixed(1).replace(/\.0$/, '') + 'K';
                return n;
            }
            profilePostsCount.textContent = profile.posts;
            profileFollowersCount.textContent = formatNumber(profile.followers);
            profileFollowingCount.textContent = formatNumber(profile.following);
            // Esconde/mostra barra de navega√ß√£o no feed conforme scroll
            let lastScrollTop = 0;
            const navBar = document.getElementById('main-nav');
            const feedContainer = document.getElementById('feed-scroll-container');
            if (feedContainer && navBar) {
                feedContainer.addEventListener('scroll', function() {
                    const st = feedContainer.scrollTop;
                    if (st > lastScrollTop + 10) {
                        navBar.style.transform = 'translateY(100%)';
                    } else if (st < lastScrollTop - 10) {
                        navBar.style.transform = 'translateY(0)';
                    }
                    lastScrollTop = st;
                });
                // Garante que a barra aparece ao entrar no feed
                feedContainer.addEventListener('mouseenter', function() {
                    navBar.style.transform = 'translateY(0)';
                });
            }
            
            // Bot√£o de seguir no perfil
            const followProfileContainer = document.getElementById('follow-profile-container');
            if (username !== loggedInUser) {
                // Checa se j√° est√° seguindo
                let following = JSON.parse(localStorage.getItem('following') || '{}');
                let isFollowing = following[username] === true;
                followProfileContainer.innerHTML = `<button id="profile-follow-btn" class="${isFollowing ? 'bg-green-500' : 'bg-blue-500'} text-white text-xs font-semibold rounded-full px-4 py-1 shadow-md hover:bg-blue-600 transition-all duration-200">${isFollowing ? 'Seguindo' : 'Seguir'}</button>`;
                document.getElementById('profile-follow-btn').onclick = function() {
                    let following = JSON.parse(localStorage.getItem('following') || '{}');
                    let isFollowing = following[username] === true;
                    if (isFollowing) {
                        this.textContent = 'Seguir';
                        this.classList.remove('bg-green-500');
                        this.classList.add('bg-blue-500');
                        following[username] = false;
                        users[username].followers = Math.max(0, (users[username].followers || 0) - 1);
                    } else {
                        this.textContent = 'Seguindo';
                        this.classList.remove('bg-blue-500');
                        this.classList.add('bg-green-500');
                        following[username] = true;
                        users[username].followers = (users[username].followers || 0) + 1;
                    }
                    localStorage.setItem('following', JSON.stringify(following));
                    // Atualiza n√∫mero de seguidores
                    document.getElementById('profile-followers-count').textContent = users[username].followers;
                    // Atualiza bot√µes do Explorer
                    document.querySelectorAll(`.explore-follow-btn[data-username='${username}']`).forEach(b => {
                        let isNowFollowing = JSON.parse(localStorage.getItem('following') || '{}')[username] === true;
                        b.textContent = isNowFollowing ? 'Seguindo' : 'Seguir';
                        b.classList.remove('bg-blue-500','hover:bg-blue-600','bg-green-500');
                        b.classList.add(isNowFollowing ? 'bg-green-500' : 'bg-blue-500');
                    });
                    // Atualiza bot√µes do feed
                    if (typeof generateFeedContent === 'function') generateFeedContent();
                };
            } else {
                followProfileContainer.innerHTML = '';
            }
            // Esconde/mostra elementos de edi√ß√£o dependendo se √© o perfil do usu√°rio logado
            if (username === window.loggedInUser) {
                editBtn.classList.remove('hidden');
                uploadBtn.classList.remove('hidden');
            } else {
                editBtn.classList.add('hidden');
                uploadBtn.classList.add('hidden');
                editForm.classList.add('hidden');
            }
            // Gera e exibe as publica√ß√µes do usu√°rio
            generateProfilePosts(username);
        }

        function generateProfilePosts(username) {
            const gridContainer = document.getElementById('profile-posts-grid');
            gridContainer.innerHTML = '';
            const userPosts = posts.filter(post => post.user === username);
            userPosts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'w-full aspect-square max-w-[180px] h-[180px] bg-gray-300 dark:bg-gray-700 rounded-lg overflow-hidden flex-shrink-0 flex items-center justify-center cursor-pointer';

                if (post.type === 'image') {
                    postElement.style.backgroundImage = `url('${post.media}')`;
                    postElement.style.backgroundSize = 'cover';
                    postElement.style.backgroundPosition = 'center';
                } else if (post.type === 'video') {
                    postElement.innerHTML = `<span class="text-6xl">üìπ</span>`;
                } else if (post.type === 'audio') {
                    postElement.innerHTML = `<span class="text-6xl">üéµ</span>`;
                }

                // Permite abrir em tela cheia (exceto texto)
                if (post.type !== 'text') {
                    postElement.onclick = function() {
                        const idx = posts.findIndex(p => p.id === post.id);
                        if (typeof showFullPost === 'function' && idx !== -1) showFullPost(idx);
                    };
                }

                gridContainer.appendChild(postElement);
            });
            // Atualiza o n√∫mero de publica√ß√µes no perfil do usu√°rio logado
            if (username === window.loggedInUser) {
                document.getElementById('profile-posts-count').textContent = userPosts.length;
            }
        }
        
        // Fun√ß√£o para gerar o conte√∫do do feed dinamicamente
        function generateFeedContent() {
            // Fun√ß√£o para abrir post em tela cheia
            function showFullPost(postIdx) {
                let oldModal = document.getElementById('fullpost-modal');
                if (oldModal) oldModal.remove();
                const post = posts[postIdx];
                const modal = document.createElement('div');
                modal.id = 'fullpost-modal';
                modal.className = 'fixed inset-0 z-[500] flex items-center justify-center bg-black/80 backdrop-blur-2xl';
                let audioModalHtml = '';
                if (post.type === 'audio') {
                    audioModalHtml = `
                        <div class='w-full h-full flex flex-col items-center justify-center' style="background: linear-gradient(135deg, #a855f7 0%, #6d28d9 100%);">
                            <button id='close-fullpost-btn' class='absolute top-4 left-4 bg-white/80 hover:bg-blue-100 text-blue-700 rounded-full p-2 shadow-lg z-50'>
                                <svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor' class='w-7 h-7'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 19l-7-7 7-7' /></svg>
                            </button>
                            <div class='flex flex-col items-center justify-center w-full h-full'>
                                <div class='flex items-center justify-center mb-2' style='height:56px;'>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 48 48" width="56" height="56">
                                        <path d="M12 28v-4a12 12 0 0 1 24 0v4" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                                        <rect x="6" y="28" width="8" height="12" rx="4" fill="#fff" fill-opacity="0.7" stroke="#fff" stroke-width="2"/>
                                        <rect x="34" y="28" width="8" height="12" rx="4" fill="#fff" fill-opacity="0.7" stroke="#fff" stroke-width="2"/>
                                    </svg>
                                </div>
                                <canvas id='audio-waves-canvas' width='340' height='180' style='max-width:90vw;max-height:40vh;'></canvas>
                                <div class='mt-8 text-center'>
                                    <h2 class='text-2xl font-bold text-white mb-2'>${users[post.user].name || '@'+post.user}</h2>
                                    <p class='text-base text-white/80 mb-2'>${post.text}</p>
                                    <span class='text-white text-xs opacity-60'>(toque/click para pausar/reproduzir)</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                modal.innerHTML = `
                    ${post.type === 'video' ? `
                        <div class='relative w-full flex flex-col items-center justify-center'>
                            <button id='close-fullpost-btn' class='absolute top-4 left-4 bg-white/80 hover:bg-blue-100 text-blue-700 rounded-full p-2 shadow-lg z-50'>
                                <svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor' class='w-7 h-7'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 19l-7-7 7-7' /></svg>
                            </button>
                            <div class='flex items-center justify-center w-full' style='background:black;'>
                                <video id='fullpost-video' src='${post.media}' controls autoplay playsinline style='width:100vw;max-width:420px;height:80vh;max-height:80vh;aspect-ratio:9/16;display:block;margin:auto;background:black;' class='rounded-xl object-contain'></video>
                            </div>
                        </div>
                    ` : ''}
                    ${post.type === 'image' ? `
                        <div class='relative w-full flex flex-col items-center justify-center'>
                            <button id='close-fullpost-btn' class='absolute top-4 left-4 bg-white/80 hover:bg-blue-100 text-blue-700 rounded-full p-2 shadow-lg z-50'>
                                <svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor' class='w-7 h-7'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 19l-7-7 7-7' /></svg>
                            </button>
                            <img src='${post.media}' class='w-full max-h-[80vh] rounded-xl object-contain' />
                        </div>
                    ` : ''}
                    ${post.type === 'audio' ? audioModalHtml : ''}
                    ${post.type === 'text' ? '' : ''}
                    ${post.type !== 'image' && post.type !== 'audio' && post.type !== 'video' ? '' : ''}
                `;
                document.body.appendChild(modal);
                // Bot√£o fechar
                // √Åudio: refer√™ncia para controle
                let audio = null;
                let audioCleanup = null;
                if (post.type === 'audio') {
                    // O √°udio ser√° criado no bloco abaixo
                }
                // Fun√ß√£o para fechar o modal e parar √°udio se existir
                function closeModal() {
                    if (audio) {
                        audio.pause();
                        audio.currentTime = 0;
                        audio.src = '';
                        audio.load();
                        audio = null;
                    }
                    if (typeof audioCleanup === 'function') audioCleanup();
                    modal.remove();
                }
                modal.querySelector('#close-fullpost-btn').onclick = closeModal;
                // Garante que ao remover o modal manualmente (ex: ESC, click fora, etc) o √°udio pare
                const observer = new MutationObserver(() => {
                    if (!document.body.contains(modal)) {
                        if (audio) {
                            audio.pause();
                            audio.currentTime = 0;
                            audio.src = '';
                            audio.load();
                            audio = null;
                        }
                        if (typeof audioCleanup === 'function') audioCleanup();
                        observer.disconnect();
                    }
                });
                observer.observe(document.body, {childList:true, subtree:true});
                // V√≠deo: mant√©m comportamento
                setTimeout(() => {
                    const vid = modal.querySelector('#fullpost-video');
                    if (vid) {
                        vid.currentTime = 0;
                        vid.play();
                    }
                }, 200);
                // √Åudio: canvas animado, play/pause e controle de velocidade
                if (post.type === 'audio') {
                    audio = new Audio(post.media);
                    audio.autoplay = true;
                    let playing = true;
                    let animationId;
                    let playbackRates = [1, 1.25, 1.5, 1.75, 2];
                    let rateIdx = 0;
                    const canvas = modal.querySelector('#audio-waves-canvas');
                    const ctx = canvas.getContext('2d');
                    // Bot√£o de velocidade
                    const speedBtn = document.createElement('button');
                    speedBtn.textContent = '1x';
                    speedBtn.className = 'absolute top-4 right-4 bg-white/80 hover:bg-blue-100 text-blue-700 rounded-full px-4 py-2 shadow-lg z-50 font-bold text-lg';
                    speedBtn.style.transition = 'background 0.2s';
                    modal.appendChild(speedBtn);
                    speedBtn.onclick = (e) => {
                        e.stopPropagation();
                        rateIdx = (rateIdx + 1) % playbackRates.length;
                        audio.playbackRate = playbackRates[rateIdx];
                        speedBtn.textContent = playbackRates[rateIdx] + 'x';
                    };
                    // Par√¢metros das ondas
                    const waves = [
                        {amp: 28, freq: 0.018, speed: 0.018, color: 'rgba(255,255,255,0.85)', phase: 0},
                        {amp: 18, freq: 0.024, speed: 0.022, color: 'rgba(255,255,255,0.5)', phase: Math.PI/3},
                        {amp: 12, freq: 0.032, speed: 0.028, color: 'rgba(255,255,255,0.3)', phase: Math.PI/1.5}
                    ];
                    let t = 0;
                    function drawWaves() {
                        ctx.clearRect(0,0,canvas.width,canvas.height);
                        waves.forEach(wave => {
                            ctx.beginPath();
                            for(let x=0;x<=canvas.width;x+=2) {
                                const y = canvas.height/2 + Math.sin(x*wave.freq + t*wave.speed + wave.phase)*wave.amp;
                                if(x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                            }
                            ctx.strokeStyle = wave.color;
                            ctx.lineWidth = 4;
                            ctx.stroke();
                        });
                    }
                    function animate() {
                        if (!playing) return;
                        t += 1.5;
                        drawWaves();
                        animationId = requestAnimationFrame(animate);
                    }
                    function startAnim() {
                        if (!playing) return;
                        cancelAnimationFrame(animationId);
                        animate();
                    }
                    function stopAnim() {
                        cancelAnimationFrame(animationId);
                        drawWaves();
                    }
                    // Play/pause ao clicar
                    canvas.onclick = () => {
                        if (audio.paused) {
                            audio.play();
                            playing = true;
                            startAnim();
                        } else {
                            audio.pause();
                            playing = false;
                            stopAnim();
                        }
                    };
                    // Tamb√©m permite pausar/play ao clicar em qualquer lugar do modal
                    modal.querySelector('.flex.flex-col.items-center.justify-center.w-full.h-full').onclick = (e) => {
                        if (e.target === canvas || e.target === speedBtn) return;
                        if (audio.paused) {
                            audio.play();
                            playing = true;
                            startAnim();
                        } else {
                            audio.pause();
                            playing = false;
                            stopAnim();
                        }
                    };
                    // Sincroniza anima√ß√£o com play/pause
                    audio.onplay = () => { playing = true; startAnim(); };
                    audio.onpause = () => { playing = false; stopAnim(); };
                    // Inicia
                    drawWaves();
                    audio.play();
                    // Cleanup para garantir que o √°udio pare sempre
                    audioCleanup = function() {
                        if (audio) {
                            audio.pause();
                            audio.currentTime = 0;
                            audio.src = '';
                            audio.load();
                            audio = null;
                        }
                    };
                }
            }
            const feedContainer = document.getElementById('feed-scroll-container');
            if (!feedContainer) return;
            feedContainer.innerHTML = '';
            if (posts.length === 0) return;
            const reversedPosts = posts.slice().reverse();
            // Fun√ß√£o para formatar n√∫mero grande
            function formatNumber(n) {
                if (n >= 1e9) return (n/1e9).toFixed(1).replace(/\.0$/, '') + 'B';
                if (n >= 1e6) return (n/1e6).toFixed(1).replace(/\.0$/, '') + 'M';
                if (n >= 1e3) return (n/1e3).toFixed(1).replace(/\.0$/, '') + 'K';
                return n;
            }
            reversedPosts.forEach((post, idx) => {
                const isOwnPost = post.user === window.loggedInUser;
                const postElement = document.createElement('div');
                const isLast = idx === reversedPosts.length - 1;
                const postIdx = reversedPosts.length - 1 - idx;
                postElement.className = 'w-full h-auto aspect-[9/16] max-w-sm bg-gray-300 dark:bg-gray-700 rounded-3xl p-4 flex flex-col justify-between shadow-xl mb-8 relative' + (isLast ? ' mb-24' : '');

                // Renderiza a m√≠dia correta com base no tipo
                let mediaContent = '';
                if (post.type === 'image') {
                    mediaContent = `<img src="${post.media}" class="w-full h-full object-cover rounded-3xl absolute inset-0 z-0">`;
                } else if (post.type === 'video') {
                    mediaContent = `
                        <div class="relative w-full h-full">
                            <video src="${post.media}" class="feed-video w-full h-full object-cover rounded-3xl absolute inset-0 z-0" style="background:black;" playsinline muted></video>
                            <button class="feed-video-sound-btn absolute bottom-4 right-4 z-10 bg-white/80 hover:bg-blue-100 text-blue-700 rounded-full p-2 shadow-lg flex items-center justify-center" title="Ativar/desativar som" style="backdrop-filter: blur(4px);">
                                <span class="feed-video-sound-icon"></span>
                            </button>
                        </div>
                    `;
            // Add mute/unmute logic for feed videos
            setTimeout(() => {
                const videos = feedContainer.querySelectorAll('.feed-video');
                const soundBtns = feedContainer.querySelectorAll('.feed-video-sound-btn');
                videos.forEach((vid, i) => {
                    const btn = soundBtns[i];
                    if (!btn) return;
                    function updateIcon() {
                        const icon = btn.querySelector('.feed-video-sound-icon');
                        if (vid.muted || vid.volume === 0) {
                            icon.innerHTML = `<svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor' class='w-6 h-6'><path stroke='currentColor' stroke-width='2' d='M9 9v6h4l5 5V4l-5 5H9z' /><line x1='19' y1='5' x2='5' y2='19' stroke='red' stroke-width='2'/></svg>`;
                        } else {
                            icon.innerHTML = `<svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor' class='w-6 h-6'><path stroke='currentColor' stroke-width='2' d='M9 9v6h4l5 5V4l-5 5H9z' /></svg>`;
                        }
                    }
                    updateIcon();
                    btn.onclick = function(e) {
                        e.stopPropagation();
                        vid.muted = !vid.muted;
                        if (!vid.muted) { vid.volume = 1; vid.play(); }
                        updateIcon();
                    };
                    vid.onvolumechange = updateIcon;
                });
            }, 200);
                } else if (post.type === 'audio') {
                    mediaContent = `
                        <div class="w-full h-full bg-purple-500 dark:bg-purple-900 flex flex-col items-center justify-center rounded-3xl absolute inset-0 z-0 text-white">
                            <span class="text-7xl">üéµ</span>
                            <p class="mt-2 text-sm font-semibold">Reproduzir √Åudio</p>
                        </div>
                    `;
                } else if (post.type === 'text') {
                    // Post de texto estilo Threads
                    mediaContent = `
                        <div class="w-full flex flex-col items-start justify-center rounded-2xl bg-white dark:bg-gray-900 p-4 border border-gray-200 dark:border-gray-800 mb-2">
                            <div class="flex items-center gap-3 mb-2">
                                <img src='${users[post.user]?.avatar || 'https://ui-avatars.com/api/?name=' + (users[post.user]?.name || 'Usu√°rio')}' class='w-10 h-10 rounded-full border border-gray-300 dark:border-gray-700 object-cover' />
                                <div>
                                    <div class='font-bold text-black dark:text-white'>${users[post.user]?.name || 'Usu√°rio'}</div>
                                    <div class='text-xs text-gray-500 dark:text-gray-400'>@${users[post.user]?.username || post.user}</div>
                                </div>
                            </div>
                            <div class='text-lg font-medium text-black dark:text-white whitespace-pre-line mb-2'>${post.text}</div>
                        </div>
                    `;
                }

                // Coment√°rios: apenas contador, sem lista inline
                const commentsArr = postComments[postIdx] || [];
                commentsHtml = `<div class='mt-4 comments-section' data-postidx='${postIdx}'>`;
                // O √≠cone de coment√°rio ser√° movido para a linha das rea√ß√µes
                // Input de novo coment√°rio
                commentsHtml += `
                    <form class='flex items-center mt-2 comment-form' autocomplete='off' onsubmit='return false;'>
                        <input type='text' class='flex-1 p-2 rounded-xl border-2 border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200 mr-2 comment-input' placeholder='Escreva um coment√°rio...'/>
                        <button type='submit' class='py-2 px-4 bg-blue-500 text-white rounded-xl font-semibold send-comment-btn' style='display:none;'>Enviar</button>
                    </form>
                </div>`;

                // Tempo de publica√ß√£o no topo
                const timeHtml = `<div class="absolute top-4 left-1/2 -translate-x-1/2 z-20 bg-black/70 dark:bg-white/80 text-white dark:text-black text-xs font-semibold px-4 py-1 rounded-full shadow-lg select-none" style="backdrop-filter: blur(4px);">${typeof post.timestamp !== 'undefined' ? timeAgo(post.timestamp) : ''}</div>`;

                postElement.innerHTML = `
                    <div class="relative z-10 flex items-center space-x-2 p-2 rounded-full bg-black/50 dark:bg-white/50 backdrop-blur-md w-fit self-start mb-2" data-profile="${post.user}">
                        <span style="position:relative;display:inline-block;cursor:pointer;" class="feed-profile-avatar">
                            <span class="w-8 h-8 rounded-full border-2 shadow flex items-center justify-center overflow-hidden" style="display:inline-flex;border-color:${['#ec4899','#60a5fa','#4ade80','#facc15','#a78bfa','#f87171','#818cf8','#2dd4bf','#fb923c','#22d3ee','#e879f9','#a3e635'][Object.values(users).findIndex(u => u.username === post.user)%12]}">
                                <img src="${users[post.user].avatar}" class="w-full h-full object-cover rounded-full" />
                            </span>
                            <span style="position:absolute;bottom:0;right:0;width:10px;height:10px;background:#22c55e;border:2px solid #fff;border-radius:50%;display:block;z-index:10;"></span>
                        </span>
                        <div class="flex flex-col">
                            <span class="text-white font-semibold text-sm">${users[post.user].name}</span>
                            <span class="text-xs text-gray-200 dark:text-gray-700">@${users[post.user].username}</span>
                        </div>
                    </div>
                    ${mediaContent}
                    ${timeHtml}
                    <button class="follow-btn absolute top-4 right-4 text-white text-xs font-semibold rounded-full px-4 py-1 shadow-md hover:bg-blue-600 transition-all duration-200" style="${isOwnPost ? 'display:none;' : ''}"></button>
                    <!-- Bot√£o de mensagens no canto superior direito -->
                    <button class='message-btn absolute top-4 right-16 text-2xl transform hover:scale-110 transition-transform duration-200 rounded-full bg-white/80 dark:bg-black/80 border border-blue-400 shadow-lg p-2 flex items-center z-30' title='Conversar' data-user='${users[post.user]?.username || post.user}' style='backdrop-filter: blur(4px);${isOwnPost ? 'display:none;' : ''}'>
                        <span style="font-size:2rem;">üí¨</span>
                    </button>
                    <div class="relative z-10 flex flex-col space-y-4">
                        <div class="bg-black/50 dark:bg-white/50 text-white dark:text-black p-4 rounded-xl shadow-inner backdrop-blur-md">
                            <p class="text-sm">${post.text}</p>
                        </div>
                        <div class="flex justify-end space-x-4 items-center">
                            <!-- O placeholder do feed ser√° inserido via JS apenas se n√£o houver posts -->
                            <button class="reaction-btn reaction-views text-2xl transform hover:scale-110 transition-transform duration-200 rounded-full border border-blue-300 shadow-md p-2 flex items-center ${userViews[window.loggedInUser] && userViews[window.loggedInUser][postIdx] ? 'bg-green-400 text-white' : 'bg-white/60 dark:bg-black/60'}" title="Olhei">
                                <span class="text-lg sm:text-xl md:text-2xl">üëÄ</span>
                                <span class="ml-1 text-base font-bold">${formatNumber(post.reactions.views)}</span>
                            </button>
                            <button class="reaction-btn reaction-likes text-2xl transform hover:scale-110 transition-transform duration-200 rounded-full border border-red-300 shadow-md p-2 flex items-center ${userLikes[postIdx] ? 'bg-red-500 text-white' : 'bg-white/60 dark:bg-black/60'}" title="Amei">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="${userLikes[postIdx] ? 'red' : 'none'}" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 sm:w-6 sm:h-6 md:w-7 md:h-7">
                                    <path stroke="currentColor" stroke-width="2" d="M12 21C12 21 4 13.5 4 8.5C4 5.5 6.5 4 8.5 4C10.5 4 12 6 12 6C12 6 13.5 4 15.5 4C17.5 4 20 5.5 20 8.5C20 13.5 12 21 12 21Z" />
                                </svg>
                                <span class="ml-1 text-base font-bold">${formatNumber(post.reactions.likes)}</span>
                            </button>
                            <div class="relative inline-block">
                                <button class="reaction-btn reaction-shares text-2xl transform hover:scale-110 transition-transform duration-200 rounded-full bg-white/60 dark:bg-black/60 border border-red-300 shadow-md p-2 flex items-center share-btn" title="Re-glance" data-postidx="${postIdx}">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 sm:w-6 sm:h-6 md:w-7 md:h-7">
                                        <path stroke="currentColor" stroke-width="2" d="M4 12v7a1 1 0 001 1h14a1 1 0 001-1v-7" />
                                        <polyline points="16 6 12 2 8 6" stroke="currentColor" stroke-width="2" fill="none" />
                                        <line x1="12" y1="2" x2="12" y2="15" stroke="currentColor" stroke-width="2" />
                                    </svg>
                                    <span class="ml-1 text-base font-bold">${formatNumber(post.reactions.shares)}</span>
                                </button>
                                <div class="share-menu hidden absolute z-50 top-12 left-0 bg-white dark:bg-gray-900 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 p-2 flex flex-col min-w-[180px]">
                                    <button class="share-opt flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900" data-share="whatsapp"><span>üü¢</span> WhatsApp</button>
                                    <button class="share-opt flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900" data-share="tiktok"><span>üéµ</span> TikTok</button>
                                    <button class="share-opt flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900" data-share="instagram"><span>üì∏</span> Instagram</button>
                                    <button class="share-opt flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900" data-share="facebook"><span>üîµ</span> Facebook</button>
                                </div>
                            </div>
                            <!-- ...existing code... -->
                            <!-- Coment√°rio alinhado com as rea√ß√µes -->
                            <button class='comment-btn ml-0 text-2xl transform hover:scale-110 transition-transform duration-200 rounded-full bg-white/60 dark:bg-black/60 border border-red-300 shadow-md p-2 flex items-center' title='Ver coment√°rios' data-postidx='${postIdx}'>
                                <span style="font-size:1.7rem;">üó®Ô∏è</span>
                                <span class='ml-1 text-base font-bold'>${commentsArr.length}</span>
                            </button>
                        </div>
                        ${commentsHtml}
                    </div>
                `;
                // Clique no post abre em tela cheia
                postElement.onclick = function(e) {
                    // Se clicar na foto de perfil, abre o perfil do usu√°rio correto
                    if (e.target.closest('.feed-profile-avatar')) {
                        showPage('profile', post.user);
                        if (typeof updateProfilePage === 'function') updateProfilePage(post.user);
                        return;
                    }
                    // Evita abrir ao clicar em bot√µes internos ou na √°rea de coment√°rios
                    if (
                        e.target.closest('.reaction-btn') ||
                        e.target.closest('.comment-btn') ||
                        e.target.closest('.follow-btn') ||
                        e.target.closest('.comments-section') ||
                        e.target.closest('.comment-form') ||
                        e.target.classList.contains('comment-input') ||
                        e.target.classList.contains('send-comment-btn')
                    ) return;
                    // N√£o permite abrir texto em fullscreen
                    if (post.type === 'text') return;
                    // Se clicar no v√≠deo, abre em tela cheia
                    if (e.target.tagName && e.target.tagName.toLowerCase() === 'video') {
                        // Verifica se o v√≠deo est√° mutado
                        const videoEl = e.target;
                        if (!videoEl.muted && videoEl.volume > 0) {
                            if (typeof showMessageBox === 'function') {
                                showMessageBox('Desative o som do v√≠deo antes de abrir em tela cheia para evitar interfer√™ncia de √°udio.');
                            } else {
                                alert('Desative o som do v√≠deo antes de abrir em tela cheia para evitar interfer√™ncia de √°udio.');
                            }
                            return; // N√£o permite abrir
                        }
                        showFullPost(postIdx);
                        return;
                    }
                    showFullPost(postIdx);
                };
            // Autoplay/pause feed videos based on visibility
            setTimeout(() => {
                const videos = feedContainer.querySelectorAll('.feed-video');
                if ('IntersectionObserver' in window) {
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                entry.target.play();
                            } else {
                                entry.target.pause();
                            }
                        });
                    }, { threshold: 0.5 });
                    videos.forEach(v => { observer.observe(v); });
                } else {
                    // Fallback: play all
                    videos.forEach(v => v.play());
                }
            }, 100);
                feedContainer.appendChild(postElement);
            // Compartilhamento personalizado
            // Remove qualquer evento antigo do bot√£o de compartilhar (reaction-shares)
            const oldShareBtn = postElement.querySelector('.reaction-shares');
            if (oldShareBtn) {
                oldShareBtn.onclick = null;
                oldShareBtn.addEventListener('click', function(e) { e.preventDefault(); });
            }
            // Compartilhamento personalizado
            const shareBtn = postElement.querySelector('.share-btn');
            const shareMenu = postElement.querySelector('.share-menu');
            if (shareBtn && shareMenu) {
                // Remove qualquer evento antigo
                shareBtn.onclick = null;
                shareBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    // S√≥ permite se perfil estiver configurado
                    if (typeof isProfileConfigured === 'function' && !isProfileConfigured()) {
                        if (typeof showMessageBox === 'function') {
                            showMessageBox('Configure seu perfil (nome e bio) antes de compartilhar!');
                        }
                        shareMenu.classList.add('hidden');
                        return;
                    }
                    // Fecha outros menus
                    document.querySelectorAll('.share-menu').forEach(m => { if (m !== shareMenu) m.classList.add('hidden'); });
                    shareMenu.classList.toggle('hidden');
                });
                // Compartilhamento para redes
                shareMenu.querySelectorAll('.share-opt').forEach(opt => {
                    opt.onclick = null;
                    opt.addEventListener('click', function(ev) {
                        ev.stopPropagation();
                        const type = opt.getAttribute('data-share');
                        let url = '';
                        let videoUrl = post.media;
                        if (!/^https?:\/\//.test(videoUrl)) {
                            videoUrl = window.location.origin + '/' + videoUrl.replace(/^\//, '');
                        }
                        if (type === 'whatsapp') {
                            url = `https://wa.me/?text=${encodeURIComponent('Veja este v√≠deo: ' + videoUrl)}`;
                        } else if (type === 'tiktok') {
                            url = `https://www.tiktok.com/upload?url=${encodeURIComponent(videoUrl)}`;
                        } else if (type === 'instagram') {
                            url = `https://www.instagram.com/?url=${encodeURIComponent(videoUrl)}`;
                        } else if (type === 'facebook') {
                            url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(videoUrl)}`;
                        }
                        window.open(url, '_blank');
                        // Incrementa o contador de compartilhamento
                        post.reactions.shares++;
                        generateFeedContent();
                        shareMenu.classList.add('hidden');
                    });
                });
            }
            // Fecha menu ao clicar fora
            setTimeout(() => {
                document.addEventListener('click', function(e) {
                    document.querySelectorAll('.share-menu').forEach(menu => {
                        if (!menu.classList.contains('hidden') && !menu.contains(e.target) && !e.target.classList.contains('share-btn')) {
                            menu.classList.add('hidden');
                        }
                    });
                });
            }, 0);
            });
            // Delega√ß√£o para bot√µes de perfil e rea√ß√µes
            // Coment√°rios inline: adicionar evento para envio de coment√°rio
            feedContainer.querySelectorAll('.comment-form').forEach((form, i) => {
                const postIdx = parseInt(form.closest('.comments-section').getAttribute('data-postidx'));
                const input = form.querySelector('.comment-input');
                const btn = form.querySelector('.send-comment-btn');
                btn.onclick = (e) => {
                    e.preventDefault();
                    if (!window.loggedInUser) {
                        showMessageBox('Voc√™ precisa estar logado para comentar!');
                        return;
                    }
                    if (typeof isProfileConfigured === 'function' && !isProfileConfigured()) {
                        showMessageBox('Configure seu perfil para liberar os coment√°rios!');
                        return;
                    }
                    const text = input.value.trim();
                    if (text) {
                        if (!postComments[postIdx]) postComments[postIdx] = [];
                        postComments[postIdx].push({ user: window.loggedInUser, text });
                        input.value = '';
                        generateFeedContent();
                    }
                };
                // Enter envia coment√°rio
                input.onkeydown = function(ev) {
                    if (ev.key === 'Enter' && !ev.shiftKey) {
                        ev.preventDefault();
                        btn.click();
                    }
                };
            });

            // Evento para abrir modal de coment√°rios ao clicar no √≠cone
            feedContainer.querySelectorAll('.comment-btn').forEach(btn => {
            // Bot√£o de mensagens: abre modal de chat em tela cheia
            feedContainer.querySelectorAll('.message-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const authorUsername = btn.getAttribute('data-user');
                    if (!authorUsername || !users[authorUsername]) return;
                    const author = users[authorUsername];
                    let oldModal = document.getElementById('chat-modal');
                    if (oldModal) oldModal.remove();
                    const userA = users[window.loggedInUser]?.username || window.loggedInUser;
                    const userB = authorUsername;
                    const chatKey = 'chat_' + (userA < userB ? userA + '_' + userB : userB + '_' + userA);
                    const themeKey = 'chat_theme_' + (userA < userB ? userA + '_' + userB : userB + '_' + userA);
                    const modal = document.createElement('div');
                    modal.id = 'chat-modal';
                    modal.className = 'fixed inset-0 z-[1000] flex items-center justify-center bg-black/80 backdrop-blur-2xl';
                    modal.innerHTML = `
                        <div class='w-full h-full max-w-2xl bg-white dark:bg-gray-900 rounded-none md:rounded-2xl p-0 md:p-8 shadow-2xl flex flex-col items-center border-2 border-white/40 relative' id='chat-theme-container'>
                            <div class='flex items-center justify-between w-full p-4 border-b border-gray-200 dark:border-gray-700'>
                                <div class='flex items-center gap-3'>
                                    <img src='${author.avatar}' class='w-10 h-10 rounded-full border border-gray-300 dark:border-gray-700 object-cover' />
                                    <div>
                                        <div class='font-bold text-black dark:text-white'>${author.name}</div>
                                        <div class='text-xs text-gray-500 dark:text-gray-400'>@${author.username}</div>
                                    </div>
                                </div>
                                <button id='close-chat-modal' class='py-2 px-6 bg-blue-500 text-white rounded-full font-semibold'>Fechar</button>
                            </div>
                            <!-- Sele√ß√£o de tema do chat -->
                            <div class='w-full flex items-center justify-center gap-2 py-2 px-2 border-b border-gray-100 dark:border-gray-800 bg-white/60 dark:bg-gray-800/60'>
                                <span class='text-xs font-semibold text-gray-500 mr-2'>Tema:</span>
                                <button class='chat-theme-btn rounded-full w-7 h-7 border-2 border-blue-400' data-theme='default' style='background:linear-gradient(135deg,#fff,#e0e7ff);'></button>
                                <button class='chat-theme-btn rounded-full w-7 h-7 border-2 border-pink-400' data-theme='pink' style='background:linear-gradient(135deg,#ffe0f0,#ffb6d5);'></button>
                                <button class='chat-theme-btn rounded-full w-7 h-7 border-2 border-green-400' data-theme='green' style='background:linear-gradient(135deg,#e0ffe0,#b6ffd5);'></button>
                                <button class='chat-theme-btn rounded-full w-7 h-7 border-2 border-yellow-400' data-theme='yellow' style='background:linear-gradient(135deg,#fffde0,#fff6b6);'></button>
                                <button class='chat-theme-btn rounded-full w-7 h-7 border-2 border-purple-400' data-theme='purple' style='background:linear-gradient(135deg,#f0e0ff,#d5b6ff);'></button>
                            </div>
                            <div id='chat-messages' class='flex-1 w-full p-4 overflow-y-auto space-y-2'></div>
                            <form id='chat-form' class='w-full flex items-center p-4 border-t border-gray-200 dark:border-gray-700 gap-2' autocomplete='off' onsubmit='return false;'>
                                <button type='button' id='emoji-btn' class='text-2xl px-2 py-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800' title='Emojis'>üòä</button>
                                <button type='button' id='sticker-btn' class='text-2xl px-2 py-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800' title='Stickers'>üåü</button>
                                <button type='button' id='voice-btn' class='text-2xl px-2 py-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800' title='Mensagem de voz'>üé§</button>
                                <input type='text' id='chat-input' class='flex-1 p-2 rounded-xl border-2 border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200 mr-2' placeholder='Digite sua mensagem...'/>
                                <button type='submit' class='py-2 px-4 bg-blue-500 text-white rounded-xl font-semibold'>Enviar</button>
                            </form>
                            <div id='emoji-picker' class='hidden absolute bottom-24 left-8 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-xl shadow-lg p-2 flex flex-wrap gap-2 z-50' style='min-width:220px;'></div>
                            <div id='sticker-picker' class='hidden absolute bottom-24 left-32 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-xl shadow-lg p-2 flex flex-wrap gap-2 z-50' style='min-width:220px;'></div>
                            <div id='voice-recorder' class='hidden absolute bottom-24 left-56 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-xl shadow-lg p-4 flex flex-col items-center gap-2 z-50' style='min-width:220px;'>
                                <span class='font-semibold text-gray-700 dark:text-gray-200 mb-2'>Gravando...</span>
                                <button id='stop-voice-btn' class='py-2 px-6 bg-red-500 text-white rounded-full font-semibold'>Parar</button>
                            </div>
                        </div>
                    `;
                    // Voice message logic
                    const voiceBtn = modal.querySelector('#voice-btn');
                    const voiceRecorder = modal.querySelector('#voice-recorder');
                    let mediaRecorder = null;
                    let audioChunks = [];
                    let isRecording = false;
                    voiceBtn.onclick = async (e) => {
                        e.preventDefault();
                        if (isRecording) return;
                        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                            alert('Seu navegador n√£o suporta grava√ß√£o de √°udio.');
                            return;
                        }
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            mediaRecorder = new MediaRecorder(stream);
                            audioChunks = [];
                            mediaRecorder.ondataavailable = event => {
                                if (event.data.size > 0) audioChunks.push(event.data);
                            };
                            mediaRecorder.onstop = () => {
                                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                                const audioUrl = URL.createObjectURL(audioBlob);
                                chatMessages.push({ user: window.loggedInUser, audio: audioUrl, isVoice: true });
                                localStorage.setItem(chatKey, JSON.stringify(chatMessages));
                                renderMessages();
                                setTimeout(() => URL.revokeObjectURL(audioUrl), 60000); // libera mem√≥ria depois
                            };
                            mediaRecorder.start();
                            isRecording = true;
                            voiceRecorder.classList.remove('hidden');
                        } catch (err) {
                            alert('Erro ao acessar o microfone.');
                        }
                    };
                    modal.querySelector('#stop-voice-btn').onclick = (e) => {
                        e.preventDefault();
                        if (mediaRecorder && isRecording) {
                            mediaRecorder.stop();
                            isRecording = false;
                            voiceRecorder.classList.add('hidden');
                        }
                    };
                    document.body.appendChild(modal);
                    document.getElementById('close-chat-modal').onclick = () => modal.remove();
                    // Emoji e sticker picker
                    const emojiBtn = modal.querySelector('#emoji-btn');
                    const emojiPicker = modal.querySelector('#emoji-picker');
                    const stickerBtn = modal.querySelector('#sticker-btn');
                    const stickerPicker = modal.querySelector('#sticker-picker');
                    const chatInput = modal.querySelector('#chat-input');
                    // Lista de emojis e stickers
                    const emojis = ['üòÄ','üòÇ','üòç','üòé','üò≠','üò°','üëç','üôè','üéâ','üî•','üíØ','ü•≥','üòÖ','üòè','üò±','üòá','üòú','ü§©','üò¨','üò¥'];
                    const stickers = [
                        'üê±','üê∂','ü¶Ñ','üêº','üê∏','üêµ','ü¶ä','üêª','üêØ','üê∞','ü¶Å','üêÆ','üê∑','üêî','üêß','üê¢','üêô','ü¶ã','üêù','üêû',
                        'üçï','üçî','üçü','üç£','üç¶','üç©','üçø','üçâ','üçì','üçå','üçí','üçá','üçç','ü•ë','ü•ï','üåΩ','üçî','üç∞','üç´','üç≠'
                    ];
                    emojiBtn.onclick = (e) => {
                        e.preventDefault();
                        emojiPicker.innerHTML = emojis.map(e => `<button type='button' class='emoji-item text-2xl p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded'>${e}</button>`).join('');
                        emojiPicker.classList.toggle('hidden');
                        stickerPicker.classList.add('hidden');
                    };
                    stickerBtn.onclick = (e) => {
                        e.preventDefault();
                        stickerPicker.innerHTML = stickers.map(s => `<button type='button' class='sticker-item text-2xl p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded'>${s}</button>`).join('');
                        stickerPicker.classList.toggle('hidden');
                        emojiPicker.classList.add('hidden');
                    };
                    emojiPicker.onclick = (e) => {
                        if (e.target.classList.contains('emoji-item')) {
                            chatInput.value += e.target.textContent;
                            emojiPicker.classList.add('hidden');
                            chatInput.focus();
                        }
                    };
                    stickerPicker.onclick = (e) => {
                        if (e.target.classList.contains('sticker-item')) {
                            // Envia sticker como mensagem
                            chatMessages.push({ user: window.loggedInUser, text: e.target.textContent, isSticker: true });
                            localStorage.setItem(chatKey, JSON.stringify(chatMessages));
                            renderMessages();
                            stickerPicker.classList.add('hidden');
                            chatInput.focus();
                        }
                    };
                    // Fecha pickers ao clicar fora
                    document.addEventListener('click', function pickerClose(ev) {
                        if (!modal.contains(ev.target)) {
                            emojiPicker.classList.add('hidden');
                            stickerPicker.classList.add('hidden');
                            document.removeEventListener('click', pickerClose);
                        }
                    });
                    // L√≥gica de sele√ß√£o de tema do chat
                    const themeContainer = document.getElementById('chat-theme-container');
                    const themeBtns = modal.querySelectorAll('.chat-theme-btn');
                    let selectedTheme = localStorage.getItem(themeKey) || 'default';
                    function applyTheme(theme) {
                        if(theme === 'pink') themeContainer.style.background = 'linear-gradient(135deg,#ffe0f0,#ffb6d5)';
                        else if(theme === 'green') themeContainer.style.background = 'linear-gradient(135deg,#e0ffe0,#b6ffd5)';
                        else if(theme === 'yellow') themeContainer.style.background = 'linear-gradient(135deg,#fffde0,#fff6b6)';
                        else if(theme === 'purple') themeContainer.style.background = 'linear-gradient(135deg,#f0e0ff,#d5b6ff)';
                        else themeContainer.style.background = 'linear-gradient(135deg,#fff,#e0e7ff)';
                    }
                    applyTheme(selectedTheme);
                    themeBtns.forEach(btn => {
                        btn.onclick = function() {
                            selectedTheme = btn.getAttribute('data-theme');
                            localStorage.setItem(themeKey, selectedTheme);
                            applyTheme(selectedTheme);
                        };
                    });
                    // Mensagens simuladas (localStorage por chatKey)
                    let chatMessages = [];
                    try { chatMessages = JSON.parse(localStorage.getItem(chatKey) || '[]'); } catch { chatMessages = []; }
                    const chatMessagesDiv = document.getElementById('chat-messages');
                    function renderMessages() {
                        chatMessagesDiv.innerHTML = chatMessages.length === 0
                            ? `<div class='text-gray-500 text-center'>Nenhuma mensagem ainda.</div>`
                            : chatMessages.map((m, i) => {
                                // Mostra apenas os contadores de rea√ß√£o, n√£o os bot√µes
                                const reactions = m.reactions || {};
                                const reactionTypes = [
                                    { type: 'like', emoji: 'üëç' },
                                    { type: 'love', emoji: '‚ù§Ô∏è' },
                                    { type: 'laugh', emoji: 'üòÇ' },
                                    { type: 'wow', emoji: 'üòÆ' },
                                    { type: 'sad', emoji: 'üò¢' },
                                    { type: 'angry', emoji: 'üò°' }
                                ];
                                let countersHtml = '';
                                let totalReactions = 0;
                                reactionTypes.forEach(rt => {
                                    const count = reactions[rt.type]?.length || 0;
                                    if (count > 0) {
                                        countersHtml += `<span class='msg-reaction-counter' data-msgidx='${i}' data-reaction='${rt.type}' style='font-size:1.1em;margin-left:2px;user-select:none;'>${rt.emoji}<span class='text-xs font-bold ml-0.5'>${count}</span></span>`;
                                        totalReactions += count;
                                    }
                                });
                                // Mensagem clic√°vel para abrir rea√ß√µes
                                let msgClass = m.user === window.loggedInUser ? 'text-right' : 'text-left';
                                let msgContent = '';
                                if (m.isVoice && m.audio) {
                                    msgContent = `<audio controls src='${m.audio}' class='inline-block my-1' style='max-width:180px;vertical-align:middle;'></audio>`;
                                } else if (m.isSticker) {
                                    msgContent = `<span class='inline-block px-3 py-2 rounded-xl bg-white dark:bg-gray-800 text-3xl'>${m.text}</span>`;
                                } else {
                                    msgContent = `<span class='inline-block px-3 py-2 rounded-xl ${m.user === window.loggedInUser ? 'bg-blue-500 text-white' : 'bg-gray-200 dark:bg-gray-800 text-black dark:text-white'}'>${m.user === window.loggedInUser ? 'Voc√™' : author.name}: ${m.text}</span>`;
                                }
                                return `<div class='chat-msg-row ${msgClass}' data-msgidx='${i}' style='position:relative;cursor:pointer;'>${msgContent}${countersHtml ? `<span class='ml-2 align-middle'>${countersHtml}</span>` : ''}<div class='msg-reaction-popup hidden absolute z-50 left-1/2 -translate-x-1/2 top-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-xl shadow-lg p-1 flex gap-1'></div></div>`;
                            }).join('');
                        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
                        // Evento: ao clicar na mensagem, mostra popup de rea√ß√µes
                        chatMessagesDiv.querySelectorAll('.chat-msg-row').forEach(row => {
                            row.onclick = function(ev) {
                                // Evita abrir m√∫ltiplos popups
                                chatMessagesDiv.querySelectorAll('.msg-reaction-popup').forEach(p => p.classList.add('hidden'));
                                const popup = row.querySelector('.msg-reaction-popup');
                                if (!popup) return;
                                // Preenche popup com bot√µes de rea√ß√£o
                                const msgIdx = parseInt(row.getAttribute('data-msgidx'));
                                const m = chatMessages[msgIdx];
                                const reactions = m.reactions || {};
                                const reactionTypes = [
                                    { type: 'like', emoji: 'üëç' },
                                    { type: 'love', emoji: '‚ù§Ô∏è' },
                                    { type: 'laugh', emoji: 'üòÇ' },
                                    { type: 'wow', emoji: 'üòÆ' },
                                    { type: 'sad', emoji: 'üò¢' },
                                    { type: 'angry', emoji: 'üò°' }
                                ];
                                popup.innerHTML = reactionTypes.map(rt => {
                                    const reacted = reactions[rt.type]?.includes(window.loggedInUser);
                                    return `<button class='msg-reaction-btn' data-msgidx='${msgIdx}' data-reaction='${rt.type}' style='background:none;border:none;cursor:pointer;outline:none;font-size:1.5em;${reacted ? 'filter:brightness(1.5);' : ''}' title='${rt.type}'>${rt.emoji}</button>`;
                                }).join('');
                                popup.classList.remove('hidden');
                                // Fecha popup ao clicar fora
                                setTimeout(() => {
                                    function closePopup(ev2) {
                                        if (!row.contains(ev2.target)) {
                                            popup.classList.add('hidden');
                                            document.removeEventListener('click', closePopup);
                                        }
                                    }
                                    document.addEventListener('click', closePopup);
                                }, 10);
                            };
                        });
                        // Evento: ao clicar em um emoji do popup, reage e fecha popup
                        chatMessagesDiv.querySelectorAll('.msg-reaction-popup').forEach(popup => {
                            popup.onclick = function(ev) {
                                if (ev.target.classList.contains('msg-reaction-btn')) {
                                    const btn = ev.target;
                                    const msgIdx = parseInt(btn.getAttribute('data-msgidx'));
                                    const reaction = btn.getAttribute('data-reaction');
                                    if (isNaN(msgIdx) || !reaction) return;
                                    if (!chatMessages[msgIdx].reactions) chatMessages[msgIdx].reactions = {};
                                    if (!chatMessages[msgIdx].reactions[reaction]) chatMessages[msgIdx].reactions[reaction] = [];
                                    const arr = chatMessages[msgIdx].reactions[reaction];
                                    const userIdx = arr.indexOf(window.loggedInUser);
                                    if (userIdx === -1) {
                                        arr.push(window.loggedInUser);
                                    } else {
                                        arr.splice(userIdx, 1);
                                    }
                                    localStorage.setItem(chatKey, JSON.stringify(chatMessages));
                                    renderMessages();
                                }
                                // Sempre fecha popup ao clicar em qualquer emoji
                                popup.classList.add('hidden');
                                ev.stopPropagation();
                            };
                        });
                    }
                    renderMessages();
                    document.getElementById('chat-form').onsubmit = function(ev) {
                        ev.preventDefault();
                        const input = document.getElementById('chat-input');
                        const text = input.value.trim();
                        if (text) {
                            chatMessages.push({ user: window.loggedInUser, text });
                            localStorage.setItem(chatKey, JSON.stringify(chatMessages));
                            input.value = '';
                            renderMessages();
                        }
                    };
                };
            });
                btn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const postIdx = parseInt(btn.getAttribute('data-postidx'));
                    let oldModal = document.getElementById('comments-modal');
                    if (oldModal) oldModal.remove();
                    const modal = document.createElement('div');
                    modal.id = 'comments-modal';
                    modal.className = 'fixed inset-0 z-[999] flex items-center justify-center bg-black/60 backdrop-blur-md';
                    const commentsArr = postComments[postIdx] || [];
                    modal.innerHTML = `
                        <div class='w-full max-w-md bg-white dark:bg-gray-900 rounded-2xl p-8 space-y-4 shadow-2xl flex flex-col items-center border-2 border-white/40'>
                            <h2 class='text-xl font-bold mb-2 text-center text-black dark:text-white'>Coment√°rios</h2>
                            <div class='w-full max-h-[60vh] overflow-y-auto space-y-2'>
                                ${commentsArr.length === 0 ? `<div class='text-gray-500 text-center'>Nenhum coment√°rio ainda.</div>` : commentsArr.map(c => `<div class='bg-white/80 dark:bg-black/80 rounded-xl px-3 py-2 text-sm text-black dark:text-white'><b>${c.user}:</b> ${c.text}</div>`).join('')}
                            </div>
                            <button id='close-comments-modal' class='mt-4 py-2 px-6 bg-blue-500 text-white rounded-full font-semibold'>Fechar</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    document.getElementById('close-comments-modal').onclick = () => modal.remove();
                };
            });
            feedContainer.querySelectorAll('[data-profile]').forEach(el => {
                // Remove o handler duplicado para evitar conflito
                el.onclick = null;
            });
            // Rea√ß√µes: Olhei, Amei, Re-glance
            feedContainer.querySelectorAll('.reaction-views').forEach((btn, i) => {
                btn.onclick = () => {
                    const user = window.loggedInUser;
                    // Usa a fun√ß√£o de verifica√ß√£o j√° existente para consist√™ncia
                    if (typeof isProfileConfigured === 'function' && !isProfileConfigured()) {
                        showMessageBox('Configure seu perfil para liberar as rea√ß√µes!');
                        return;
                    }
                    const postIdx = reversedPosts.length - 1 - i;
                    if (!userViews[user]) userViews[user] = {};
                    if (userViews[user][postIdx]) {
                        posts[postIdx].reactions.views--;
                        userViews[user][postIdx] = false;
                    } else {
                        posts[postIdx].reactions.views++;
                        userViews[user][postIdx] = true;
                    }
                    generateFeedContent();
                };
            });
            feedContainer.querySelectorAll('.reaction-likes').forEach((btn, i) => {
                btn.onclick = () => {
                    const user = window.loggedInUser;
                    if (typeof isProfileConfigured === 'function' && !isProfileConfigured()) {
                        showMessageBox('Configure seu perfil para liberar as rea√ß√µes!');
                        return;
                    }
                    const postIdx = reversedPosts.length - 1 - i;
                    if (!userLikes[postIdx]) {
                        posts[postIdx].reactions.likes++;
                        userLikes[postIdx] = true;
                    } else {
                        posts[postIdx].reactions.likes--;
                        userLikes[postIdx] = false;
                    }
                    generateFeedContent();
                };
            });
            feedContainer.querySelectorAll('.reaction-shares').forEach((btn, i) => {
                // N√£o faz nada! O compartilhamento √© tratado pelo menu customizado.
                btn.onclick = function(e) { e.preventDefault(); };
            });
            // Coment√°rio: n√£o abre mais modal, ser√° inline
            // Bot√£o de seguir
            feedContainer.querySelectorAll('.follow-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const username = btn.closest('[data-profile]')?.getAttribute('data-profile');
                    if (!username) return;
                    let following = JSON.parse(localStorage.getItem('following') || '{}');
                    let isFollowing = following[username] === true;
                    if (isFollowing) {
                        btn.textContent = 'Seguir';
                        btn.classList.remove('bg-green-500');
                        btn.classList.add('bg-blue-500');
                        following[username] = false;
                        users[username].followers = Math.max(0, (users[username].followers || 0) - 1);
                    } else {
                        btn.textContent = 'Seguindo';
                        btn.classList.remove('bg-blue-500');
                        btn.classList.add('bg-green-500');
                        following[username] = true;
                        users[username].followers = (users[username].followers || 0) + 1;
                    }
                    localStorage.setItem('following', JSON.stringify(following));
                    // Atualiza n√∫mero de seguidores no perfil se estiver aberto
                    if (document.getElementById('profile-username') && document.getElementById('profile-username').textContent === '@'+username) {
                        document.getElementById('profile-followers-count').textContent = users[username].followers;
                        // Atualiza bot√£o do perfil
                        if (typeof updateProfilePage === 'function') updateProfilePage(username);
                    }
                    // Atualiza todos os bot√µes do feed
                    if (typeof generateFeedContent === 'function') generateFeedContent();
                };
            });
            // Atualiza o texto e cor do bot√£o de seguir do feed conforme o estado salvo
            feedContainer.querySelectorAll('.follow-btn').forEach(btn => {
                const username = btn.closest('[data-profile]')?.getAttribute('data-profile');
                if (!username) return;
                let following = JSON.parse(localStorage.getItem('following') || '{}');
                let isFollowing = following[username] === true;
                btn.textContent = isFollowing ? 'Seguindo' : 'Seguir';
                btn.classList.remove('bg-blue-500', 'bg-green-500');
                btn.classList.add(isFollowing ? 'bg-green-500' : 'bg-blue-500');
            });
            // Bot√£o de comentar
            // (Removido: sobrescrita do evento de comentar)
        }
        // Upload de glance (imagem, v√≠deo, √°udio, texto) pelo bot√£o +
        window.onload = () => {
            // Conta as publica√ß√µes por usu√°rio
            for (const user in users) {
                users[user].posts = posts.filter(post => post.user === user).length;
            }
            generateFeedContent();
            updateProfilePage(window.loggedInUser);

            // Inicializa√ß√£o do upload
            const createPage = document.querySelector('[data-page="create"]');
            if (createPage) {
                // Cria input de upload se n√£o existir
                let glanceUpload = document.getElementById('glance-upload');
                if (!glanceUpload) {
                    glanceUpload = document.createElement('input');
                    glanceUpload.type = 'file';
                    glanceUpload.accept = 'image/*,video/*,audio/*,.txt';
                    glanceUpload.id = 'glance-upload';
                    glanceUpload.className = 'hidden';
                    createPage.appendChild(glanceUpload);
                }
                // Cria modal de descri√ß√£o se n√£o existir
                let glanceDescModal = document.getElementById('glance-desc-modal');
                if (!glanceDescModal) {
                    glanceDescModal = document.createElement('div');
                    glanceDescModal.id = 'glance-desc-modal';
                    glanceDescModal.className = 'hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80';
                    glanceDescModal.innerHTML = `
                        <div class="w-full max-w-md bg-white dark:bg-gray-900 rounded-2xl p-8 space-y-6 shadow-2xl flex flex-col items-center">
                            <h2 class="text-xl font-bold mb-2 text-center text-black dark:text-white">Nova Publica√ß√£o</h2>
                            <div id="glance-preview-container" class="w-full flex flex-col items-center mb-4"></div>
                            <textarea id="glance-desc-input" placeholder="Escreva uma descri√ß√£o..." rows="3" class="w-full p-3 rounded-xl border-2 border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200 mb-2"></textarea>
                            <div class="flex w-full space-x-2">
                                <button id="glance-cancel-btn" class="flex-1 py-3 bg-gray-300 dark:bg-gray-700 text-black dark:text-white font-semibold rounded-2xl">Cancelar</button>
                                <button id="glance-publish-btn" class="flex-1 py-3 bg-blue-500 text-white font-semibold rounded-2xl">Publicar</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(glanceDescModal);
                }
                // Bot√£o + faz upload
                const plusBtn = document.getElementById('glance-plus-btn');
                if (plusBtn) {
                    plusBtn.onclick = () => {
                        if (!isProfileConfigured()) {
                            showMessageBox('Configure seu perfil (nome e bio) antes de publicar!');
                            return;
                        }
                        glanceUpload.value = '';
                        const previewContainer = document.getElementById('glance-preview-container');
                        if (previewContainer) previewContainer.innerHTML = '';
                        document.getElementById('glance-desc-input').value = '';
                        glanceUpload.click();
                    };
                }
                let uploadedFileData = null;
                let uploadedFileType = null;
                let uploadedTextContent = null;
                glanceUpload.onchange = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const previewContainer = document.getElementById('glance-preview-container');
                        previewContainer.innerHTML = '';
                        uploadedFileType = null;
                        uploadedFileData = null;
                        uploadedTextContent = null;
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                uploadedFileData = e.target.result;
                                uploadedFileType = 'image';
                                previewContainer.innerHTML = `<img src="${uploadedFileData}" class="w-full max-w-xs rounded-xl mb-2" />`;
                                glanceDescModal.classList.remove('hidden');
                            };
                            reader.readAsDataURL(file);
                        } else if (file.type.startsWith('video/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                uploadedFileData = e.target.result;
                                uploadedFileType = 'video';
                                previewContainer.innerHTML = `<video src="${uploadedFileData}" controls class="w-full max-w-xs rounded-xl mb-2"></video>`;
                                glanceDescModal.classList.remove('hidden');
                            };
                            reader.readAsDataURL(file);
                        } else if (file.type.startsWith('audio/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                uploadedFileData = e.target.result;
                                uploadedFileType = 'audio';
                                previewContainer.innerHTML = `<audio src="${uploadedFileData}" controls class="w-full max-w-xs mb-2"></audio>`;
                                glanceDescModal.classList.remove('hidden');
                            };
                            reader.readAsDataURL(file);
                        } else if (file.name.endsWith('.txt')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                uploadedTextContent = e.target.result;
                                uploadedFileType = 'text';
                                previewContainer.innerHTML = `<div class='w-full max-w-xs rounded-xl mb-2 bg-gray-200 dark:bg-gray-800 p-4'><pre class='whitespace-pre-wrap break-words'>${uploadedTextContent}</pre></div>`;
                                glanceDescModal.classList.remove('hidden');
                            };
                            reader.readAsText(file);
                        } else {
                            previewContainer.innerHTML = `<div class='text-red-500'>Tipo de arquivo n√£o suportado.</div>`;
                            glanceDescModal.classList.remove('hidden');
                        }
                    }
                };
                document.getElementById('glance-cancel-btn').onclick = () => {
                    glanceDescModal.classList.add('hidden');
                    uploadedFileData = null;
                    uploadedFileType = null;
                    uploadedTextContent = null;
                };
                document.getElementById('glance-publish-btn').onclick = () => {
                    const desc = document.getElementById('glance-desc-input').value.trim() || '';
                    if (uploadedFileType === 'image' && uploadedFileData) {
                        posts.push({
                            user: window.loggedInUser,
                            type: 'image',
                            media: uploadedFileData,
                            text: desc,
                            reactions: { views: 0, likes: 0, shares: 0 }
                        });
                    } else if (uploadedFileType === 'video' && uploadedFileData) {
                        posts.push({
                            user: window.loggedInUser,
                            type: 'video',
                            media: uploadedFileData,
                            text: desc,
                            reactions: { views: 0, likes: 0, shares: 0 }
                        });
                    } else if (uploadedFileType === 'audio' && uploadedFileData) {
                        posts.push({
                            user: window.loggedInUser,
                            type: 'audio',
                            media: uploadedFileData,
                            text: desc,
                            reactions: { views: 0, likes: 0, shares: 0 }
                        });
                    } else if (uploadedFileType === 'text' && uploadedTextContent) {
                        posts.push({
                            user: window.loggedInUser,
                            type: 'text',
                            media: null,
                            text: uploadedTextContent,
                            reactions: { views: 0, likes: 0, shares: 0 }
                        });
                    }
                    generateFeedContent();
                    updateProfilePage(window.loggedInUser);
                    showPage('feed');
                    glanceDescModal.classList.add('hidden');
                    uploadedFileData = null;
                    uploadedFileType = null;
                    uploadedTextContent = null;
                };
            }
        };

        // L√≥gica do Onboarding
        let currentOnboardPage = 1;
        const onboardSlides = document.querySelectorAll('.onboard-slide');
        const onboardNextBtn = document.getElementById('onboard-next');

        function showOnboardPage(pageNumber) {
            onboardSlides.forEach(slide => {
                slide.classList.remove('opacity-100');
                slide.classList.add('opacity-0');
            });
            const currentPage = document.querySelector(`[data-onboard-page="${pageNumber}"]`);
            if (currentPage) {
                currentPage.classList.remove('opacity-0');
                currentPage.classList.add('opacity-100');
            }
        }

        if (onboardNextBtn) {
            onboardNextBtn.addEventListener('click', () => {
                if (currentOnboardPage < onboardSlides.length) {
                    currentOnboardPage++;
                    showOnboardPage(currentOnboardPage);
                } else {
                    showPage('onboarding-final', loggedInUser, 'slide-in');
                }
            });
        }
        
        // Anima√ß√£o de bounce nos √≠cones de navega√ß√£o
        const navBtns = document.querySelectorAll('.nav-btn');
        navBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.add('bounce-icon');
                setTimeout(() => btn.classList.remove('bounce-icon'), 300);
            });
        });

        // Anima√ß√£o de rea√ß√µes nos posts
        function reactToGlance(button) {
            if (!isProfileConfigured()) {
                showMessageBox('Configure seu perfil (nome e bio) antes de reagir!');
                return;
            }
            button.classList.add('bounce-icon');
            setTimeout(() => {
                button.classList.remove('bounce-icon');
            }, 300);
        }

        // L√≥gica dos bot√µes de interesse
        document.querySelectorAll('.interest-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('bg-black');
                btn.classList.toggle('text-white');
                btn.classList.toggle('dark:bg-white');
                btn.classList.toggle('dark:text-black');
            });
        });

        // L√≥gica de edi√ß√£o de perfil
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const editProfileForm = document.getElementById('edit-profile-form');
        const profileUsername = document.getElementById('profile-username');
        const profileBio = document.getElementById('profile-bio');
        const editUsername = document = document.getElementById('edit-username');
        const editBio = document.getElementById('edit-bio');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const fileUpload = document.getElementById('file-upload');
        const profileAvatar = document.getElementById('profile-avatar');

        if (editProfileBtn) {
            editProfileBtn.onclick = () => {
                // Preenche os campos com os dados atuais
                editUsername.value = profileUsername.textContent.substring(1); // Remove o @
                editBio.value = profileBio.textContent;
                document.getElementById('edit-birthdate').value = users[window.loggedInUser].birthdate || '';
                document.getElementById('edit-location').value = users[window.loggedInUser].location || '';
                document.getElementById('edit-gender').value = users[window.loggedInUser].gender || '';
                document.getElementById('edit-interests').value = users[window.loggedInUser].interests || '';
                // Exibe o formul√°rio em tela cheia
                editProfileForm.classList.remove('hidden');
            };
        }

        if (saveProfileBtn) {
            saveProfileBtn.onclick = () => {
                const oldUsername = users[loggedInUser].username;
                const newUsername = editUsername.value.trim();
                const newBio = editBio.value;
                const newBirthdate = document.getElementById('edit-birthdate').value;
                const newLocation = document.getElementById('edit-location').value;
                const newGender = document.getElementById('edit-gender').value;
                const newInterests = document.getElementById('edit-interests').value;
                // Atualiza foto de perfil se selecionada
                const avatarInput = document.getElementById('edit-avatar');
                if (avatarInput && avatarInput.files && avatarInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        users[loggedInUser].avatar = e.target.result;
                        document.getElementById('profile-avatar').src = e.target.result;
                        document.getElementById('profile-avatar-full').src = e.target.result;
                    };
                    reader.readAsDataURL(avatarInput.files[0]);
                }
                profileUsername.textContent = '@' + newUsername;
                profileBio.textContent = newBio;
                // Atualiza dados do objeto users
                if (users[loggedInUser]) {
                    users[loggedInUser].username = newUsername;
                    users[loggedInUser].bio = newBio;
                    users[loggedInUser].birthdate = newBirthdate;
                    users[loggedInUser].location = newLocation;
                    users[loggedInUser].gender = newGender;
                    users[loggedInUser].interests = newInterests;
                }
                // Se o nome de usu√°rio mudou, atualiza a chave do objeto users e posts
                if (oldUsername !== newUsername && newUsername !== "") {
                    users[newUsername] = {...users[loggedInUser]};
                    delete users[loggedInUser];
                    posts.forEach(post => {
                        if (post.user === loggedInUser) {
                            post.user = newUsername;
                        }
                    });
                    window.loggedInUser = newUsername;
                }
                editProfileForm.classList.add('hidden');
                updateProfilePage(window.loggedInUser);
                generateFeedContent();
            };
        }

        if (fileUpload) {
            fileUpload.onchange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        profileAvatar.src = e.target.result;
                        document.getElementById('profile-avatar-full').src = e.target.result;
                        // Anima√ß√£o ao atualizar
                        profileAvatar.classList.add('bounce-icon');
                        setTimeout(() => profileAvatar.classList.remove('bounce-icon'), 300);
                    };
                    reader.readAsDataURL(file);
                }
            };
        }

        // Inicializa a p√°gina e conta as publica√ß√µes por usu√°rio
        window.onload = () => {
            // Conta as publica√ß√µes por usu√°rio
            for (const user in users) {
                users[user].posts = posts.filter(post => post.user === user).length;
            }
            // Zera as contagens do perfil logado
            if (users[window.loggedInUser]) {
                users[window.loggedInUser].posts = 0;
                users[window.loggedInUser].followers = 0;
                users[window.loggedInUser].following = 0;
            }
            generateFeedContent();
            updateProfilePage(window.loggedInUser);
            // Ao iniciar, esconde a barra de navega√ß√£o
            navBar.style.display = 'none';
            // Exibir imagem de perfil em tela cheia ao clicar
            const avatar = document.getElementById('profile-avatar');
            const overlay = document.getElementById('profile-avatar-overlay');
            const avatarFull = document.getElementById('profile-avatar-full');
            if (avatar && overlay && avatarFull) {
                avatar.onclick = () => {
                    avatarFull.src = avatar.src;
                    overlay.classList.remove('hidden');
                };
                overlay.onclick = () => {
                    overlay.classList.add('hidden');
                };
            }
        };
    </script>
</body>
<script>
// Placeholder do feed s√≥ aparece se n√£o houver posts
document.addEventListener('DOMContentLoaded', function() {
    function showFeedPlaceholderIfEmpty() {
        const feedContainer = document.getElementById('feed-scroll-container');
        if (!feedContainer) return;
        // Remove placeholder antigo
        const old = document.getElementById('feed-placeholder');
        if (old) old.remove();
        // Verifica se h√° posts
        const posts = feedContainer.querySelectorAll('.post, .publicacao, .feed-post');
        if (posts.length === 0) {
            const div = document.createElement('div');
            div.id = 'feed-placeholder';
            div.className = 'text-center text-gray-500 mt-10';
            div.innerHTML = 'üöÄ Seu feed est√° vazio.<br>Siga pessoas ou publique algo para come√ßar.';
            feedContainer.appendChild(div);
        }
    }
    // Chama ao carregar e sempre que atualizar o feed
    showFeedPlaceholderIfEmpty();
    // Se houver fun√ß√£o de renderiza√ß√£o do feed, conecte aqui:
    if (window.renderFeed) {
        const oldRenderFeed = window.renderFeed;
        window.renderFeed = function() {
            oldRenderFeed.apply(this, arguments);
            showFeedPlaceholderIfEmpty();
        };
    }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const slides = document.querySelectorAll('[data-onboard-page]');
    const nextBtn = document.getElementById('onboard-next');
    let current = 1;

    if (nextBtn) {
        nextBtn.onclick = function() {
            // esconde o slide atual
            const active = document.querySelector(`[data-onboard-page="${current}"]`);
            if (active) active.style.opacity = 0;

            current++;
            if (current <= slides.length) {
                const nextSlide = document.querySelector(`[data-onboard-page="${current}"]`);
                if (nextSlide) nextSlide.style.opacity = 1;
            } else {
                showPage('onboarding-final');
            }
        };
    }

    const finalBtn = document.getElementById('onboarding-final-btn');
    if (finalBtn) {
        finalBtn.onclick = function() {
            showPage('feed');
        };
    }
});
</script>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script>
    // Firebase config fornecido pelo usu√°rio
    const firebaseConfig = {
        apiKey: "AIzaSyBxHaqFiI7ywn6oGglgpwdHFIX5SQl1P3M",
        authDomain: "moneynap-8147b.firebaseapp.com",
        projectId: "moneynap-8147b",
        storageBucket: "moneynap-8147b.firebasestorage.app",
        messagingSenderId: "651518519582",
        appId: "1:651518519582:web:a1221a9a6e2faec88cc10f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- AUTENTICA√á√ÉO FIREBASE --- //
    // Troca de telas SPA
    function showPage(page) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelector(`[data-page="${page}"]`).classList.add('active');
    }

    // Cadastro
    const signupForm = document.getElementById('signup-form');
    if (signupForm) {
        signupForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = signupForm.querySelector('input[type="email"]').value;
            const senha = signupForm.querySelector('input[type="password"]').value;
            const submitBtn = signupForm.querySelector('button[type="submit"]');
            try {
                const cred = await firebase.auth().createUserWithEmailAndPassword(email, senha);
                if (cred && cred.user) {
                    showPage('onboarding');
                }
            } catch (err) {
                if (err.code === 'auth/email-already-in-use') {
                    alert('Este e-mail j√° est√° em uso. Use outro ou fa√ßa login.');
                    if (submitBtn) submitBtn.disabled = true;
                    signupForm.reset();
                    showPage('login');
                    return false;
                } else {
                    alert('Erro ao cadastrar: ' + (err.message || err));
                    return false;
                }
            }
        });
    }

    // Login
    const loginBtn = document.getElementById('login-btn');
    if (loginBtn) {
        loginBtn.addEventListener('click', async function() {
            const loginForm = loginBtn.closest('.page');
            const email = loginForm.querySelector('input[type="email"]').value;
            const senha = loginForm.querySelector('input[type="password"]').value;
            try {
                await firebase.auth().signInWithEmailAndPassword(email, senha);
                showPage('feed');
            } catch (err) {
                alert('Erro ao entrar: ' + (err.message || err));
            }
        });
    }

    // Manter usu√°rio logado
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            showPage('feed');
        } else {
            showPage('login');
        }
    });
</script>
<script>
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('comment-input')) {
        const form = e.target.closest('form');
        if (!form) return;
        const sendBtn = form.querySelector('.send-comment-btn');
        if (sendBtn) {
            if (e.target.value.trim().length > 0) {
                sendBtn.style.display = 'inline-flex';
            } else {
                sendBtn.style.display = 'none';
            }
        }
    }
});
</script>
    <!-- Modal de Mensagens (fora do feed-scroll-container) -->
    <div id="messages-modal" class="fixed inset-0 z-[9999] hidden items-start justify-center bg-black/60 backdrop-blur-sm">
        <div class="w-full max-w-md bg-white dark:bg-gray-900 rounded-2xl shadow-2xl mt-10 flex flex-col mx-auto">
            <div class="flex items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <input id="messages-search" type="text" placeholder="Pesquisar pessoas..." class="flex-1 p-3 rounded-xl border-2 border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200" />
                <button id="close-messages-modal" class="ml-2 text-gray-600 dark:text-gray-300 hover:text-red-500 text-2xl font-bold">&times;</button>
            </div>
            <div id="messages-search-results" class="p-4 max-h-96 overflow-y-auto"></div>
        </div>
    </div>
    <script>
    function setupMessagesModal() {
        const msgBtn = document.getElementById('feed-messages-btn');
        const modal = document.getElementById('messages-modal');
        const closeModal = document.getElementById('close-messages-modal');
        const searchInput = document.getElementById('messages-search');
        const resultsDiv = document.getElementById('messages-search-results');
        // Exemplo de lista de pessoas (substitua por sua l√≥gica real)
        const people = (window.users ? Object.values(window.users) : []).map(u => u.name || u.username || '').filter(Boolean);
        if(msgBtn && modal && closeModal && searchInput && resultsDiv) {
            msgBtn.onclick = function() {
                modal.classList.remove('hidden');
                searchInput.value = '';
                resultsDiv.innerHTML = '';
                searchInput.focus();
            };
            closeModal.onclick = function() {
                modal.classList.add('hidden');
            };
            searchInput.oninput = function() {
                const q = searchInput.value.trim().toLowerCase();
                resultsDiv.innerHTML = '';
                if(q.length > 0) {
                    const found = people.filter(p => p.toLowerCase().includes(q));
                    if(found.length) {
                        found.forEach(name => {
                            const btn = document.createElement('button');
                            btn.className = 'block w-full text-left py-2 px-4 rounded hover:bg-blue-100 dark:hover:bg-gray-800';
                            btn.textContent = name;
                            btn.onclick = () => alert('Iniciar conversa com ' + name);
                            resultsDiv.appendChild(btn);
                        });
                    } else {
                        resultsDiv.innerHTML = '<div class="text-gray-500">Nenhum nome encontrado.</div>';
                    }
                }
            };
        }
    }
    document.addEventListener('DOMContentLoaded', setupMessagesModal);
    // Se usar navega√ß√£o SPA, reative ao trocar de p√°gina:
    if(window.showPage) {
        const oldShowPage = window.showPage;
        window.showPage = function(page) {
            if (oldShowPage) oldShowPage.apply(this, arguments);
            setTimeout(setupMessagesModal, 100);
        };
    }
    </script>
</html>